<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<meta name="description" content="Presentation de Symfony">
<meta name="author" content="Section BTS SIO SLAM (LDV Melun)">
<title>Symfony Introduction</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Symfony Introduction</h1>
<div class="details">
<span id="author" class="author">Section BTS SIO SLAM (LDV Melun)</span><br>
<span id="revnumber">version 1.1,</span>
<span id="revdate">2019-08-30</span>
<br><span id="revremark">Version asciidoc</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table des matieres</div>
<ul class="sectlevel1">
<li><a href="#présentation">Présentation</a></li>
<li><a href="#modèle-d-architecture-applicative">Modèle d&#8217;architecture applicative</a>
<ul class="sectlevel2">
<li><a href="#prérequis">Prérequis</a></li>
<li><a href="#vérification-de-pré-requis-technique">Vérification de pré-requis technique</a></li>
<li><a href="#création-d-une-application-symfony">Création d&#8217;une application symfony</a></li>
<li><a href="#démarrage-du-serveur-et-de-l-application">Démarrage du serveur et de l&#8217;application</a></li>
<li><a href="#partir-d-un-projet-existant-disponible-sur-un-dépôt-git">Partir d&#8217;un projet existant disponible sur un dépôt git</a></li>
<li><a href="#résumé">Résumé</a></li>
<li><a href="#tp-installation-de-symfony-demo-application">TP Installation de Symfony Demo application</a></li>
</ul>
</li>
<li><a href="#première-interaction-notion-de-vue-contrôleur">Première interaction : notion de Vue/Contrôleur</a>
<ul class="sectlevel2">
<li><a href="#le-rendu-em-render-em-par-une-logique-de-vue-archtecture-mvc">Le rendu (<em>render</em>) par une logique de vue (archtecture MVC)</a></li>
<li><a href="#modèle-de-présentation-em-template-em-de-l-application">Modèle de Présentation (<em>template</em>) de l&#8217;application</a></li>
<li><a href="#résumé-2">Résumé</a></li>
<li><a href="#tp-tester-le-code-exemple-em-lucky-em">TP tester le code exemple <em>Lucky</em></a></li>
</ul>
</li>
<li><a href="#gestion-des-données-d-entrée">Gestion des données d&#8217;entrée</a>
<ul class="sectlevel2">
<li><a href="#auto-injection-de-l-objet-request">Auto-injection de l&#8217;objet Request</a></li>
<li><a href="#données-implicites">Données implicites</a></li>
<li><a href="#données-explicites">Données explicites</a></li>
<li><a href="#tp-le-contrôleur-et-la-vue-initiation">TP - Le contrôleur et la vue (initiation)</a></li>
</ul>
</li>
<li><a href="#introduction-au-model">Introduction au Model</a>
<ul class="sectlevel2">
<li><a href="#Éléments-d-architecture">Éléments d&#8217;architecture</a></li>
<li><a href="#premiers-pas-avec-le-model">Premiers pas avec le model</a></li>
<li><a href="#travaux-pratiques">Travaux Pratiques</a></li>
</ul>
</li>
<li><a href="#cas-du-formulaire">Cas du formulaire</a>
<ul class="sectlevel2">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#logique-de-traitement-du-formulaire">Logique de traitement du formulaire</a></li>
<li><a href="#logique-métier-du-formulaire">Logique métier du formulaire</a></li>
<li><a href="#rendu-du-formulaire">Rendu du formulaire</a></li>
<li><a href="#bonnes-pratiques-et-vidéo-exemples">Bonnes pratiques et vidéo exemples</a></li>
<li><a href="#travaux-pratiques-2">Travaux pratiques</a></li>
</ul>
</li>
<li><a href="#securite">Securite</a>
<ul class="sectlevel2">
<li><a href="#introduction-2">Introduction</a></li>
<li><a href="#api-de-sécurité-de-symfony">API de sécurité de symfony</a></li>
<li><a href="#travaux-pratiques-3">Travaux pratiques</a></li>
</ul>
</li>
<li><a href="#liaison-entre-entités">Liaison entre Entités</a>
<ul class="sectlevel2">
<li><a href="#produits-et-catégories-liaison-entre-objets-métier">Produits et Catégories (Liaison entre objets métier)</a></li>
<li><a href="#liaisons-types-entre-entités-illustrées-avec-uml">Liaisons types entre Entités illustrées avec UML</a></li>
<li><a href="#classe-métier-et-table">Classe métier et table</a></li>
<li><a href="#manytomany-porteuse-de-propriétés">ManyToMany - porteuse de propriétés</a></li>
<li><a href="#alternative-à-la-classe-association">Alternative à la classe association</a></li>
<li><a href="#méthodes-find-requêtes-assistées">Méthodes find* – Requêtes assistées</a></li>
<li><a href="#requête-sql-pdo">Requête SQL PDO</a></li>
<li><a href="#méthodes-createnativequery-requêtes-natives">Méthodes createNativeQuery – Requêtes natives</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="présentation"><a class="anchor" href="#présentation"></a>Présentation</h2>
<div class="sectionbody">
<div class="paragraph">
<p><span class="image"><img src="images/logo-symfony.svg" alt="logo symfony" title="Symfony"></span></p>
</div>
<div class="paragraph">
<p>Symfony est une solution créée par la société <a href="https://sensiolabs.com">Sensiolabs</a> qui en assure l&#8217;évolution,
assitée par de  <a href="https://symfony.com/contributors">nombreux contributeurs</a>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Symfony est un ensemble de Composants PHP, un framework pour les Applications Web, une Philosophie, et une Communauté — tous travaillant ensemble, en harmonie.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Symfony<br>
<cite>Qu'est-ce que Symfony ? par Sensiolabs - a french company</cite>
</div>
</div>
<div class="paragraph">
<p>Cette introduction se base sur les ressources documentaires de Symfony (version 4), afin d&#8217;en faciliter le premier accès à des étudiants
développeurs ayant eu un premier contact avec le développement web.</p>
</div>
<div class="paragraph">
<p>Pour réaliser les travaux pratiques, vous aurez besoin d&#8217;aller plus en profondeur sur la connaissance des composants.
La documentation Symfony est accessible ici : <a href="https://symfony.com/doc/current/index.html" class="bare">https://symfony.com/doc/current/index.html</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="modèle-d-architecture-applicative"><a class="anchor" href="#modèle-d-architecture-applicative"></a>Modèle d&#8217;architecture applicative</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Le modèle traditionnel d&#8217;architecture des applications web est de type 3 tiers (clients, serveur(s), SBBD(s))</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-9344e9752cfd125c977abf44dabfcc53.png" alt="Interaction type entre tiers d&#8217;une application web" width="403" height="283">
</div>
<div class="title">Interaction type entre tiers d&#8217;une application web</div>
</div>
<div class="paragraph">
<p>Les applications symfony se situent sur le tiers du milieu "server et applications" (derrière un serveur HTTP).</p>
</div>
<div class="paragraph">
<p>En environnement de développement, les développeurs PHP disposent du <code>PHP&#8217;s internal web server</code>, un serveur http intégré au langage lui-même,
ce qui assure une certaine cohérence quant à la version de PHP utilisée pour les tests en phase de développement.</p>
</div>
<div class="paragraph">
<p>En environnement de production, l&#8217;application sera placée derrière un server Web de production, disposant d&#8217;une version de PHP conforme aux exigences du framework.
Les serveurs HTTP de production les plus courants sont <code>Apache</code> et <code>Nginx</code>.
Dans ce cas, reférez-vous aux consignes de configurations disponibles sur le site de symfony : <a href="https://symfony.com/doc/current/setup/web_server_configuration.html">web server configurations</a>.</p>
</div>
<div class="sect2">
<h3 id="prérequis"><a class="anchor" href="#prérequis"></a>Prérequis</h3>
<div class="sect3">
<h4 id="pour-le-développeur"><a class="anchor" href="#pour-le-développeur"></a>Pour le développeur</h4>
<div class="ulist">
<ul>
<li>
<p>Avoir une première expérience en programmation orientée objet (POO)</p>
</li>
<li>
<p>Connaître les principes de fonctionnement d&#8217;une interaction HTTP (protocole sans état, transfert de valeurs typées)
et les problématiques et solutions autour de la gestion du suivi de sessions HTTP</p>
</li>
<li>
<p>Une  expérience de mise en oeuvre d&#8217;interactions applicatives avec un SGBD( R ) - en particulier avec SQL</p>
</li>
<li>
<p>Avoir des bases de HTML/CSS et JS.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="pour-le-système"><a class="anchor" href="#pour-le-système"></a>Pour le système</h4>
<div class="paragraph">
<p>Les prérequis système dépendent de la version de symfony que vous comptez utliser.
On vérifiera en particulier :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La version minimale attendue de PHP, actuellement &gt;= 7.2.5 (dépend de la version de Symfony)</p>
</li>
</ul>
</div>
<div class="literalblock">
<div class="title">Connaître la version de php (passer en mode console)</div>
<div class="content">
<pre>$ php -v
PHP 7.2.24</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Les projets Symfony utilisent <code>composer</code> qui est un outil de gestion des dépendances pour des projets PHP en général. Pour l&#8217;installer, suive ce lien <a href="https://getcomposer.org/"><code>Install Composer</code></a></p>
</li>
</ul>
</div>
<div class="literalblock">
<div class="title">Vérifier la version de composer</div>
<div class="content">
<pre>$ composer -V
Composer version 1.9.0 2019-08-02 20:55:32</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Enfin, et non des moindres, installer le programme <code>symfony</code> qui est une sorte d&#8217;assistant de création d&#8217;applications en ligne de commande. Rendez-vous ici pour plus d&#8217;explications : <a href="https://symfony.com/doc/current/setup.html#technical-requirements">symfony technical-requirements</a></p>
</li>
</ul>
</div>
<div class="literalblock">
<div class="title">Vérifier la version de symfony cli</div>
<div class="content">
<pre>$ symfony -V
Symfony CLI version v4.18.4 (2020-08-14T07:17:58+0000 - stable)</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="vérification-de-pré-requis-technique"><a class="anchor" href="#vérification-de-pré-requis-technique"></a>Vérification de pré-requis technique</h3>
<div class="paragraph">
<p>Ce sont des opérations qui s&#8217;effectuent en <strong>ligne de commande</strong>.</p>
</div>
<div class="literalblock">
<div class="title">Premier check</div>
<div class="content">
<pre>$ symfony check:requirements</pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/symfony-check1.png" alt="check-configuration"></span></p>
</div>
<div class="paragraph">
<p><strong>Avant de poursuivre</strong>, si nécessaire, corriger les anomalies et autres manquements sur votre système.</p>
</div>
<div class="paragraph">
<p>Par la suite nous aurons besoin de sqlite, vérifier si le module php est installé</p>
</div>
<div class="literalblock">
<div class="title">Installation de php-sqlite (linux)</div>
<div class="content">
<pre>sudo apt-get install php-sqlite3</pre>
</div>
</div>
<div class="paragraph">
<p>Ainsi que la présence de <code>git</code>, l&#8217;outil de gestion de versions, sur votre système.</p>
</div>
<div class="literalblock">
<div class="title">Tester la présence de <code>git</code> sur votre système</div>
<div class="content">
<pre>git --version</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="création-d-une-application-symfony"><a class="anchor" href="#création-d-une-application-symfony"></a>Création d&#8217;une application symfony</h3>
<div class="paragraph">
<p>Pour commencer, placez-vous dans un dossier racine (<strong>à créer pour l&#8217;occasion</strong>), qui héberge(ra) vos différents projets web, puis,
à partir de ce dossier, exécuter la commande suivante :</p>
</div>
<div class="literalblock">
<div class="title">Création d&#8217;un squelette d&#8217;application</div>
<div class="content">
<pre>$ symfony new my_project_name --full

# un raccourci de : composer create-project symfony/website-skeleton my_project_name</pre>
</div>
</div>
<div class="paragraph">
<p>Explications :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>symfony <i class="conum" data-value="1"></i><b>(1)</b>
    new my_project_name  <i class="conum" data-value="2"></i><b>(2)</b>
     --full     <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>appel de la commande <code>symfony</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>le nom du projet, et donc du <strong>sous-dossier</strong> qui sera <strong>créé</strong>
à partir de la racine courante (il est donc important de se placer dans un dossier de travail avant de lancer une telle commande)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>pour créer un projet selon un modèle : full === application web</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Une fois l&#8217;application créée, où en premier contact d&#8217;une application symfony existante,
il est judicieux de lancer la commande :</p>
</div>
<div class="literalblock">
<div class="title">Symfony About</div>
<div class="content">
<pre>$ php bin/console about</pre>
</div>
</div>
<div class="paragraph">
<p>Voir l&#8217;historique et le prévisionnel des versions ici : <a href="https://symfony.com/roadmap" class="bare">https://symfony.com/roadmap</a></p>
</div>
<div class="sect3">
<h4 id="composants-de-l-application"><a class="anchor" href="#composants-de-l-application"></a>Composants de l&#8217;application</h4>
<div class="paragraph">
<p>Les composants dont dépend l&#8217;application sont répertoriés dans le fichier <code>composer.json</code>
placé à la racine de l&#8217;application.</p>
</div>
<div class="paragraph">
<p>Exemple de déclaration : <code>"require": "php": "^7.2.5"</code></p>
</div>
<div class="paragraph">
<p>Ce qui signifie que l&#8217;application dépend de php en version 7.2.5 ou supérieure (voir doc composer)</p>
</div>
<div class="paragraph">
<p>Voici la commande pour vérifier la présence de vulnérabilités connues des composants dont dépend l&#8217;application (à relancer régulièrement)</p>
</div>
<div class="literalblock">
<div class="title">Composants check</div>
<div class="content">
<pre>$ symfony check:security</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="démarrage-du-serveur-et-de-l-application"><a class="anchor" href="#démarrage-du-serveur-et-de-l-application"></a>Démarrage du serveur et de l&#8217;application</h3>
<div class="paragraph">
<p>Depuis la version 5.4 de PHP, un serveur web est intégré à l&#8217;API.
L&#8217;avantage d&#8217;utiliser ce serveur est que vous êtes sûr qu&#8217;il utilisera la
même version de PHP que celle utilisée en ligne de commande.</p>
</div>
<div class="literalblock">
<div class="title">Demarrage du serveur</div>
<div class="content">
<pre>$ cd my_project_name
$ symfony server:start</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Par défaut, le serveur interne écoute sur le port 8000.
S&#8217;il est déjà pris sur machine, vous pouvez en indiqué un autre, voir ici  <a href="https://symfony.com/doc/current/setup/built_in_web_server.html" class="bare">https://symfony.com/doc/current/setup/built_in_web_server.html</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="partir-d-un-projet-existant-disponible-sur-un-dépôt-git"><a class="anchor" href="#partir-d-un-projet-existant-disponible-sur-un-dépôt-git"></a>Partir d&#8217;un projet existant disponible sur un dépôt git</h3>
<div class="paragraph">
<p>Se placer dans un dossier racine des projets</p>
</div>
<div class="literalblock">
<div class="content">
<pre> cd all-projects/
 git clone ...</pre>
</div>
</div>
<div class="paragraph">
<p>ou via votre IDE (<code>VCS|Get From Version Control</code>)</p>
</div>
<div class="paragraph">
<p>Se placer ensuite à la racine du projet cloné, et installé les composants tiers (<code>vendor</code>) :</p>
</div>
<div class="literalblock">
<div class="content">
<pre> cd le-project/
 composer install</pre>
</div>
</div>
<div class="paragraph">
<p>et patienter le temps que des téléchargements et installations.</p>
</div>
</div>
<div class="sect2">
<h3 id="résumé"><a class="anchor" href="#résumé"></a>Résumé</h3>
<div class="paragraph">
<p>À ce stade, vous avez, sur votre machine de dev, installé, configuré et testé un environnement de développement web avec Symfony.
Vous avez installé Symfony en mode "boîte noire".</p>
</div>
<div class="paragraph">
<p>L&#8217;étape suivante vous amène progressivement à comprendre l&#8217;intérieur de cette boîte, à savoir comment l&#8217;utiliser !</p>
</div>
</div>
<div class="sect2">
<h3 id="tp-installation-de-symfony-demo-application"><a class="anchor" href="#tp-installation-de-symfony-demo-application"></a>TP Installation de Symfony Demo application</h3>
<div class="paragraph">
<p>L&#8217;application <em>Symfony Demo Application</em> est une application pleinement opérationnelle
qui montre les usages recommandés pour développer des applicaitons Symfony.</p>
</div>
<div class="paragraph">
<p>C&#8217;est une <em>application école</em> bien pratique pour les débutants Symfony et son code est accompagné de
nombreux commentaires et autres remarques fort pratiques.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Placez-vous dans le dossier racine des projets symfony avant de lancer la commande ci-dessous.
</td>
</tr>
</table>
</div>
<div class="literalblock">
<div class="title">Création d&#8217;un nouveau projet basé sur Symfony Demo Application:</div>
<div class="content">
<pre> symfony new demosf --demo</pre>
</div>
</div>
<div class="paragraph">
<p>Testez ce projet, et, surtout, gardez-le sous la main afin de plonger dans son code,
chaque fois où serez amenés à utiliser une nouvelle fonctionnalité du framework.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="première-interaction-notion-de-vue-contrôleur"><a class="anchor" href="#première-interaction-notion-de-vue-contrôleur"></a>Première interaction : notion de Vue/Contrôleur</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(vous pouvez vous référer à : <a href="https://symfony.com/doc/current/page_creation.html" class="bare">https://symfony.com/doc/current/page_creation.html</a>)</p>
</div>
<div class="paragraph">
<p>Du point du développement logiciel d&#8217;une application web, "<em>créer une page</em>" c&#8217;est exposer une <strong>ressource web</strong> à un certain public. Pour cela, plusieurs activités sont concernées:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>permettre à l&#8217;application web de répondre à une <strong>requête HTTP</strong> en définissant  une <strong>route</strong> (portion terminale d&#8217;un chemin d&#8217;URL) pour la ressource en question</p>
</li>
<li>
<p>définir via quelle <strong>méthode d&#8217;accès HTTP</strong> cette ressource sera accessible (GET, POST, PUT, HEAD, &#8230;&#8203;)</p>
</li>
<li>
<p>concevoir le <strong>contrôleur</strong> associé à la ressource : une méthode d&#8217;une classe <code>Controller</code></p>
</li>
<li>
<p>définir la structure (type mime - representation) de la resource dynamique (par exemple via le contrôleur ou un template de vue <strong>twig</strong>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Un requête HTTP de type <code>GET</code> correspond à une demande de <em>resssource distante</em>.
La ressource demandée peut correspondre à une donnée statique (un fichier placé sur le serveur) ou dynamique (construite pour l&#8217;occasion).</p>
</div>
<div class="paragraph">
<p>Nous nous plaçons dans le cas où l&#8217;application répondra par du contenu dynamique, la plupart du temps en <code>HTML</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Une application web n&#8217;expose jamais directement ses templates de vue de ses ressources dynamiques (pas de lien direct vers un script de vue)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Dans le cadre de symfony, un contôleur central (<em>front controller</em>) réceptionne les requêtes HTTP
et les traduit en appel de <strong>méthodes</strong> d&#8217;instance d&#8217;une classe <strong>contrôleur</strong> (<em>controller</em>)</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/request-flow.png" alt="symfony-flow-schema"></span></p>
</div>
<div class="paragraph">
<p>Comme le montre ce schéma, le développeur doit mettre à disposition du framework des méthodes dites <em>d&#8217;actions</em>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Attention, le schéma est simplifié, il ne donne pas le nom des classes des méthodes (<code>blogAction</code>,
<code>contactAction</code> et <code>homepageAction</code>),&#8201;&#8212;&#8201;source symfony.com.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La liaison <em>méthode &#8592;&#8594; URL</em> peut se réaliser soit par un <em>fichier de configuration</em>, soit via des <strong><em>annotations</em></strong> dans le code.
Nous choisirons cette dernière option, fort pratique. Avant de concevoir une telle classe, vous devrez ajouter des composants à votre
application. Le plus souple pour cela est de demander à <code>composer</code> de le faire pour vous :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cd my_project_name/
$ composer require annotations</pre>
</div>
</div>
<div class="paragraph">
<p>Il serait également préférable d&#8217;installer des plugins à votre IDE : avec PhpStorm,
aller <code>File&#8594;Settings</code> puis chercher <code>plugin symfony</code>.</p>
</div>
<div class="paragraph">
<p>Voici un exemple de classe contrôleur, extrait de la documentation : <a href="https://symfony.com/doc/current/page_creation.html">Symfony - page_creation.html</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="inline-delimiter">&lt;?php</span>

<span class="comment">// src/Controller/LuckyController.php  </span><i class="conum" data-value="1"></i><b>(1)</b>

<span class="keyword">namespace</span> <span class="constant">App</span>\<span class="constant">Controller</span>;  <i class="conum" data-value="2"></i><b>(2)</b>

<span class="keyword">use</span> <span class="constant">Symfony</span>\<span class="constant">Component</span>\<span class="constant">HttpFoundation</span>\<span class="constant">Response</span>;  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="keyword">use</span> <span class="constant">Symfony</span>\<span class="constant">Component</span>\<span class="constant">Routing</span>\<span class="constant">Annotation</span>\<span class="constant">Route</span>;

<span class="keyword">class</span> <span class="class">LuckyController</span> <i class="conum" data-value="3"></i><b>(3)</b>
{
  <span class="comment">/** <i class="conum" data-value="4"></i><b>(4)</b>
  * @Route(&quot;/lucky/number&quot;, methods={&quot;GET&quot;}, name=&quot;lucky_step_one&quot;) <i class="conum" data-value="5"></i><b>(5)</b>
  */</span>
  <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">number</span>() <i class="conum" data-value="6"></i><b>(6)</b>
  {
    <span class="local-variable">$number</span> = mt_rand(<span class="integer">0</span>, <span class="integer">100</span>);

    <span class="keyword">return</span> <span class="keyword">new</span> <span class="constant">Response</span>( <i class="conum" data-value="7"></i><b>(7)</b>
      <span class="string"><span class="delimiter">'</span><span class="content">&lt;html&gt;&lt;body&gt;Lucky number: </span><span class="delimiter">'</span></span>.<span class="local-variable">$number</span>.<span class="string"><span class="delimiter">'</span><span class="content">&lt;/body&gt;&lt;/html&gt;</span><span class="delimiter">'</span></span>
    );
  }
} <i class="conum" data-value="8"></i><b>(8)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>un commentaire à destination du lecteur du tuto, afin d&#8217;identifier la localisation
du fichier (à ne pas recopier dans le code source !)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>les librairies dont dépend le code ci-dessous (Classe et annotation)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>une classe normale PHP Objet</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Attention : démarre avec <strong>2 étoiles</strong> (ref. à PHPDOC)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>l&#8217;annotation <em>@Route</em> permet de lier l&#8217;appel de la méthode à une requête HTTP GET (extrait terminal d&#8217;une URL de l&#8217;application)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>une méthode public; Elle sera automatiquement appelée par le <em>front controller</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>retourne un instance de <code>Response</code> (avec du contenu <em>HTML</em>). On remarquera que le contenu HTML n&#8217;est pas bien formé (pas de doctype, &lt;head&gt;, &#8230;&#8203;) - on utilise ce type de réponse généralement pour du contenu textuel plus simple.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>le marqueur de fin de traitement PHP (<code>?&gt;</code>) est volontairement absent afin de conserver le sens <em>librairie</em> d&#8217;une classe Controller (ce n&#8217;est pas une page web)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Voici un extrait des spécifications de la fonction <a href="http://php.net/manual/fr/function.mt-rand.php" class="bare">http://php.net/manual/fr/function.mt-rand.php</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="predefined-type">int</span> mt_rand ( <span class="predefined-type">int</span> <span class="local-variable">$min</span> , <span class="predefined-type">int</span> <span class="local-variable">$max</span> )

<span class="constant">Valeurs</span> de retour

<span class="constant">Un</span> entier aléatoire compris entre <span class="predefined">min</span> (ou <span class="integer">0</span>) et <span class="predefined">max</span> inclusif, ou <span class="predefined-constant">FALSE</span> si le paramètre <span class="predefined">max</span> est inférieur à <span class="predefined">min</span>.</code></pre>
</div>
</div>
<div class="literalblock">
<div class="title">Activation de la page (demande de la ressource "number")</div>
<div class="content">
<pre>http://127.0.0.1:8000/lucky/number</pre>
</div>
</div>
<div class="paragraph">
<p>Vous devriez recevoir un nombre dans l&#8217;intervalle : [0..100[</p>
</div>
<div class="sect2">
<h3 id="le-rendu-em-render-em-par-une-logique-de-vue-archtecture-mvc"><a class="anchor" href="#le-rendu-em-render-em-par-une-logique-de-vue-archtecture-mvc"></a>Le rendu (<em>render</em>) par une logique de vue (archtecture MVC)</h3>
<div class="paragraph">
<p>Concevoir la logique de présentation (HTML and Co) dans un contrôleur n&#8217;est pas une bonne pratique.</p>
</div>
<div class="paragraph">
<p>Fort heureusement Symfony vient avec <a href="https://twig.symfony.com/"><strong>Twig</strong></a> : un langage
de vue puissant et plaisant à utiliser.</p>
</div>
<div class="paragraph">
<p>Twig est proposé en tant que composant, qu&#8217;il faut installer :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cd my_project_name/
$ composer require twig</pre>
</div>
</div>
<div class="paragraph">
<p>Il faut ensuite s&#8217;assurer que <code>LuckyController</code> hérite de la classe de base des contrôleurs <code>AbstractController</code>:</p>
</div>
<div class="listingblock">
<div class="title">Listing 1. MVC : Les classes contrôleur héritent de <em>AbstractController</em></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="comment">// src/Controller/LuckyController.php</span>

<span class="comment">// ...</span>
+ <span class="keyword">use</span> <span class="constant">Symfony</span>\<span class="constant">Bundle</span>\<span class="constant">FrameworkBundle</span>\<span class="constant">Controller</span>\<span class="constant">AbstractController</span>; <i class="conum" data-value="1"></i><b>(1)</b>

- <span class="keyword">class</span> <span class="class">LuckyController</span>
+ <span class="keyword">class</span> <span class="class">LuckyController</span> <span class="keyword">extends</span> <span class="constant">AbstractController</span> <i class="conum" data-value="2"></i><b>(2)</b>
{
    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>déclaration de la dépendance (un import)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>la classe LuckyController hérite maintenant de AbstractController</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Et faire en sorte que la méthode contrôleur <strong>délègue</strong> la vue à une page twig :</p>
</div>
<div class="listingblock">
<div class="title">Listing 2. MVC : Le contrôleur délègue la réponse à une logique de vue twig</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="comment">// src/Controller/LuckyController.php</span>

<span class="comment">// ...</span>
<span class="keyword">class</span> <span class="class">LuckyController</span> <span class="keyword">extends</span> <span class="constant">AbstractController</span>
{
    <span class="comment">/**
     * @Route(&quot;/lucky/number&quot;, methods={&quot;GET&quot;}, name=&quot;lucky_step_one&quot;) <i class="conum" data-value="1"></i><b>(1)</b>
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">numberAction</span>()
    {
        <span class="local-variable">$number</span> = mt_rand(<span class="integer">0</span>, <span class="integer">100</span>);

        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;render(<span class="string"><span class="delimiter">'</span><span class="content">lucky/number.html.twig</span><span class="delimiter">'</span></span>, <span class="predefined">array</span>( <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="string"><span class="delimiter">'</span><span class="content">number</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$number</span>,
        ));
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>la valeur de l&#8217;attribut <code>name</code> est le nom de la route. C&#8217;est ce nom qui est utilisé dans le code source pour faire référence à cette route  (plus stable dans le temps que la route elle-même)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>appel de la méthode héritée (<em>render</em>) en lui passant le nom d&#8217;une vue, suivi d&#8217;un <strong>tableau associatif</strong>, appelé aussi <strong>dictionnaire</strong>, composé de <strong>couples (nom_variable&#8658;valeur)</strong>.
Dans notre cas, le tableau n&#8217;a qu&#8217;un seul élément ('number'&#8658; $number),
qui sera passé à la vue.
La vue aura accès à ces valeurs <strong>directement</strong> par le <strong>nom des clés</strong> définis dans ce dictionnaire.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Les fichiers de vue seront cherchés par symfony, par défaut, dans le dossier <strong><em>templates</em></strong> à partir de la racine du projet (ce dossier est automatiquement crée lors de l&#8217;installation de twig).</p>
</div>
</div>
<div class="sect2">
<h3 id="modèle-de-présentation-em-template-em-de-l-application"><a class="anchor" href="#modèle-de-présentation-em-template-em-de-l-application"></a>Modèle de Présentation (<em>template</em>) de l&#8217;application</h3>
<div class="paragraph">
<p>C&#8217;est un fichier qui détermnine la structure HTML/CSS générale de votre application.
La plupart du temps un tel template se base sur un modèle proposé par des frameworks CSS (<em>bootstrap</em>, <em>semantic-ui</em>, &#8230;&#8203;). Il est parfois acheté auprès de sociétés spécialisées.</p>
</div>
<div class="paragraph">
<p>Exemple de template simple, <em>from scratch</em>, créé par le composant <em>twig</em> lors de son intégration dans ce projet (symfony &gt;= 4)</p>
</div>
<div class="listingblock">
<div class="title">Listing 3. localisation : &lt;racine_du_projet&gt;/templates/base.html.twig</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="doctype">&lt;!DOCTYPE html&gt;</span>
<span class="tag">&lt;html&gt;</span>
    <span class="tag">&lt;head&gt;</span>
        <span class="tag">&lt;meta</span> <span class="attribute-name">charset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;title&gt;</span>{% block title %}Welcome!{% endblock %}<span class="tag">&lt;/title&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
        {% block stylesheets %}{% endblock %}
    <span class="tag">&lt;/head&gt;</span>
    <span class="tag">&lt;body&gt;</span>
        {% block body %}{% endblock %} <i class="conum" data-value="2"></i><b>(2)</b>
        {% block javascripts %}{% endblock %}
    <span class="tag">&lt;/body&gt;</span>
<span class="tag">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Définition d&#8217;un block nommé <code>title</code> avec comme valeur par défaut <code>Welcome!</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Définition d&#8217;un block nommé <code>body</code> (ne pas confondre avec <code>&lt;body&gt;</code>).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ce template de base définit 4 blocks : <code>title</code>, <code>stylesheets</code>, <code>body</code> et <code>javascripts</code>.</p>
</div>
<div class="paragraph">
<p>Le fait de nommer ces bloques permet, aux vues héritantes, de personnaliser leur contenus.</p>
</div>
<div class="paragraph">
<p>Par exemple, pour répondre au besoin de notre méthode <em>numberAction</em> de <em>LuckyController</em>, nous
devons créer une nouvelle vue dans le dossier <em>templates/lucky</em>, nommée <code>number.html.twig</code> (<code>lucky</code> est un dossier qu&#8217;il faut créer) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php">{<span class="comment"># templates/lucky/number.html.twig #} </span><i class="conum" data-value="1"></i><b>(1)</b>
{% <span class="keyword">extends</span> <span class="string"><span class="delimiter">'</span><span class="content">base.html.twig</span><span class="delimiter">'</span></span> %} <i class="conum" data-value="2"></i><b>(2)</b>

{% block title %}<span class="constant">Devine</span>{% endblock %} <i class="conum" data-value="3"></i><b>(3)</b>

{% block body %} <i class="conum" data-value="4"></i><b>(4)</b>
&lt;h1&gt;<span class="constant">Your</span> lucky number is {{ number }}&lt;/h1&gt;
{% endblock %}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>un commentaire twig qui vous informe, pour le besoin de ce support,
de la localisation de ce fichier (<strong>à ne pas recopier !</strong>)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>choix du template de base hérité  (qui définit, entre autres, les blocs <code>title</code> et <code>body</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>redéfinition du bloc <code>title</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>redéfinition du bloc <code>body</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vous trouverez la syntaxe twig ici : <a href="https://twig.symfony.com/" class="bare">https://twig.symfony.com/</a></p>
</div>
</div>
<div class="sect2">
<h3 id="résumé-2"><a class="anchor" href="#résumé-2"></a>Résumé</h3>
<div class="paragraph">
<p>Nous avons vu les principes d&#8217;interaction (appel client, controleur et vue) d&#8217;une application web :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Les requêtes HTTP entrantes sont routées par symfony sur des classes contrôleurs :</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
une requête client déclenche un appel de méthode d&#8217;un objet <em>Controller</em>. C&#8217;est à ce niveau que des décisions algorithmiques métier sont exécutées.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>La représentation de la réponse est déléguée à une logique de vue (<strong>twig</strong>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il est temps de tester le code présenter et de faire une pause&#8230;&#8203;</p>
</div>
</div>
<div class="sect2">
<h3 id="tp-tester-le-code-exemple-em-lucky-em"><a class="anchor" href="#tp-tester-le-code-exemple-em-lucky-em"></a>TP tester le code exemple <em>Lucky</em></h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Pour ce TP, vous pouvez choisir d&#8217;utiliser le serveur HTTP
intégré à PHP en le lançant en ligne de commande, <strong>à la racine de votre application web</strong> :</p>
</div>
<div class="paragraph">
<p><code>php bin/console server:run</code></p>
</div>
<div class="paragraph">
<p>ou via la commande</p>
</div>
<div class="paragraph">
<p><code>symfony server:start</code></p>
</div>
<div class="paragraph">
<p>Dans ce cas, il vous faudra tester vos routes ainsi :</p>
</div>
<div class="paragraph">
<p><code><a href="http://127.0.0.1:8000/lucky/number" class="bare">http://127.0.0.1:8000/lucky/number</a></code></p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="gestion-des-données-d-entrée"><a class="anchor" href="#gestion-des-données-d-entrée"></a>Gestion des données d&#8217;entrée</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Conformément à l&#8217;architecture applicative, c&#8217;est une méthode dite <em>contrôleur</em> qui prend en charge l&#8217;exploitation des données transmises par le client (celui qui est à l&#8217;origine de la requête HTTP)</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Teminologie : les méthodes associées à des <em>Routes</em> dans une classe <em>Controller</em> sont appelées <strong><em>méthodes d&#8217;action</em></strong>. Par extension, on nomme parfois de telles méthodes des <strong><em>contrôleurs</em></strong>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="auto-injection-de-l-objet-request"><a class="anchor" href="#auto-injection-de-l-objet-request"></a>Auto-injection de l&#8217;objet Request</h3>
<div class="paragraph">
<p>Pour accéder aux données transmises avec la requête HTTP,
le contrôleur principal a la possibilité de passer aux méthodes d&#8217;action un objet de type <em>Request</em> (de <em>HttpFoundation</em>) (entre autres)</p>
</div>
<div class="paragraph">
<p>Pour cela, les contrôleurs (méthodes d&#8217;action) doivent simplement déclarer en paramètre le ou les objets dont ils ont besoin.
Ce mécanisme est appelé <strong>injection de dépendance</strong> : c&#8217;est une des façons de réaliser l&#8217;inversion de contrôle par les frameworks (<em>IOC</em>). Voir à ce sujet <a href="https://fr.wikipedia.org/wiki/Inversion_de_contr%C3%B4le">wikipedia IOC <em>inversion of control</em></a></p>
</div>
<div class="paragraph">
<p>C&#8217;est par l&#8217;intermédiaire de cet objet, que nous pourrons accéder aux données
de la session utilisateur.</p>
</div>
<div class="paragraph">
<p>Utilisation d&#8217;un objet de la classe <code>Symfony\Component\HttpFoundation\Request</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="keyword">use</span> <span class="constant">Symfony</span>\<span class="constant">Component</span>\<span class="constant">HttpFoundation</span>\<span class="constant">Request</span>; <i class="conum" data-value="1"></i><b>(1)</b>

[...]

<span class="keyword">public</span> <span class="keyword">function</span> <span class="function">index</span>(<span class="constant">Request</span> <span class="local-variable">$request</span>) <i class="conum" data-value="2"></i><b>(2)</b>
{
  <span class="comment">// exploiter $request</span>
}

[...]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>un composant du micro-framework</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Et oui, en PHP on peut aussi typer les paramètres.
En déclarant un paramètre de type <code>Request</code>, on demande à symfony d'<strong>injecter automatiquement</strong> (on parle d&#8217;auto-injection) un argument de ce type, parfaitement bien initialisé.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Attention, dans le cadre d&#8217;un framework, ne pas faire usage des super-globales PHP comme <code>GET[]</code>, <code>SESSION[]</code>, &#8230;&#8203; car cela risquerait d&#8217;entrainer des effets de bords indésirables et contraire aux bonnes pratiques.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="données-implicites"><a class="anchor" href="#données-implicites"></a>Données implicites</h3>
<div class="paragraph">
<p>Ce sont les données transmises par le client, et le serveur,
 dans la partie entête HTTP. Ces données sont accessibles <strong>via</strong> l&#8217;objet <code>Request</code>
 qui dispose de méthodes bient pratiques pour interroger ces données.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>getLanguages()
Returns the list of accepted languages ordered by descending quality.</p>
</li>
<li>
<p>getCharsets()
Returns the list of accepted charsets ordered by descending quality.</p>
</li>
<li>
<p>bool isXmlHttpRequest()
Returns true if the request is a XMLHttpRequest.</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>voir <a href="http://api.symfony.com/4.0/Symfony/Component/HttpFoundation/Request.html">API Request</a></p>
</div>
</div>
<div class="sect2">
<h3 id="données-explicites"><a class="anchor" href="#données-explicites"></a>Données explicites</h3>
<div class="paragraph">
<p>Typiquement ce sont celles en provenance d&#8217;une requête <code>HTTP</code> de type <code>POST</code> <strong>formulaire HTML ou non</strong>,
soit comme composantes <a href="https://en.wikipedia.org/wiki/Query_string">QueryString</a> de l'<strong>URL</strong> (arguments d&#8217;une requête <code>HTTP</code> de type <code>GET</code> par exemple).</p>
</div>
<div class="sect3">
<h4 id="via-un-code-get-code-cas-des-arguments-passés-dans-l-url-querystring"><a class="anchor" href="#via-un-code-get-code-cas-des-arguments-passés-dans-l-url-querystring"></a>via un <code>GET</code>, cas des arguments passés dans l&#8217;url (querystring)</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"> <span class="comment">// obtenir les données transmises par GET</span>
 <span class="local-variable">$x</span> = <span class="local-variable">$request</span>-&gt;query-&gt;get(<span class="string"><span class="delimiter">'</span><span class="content">x</span><span class="delimiter">'</span></span>, <span class="integer">66</span>);  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>C&#8217;est via l&#8217;attribut <code>query</code> de l&#8217;objet référencé par <code>$request</code>, que le contrôleur aura
accès aux données passées par <code>GET</code>, via sa méthode <code>get</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Exemple d&#8217;arguments de l&#8217;URL : <code>?a=b&amp;x=42</code>.
La méthode <code>get</code> prend en premier argument la <strong>clé</strong> (ici <code>a</code> ou <code>x</code>),
le deuxième étant une <strong>valeur par défaut</strong>. Ici <code>$x</code> aura comme valeur <strong>42</strong> car il est renseigné en querystring de l&#8217;url.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="via-un-code-post-code-formulaire-html-côté-client-par-exemple"><a class="anchor" href="#via-un-code-post-code-formulaire-html-côté-client-par-exemple"></a>via un <code>POST</code> (formulaire HTML côté client par exemple)</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php">    <span class="comment">// obtenir une valeur transmises par POST d'après sa clé</span>
    <span class="local-variable">$request</span>-&gt;request-&gt;get(<span class="string"><span class="delimiter">'</span><span class="content">idproduit</span><span class="delimiter">'</span></span>); <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="comment">// obtenir une instance de UploadedFile identifiée par foo</span>
    <span class="local-variable">$request</span>-&gt;files-&gt;get(<span class="string"><span class="delimiter">'</span><span class="content">foo</span><span class="delimiter">'</span></span>);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>C&#8217;est via l&#8217;attribut <code>request</code>, de l&#8217;objet référencé par <code>$request</code> (à ne pas confondre) que le contrôleur
aura accès aux données passées par <code>POST</code> via un appel à sa méthode <code>get</code> (admet également un second paramètre
comme valeur par défaut).</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="cas-de-valeurs-incluses-dans-l-url-même"><a class="anchor" href="#cas-de-valeurs-incluses-dans-l-url-même"></a>Cas de valeurs incluses dans l&#8217;url même</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php">    <span class="comment">/**
     * Matches /blog/*
     *
     * @Route(&quot;/blog/{textid}&quot;, methods={&quot;GET&quot;}, name=&quot;blog_show&quot;)  <i class="conum" data-value="1"></i><b>(1)</b>
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">show</span>(<span class="local-variable">$textid</span>) { ... } <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>La route contient une partie <strong>variable</strong>, représentée par un paramètre
placé entre <code>{  }</code> (ici <em>textid</em>). Exemples d&#8217;arguments : <code>/blog/usecase1</code> ou <code>/blog/usecase2</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Reprise de la partie variable de l&#8217;url comme <strong>paramètre</strong> de la méthode (attention, la correspondance
se base sur les <strong>noms</strong> inscrits entre { } dans la route)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il est dans ce cas très facile de récupérer les valeurs en question, car elles sont passées automatiquement
en tant qu&#8217;argument de la méthode !</p>
</div>
<div class="paragraph">
<p>Plus d&#8217;infos sur l&#8217;exploitation des valeurs d&#8217;entrée :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://symfony.com/doc/current/routing.html" class="bare">https://symfony.com/doc/current/routing.html</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>avec des exemples de redirection :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://symfony.com/doc/current/controller.html" class="bare">https://symfony.com/doc/current/controller.html</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tp-le-contrôleur-et-la-vue-initiation"><a class="anchor" href="#tp-le-contrôleur-et-la-vue-initiation"></a>TP - Le contrôleur et la vue (initiation)</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Attention à bien respecter les conventions de nommage :
      <a href="http://symfony.com/doc/current/contributing/code/standards.html" class="bare">http://symfony.com/doc/current/contributing/code/standards.html</a>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic" start="1">
<li>
<p>Ajouter un nouveau controller nommé <em>SioController</em> disposant d&#8217;une méthode nommée <em>indexAction</em>.
 Faire en sorte que l&#8217;index présente le message « <strong>Hello world !</strong> » à l&#8217;utilisateur
(vue twig attendue), ainsi que la <strong>liste des langues préférées</strong> du client (données implicites).</p>
</li>
</ol>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Ajouter la méthode d&#8217;action <em>helloAction</em> ci-dessous, qui reçoit en paramètre
un nom, et retourne, via une vue twig, le message « Hello &lt;nom&gt; !» (où &lt;nom&gt;
est l&#8217;argument reçu)</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php">  <span class="comment">/**
  * @Route(&quot;/hello/{nom}&quot;, methods={&quot;GET&quot;}, name=&quot;sio_hello&quot;)
  */</span>
  <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">helloAction</span>(<span class="local-variable">$nom</span>) {
    <span class="keyword">return</span> <span class="local-variable">$this</span>-­&gt;render(<span class="string"><span class="delimiter">'</span><span class="content">sio/hello.html.twig</span><span class="delimiter">'</span></span>, <span class="predefined">array</span>(<span class="string"><span class="delimiter">'</span><span class="content">nom</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$nom</span>));
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Faire en sorte que le nom soit présenté à l&#8217;utilisateur en <strong>majuscule</strong>.
Comme c&#8217;est un travail de présentation, il est logique de dédier cette tâche
à la logique de présentation.
Pour cela vous consulterez la documentation technique à cette adresse <a href="https://twig.symfony.com/doc/2.x/templates.html">Twig for Template Designers</a></p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Modifier la méthode d&#8217;action helloAction afin que, si le nom transmis est de
la forme <em>prenom_nom</em> (prénom[tiret_du_bas]nom), le message soit présenté  selon
l&#8217;exemple ci-dessous : <a href="http://localhost:8000/hello/django_reinhardt" class="bare">http://localhost:8000/hello/django_reinhardt</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/hello-django.png" alt="hello-django"></span></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
si aucun <em>underscore</em> n&#8217;est présente dans l&#8217;argument de l&#8217;url,
le fonctionnement de <code>helloAction</code> devra rester conforme à l&#8217;attendu de la question précédente (soit "Hello Django" si seule la valeur "Django" est transmise)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>&#8658; à vous de déterminer le travail qui devra être réalisé côté contrôleur et côté logique de présentaiton (twig)</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p>Modifier le controleur de sorte que si aucun nom n&#8217;est passé à hello, le
message 'Hello Inconnu !' est présenté. Voir le concept de <strong>valeur par défaut</strong> pour le paramètre en suivant ce lien :  <a href="https://symfony.com/doc/current/routing.html#optional-parameters">route and optional-parameters</a></p>
</li>
</ol>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>(plus difficile) Ajouter un <strong><em>flash message</em></strong> (concept à étudier !), qui retourne  à
l&#8217;utilisateur un <strong>message de bienvenue avec son IP</strong> lors d&#8217;une <strong>première connection</strong> à la route <code>/hello</code> (et donc à sa méthode d&#8217;action liée),
pour une même instance de navigateur. Conseil : Afficher dans un premier temps le message, puis mettre sous condition la création du message en gérant une donnée de session utilisateur.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
l&#8217;objet Session peut être retrouvé via un objet Request que l&#8217;on déclare
en paramètre d&#8217;une méthode d&#8217;action et qui sera automatiquement
« injecté » (passé) par le contrôleur principal de symfony.
On peut aussi demander l&#8217;injection direct d&#8217;un objet Session.
Voir <a href="https://symfony.com/doc/current/controller.html#managing-the-session">symfony : managing-the-session</a>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction-au-model"><a class="anchor" href="#introduction-au-model"></a>Introduction au Model</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Éléments-d-architecture"><a class="anchor" href="#Éléments-d-architecture"></a>Éléments d&#8217;architecture</h3>
<div class="paragraph">
<p>Nous avons vu comment associer des <em>routes</em> à des <em>contrôleurs</em> (méthodes d&#8217;action d&#8217;une classe Controller).</p>
</div>
<div class="paragraph">
<p>Nous allons voir comment le contrôleur peut s&#8217;appuyer sur des <strong>objets métier</strong> pour <strong>implémenter une logique de cas d&#8217;utilisation</strong>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Il est courant de faire porter la responsabilité d&#8217;un cas d&#8217;utilisation à une classe dédiée (<em>manager</em>, ou simplement contrôleur).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>Entity</code> représente les objets métier, et sont associés à des objets <code>EntityRepository</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Entity</code> : Représente une classe métier pour le domaine étudié (<code>Client</code>, <code>Contrat</code>, &#8230;&#8203;).</p>
</li>
<li>
<p><code>EntityRepository</code> : Est responsable de la communication avec le système de persistance, notamment en lien avec l' <code>ORM</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le contrôleur dépend de <code>Entity</code>, <code>Entity</code> ne dépend pas d&#8217;un ORM, <code>EntityRepository</code> si.</p>
</div>
<div class="paragraph">
<div class="title">Architecture vue en couches (simplifiée)</div>
<p><span class="image"><img src="images/schema-interactions-couches.png" alt="Interactions vue en couches" width="600"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="premiers-pas-avec-le-model"><a class="anchor" href="#premiers-pas-avec-le-model"></a>Premiers pas avec le model</h3>
<div class="sect3">
<h4 id="guide"><a class="anchor" href="#guide"></a>Guide</h4>
<div class="paragraph">
<p>Faire le lien entre un objet (instance d&#8217;une classe Entity) et une ligne d&#8217;une table d&#8217;une base de données
est une opération complexe (synchronisation, mise en cache, cohérence de type, &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>Les <strong>ORMs</strong> (<em>object-relational mapping</em>) sont des logiciels qui effectuent le lien entre <strong>objet métier</strong> et <strong>ligne</strong>
de table d&#8217;une base de données. Par défaut, symfony utilise la solution <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/">doctrine</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="tutoriel-doctrine-de-symfony"><a class="anchor" href="#tutoriel-doctrine-de-symfony"></a>Tutoriel doctrine de symfony</h4>
<div class="paragraph">
<p><code>Doctrine</code> peut être mise en oeuvre sans Symfony, mais nous vous invitons néanmoins à
étudier le tutoriel Doctrine avec Symfony, car ce dernier en simplifie l&#8217;accès.</p>
</div>
<div class="paragraph">
<p>Ce tutoriel vous montre comment lier une classe métier à une table d&#8217;une base de données, et donc une instance (un objet) à une ligne (occurrence d&#8217;une table),
et les opérations CRUD associées.</p>
</div>
<div class="paragraph">
<p>Au menu :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Entity</p>
</li>
<li>
<p>Liaison Attribut - Colonne (<em>field</em> - <em>column</em>)</p>
</li>
<li>
<p>Migration modèle objet &#8592;&#8594; schéma de la base de données</p>
</li>
<li>
<p>Opérations CRUD</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Tutoriel à suivre et <strong>coder</strong> : <a href="https://symfony.com/doc/current/doctrine.html">Introduction à Doctrine avec Symfony</a> - Durée estimée : 2H (étude, configuration, codage des exemples et tests)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="travaux-pratiques"><a class="anchor" href="#travaux-pratiques"></a>Travaux Pratiques</h3>
<div class="paragraph">
<p>Durée moyenne : 4H-12h</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic" start="1">
<li>
<p><strong>Coder/tester les exemples du tutoriel</strong></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Concevoir l&#8217;entité <code>Product</code> et coder/tester les exemples du contrôleur, jusqu&#8217;au paragraphe <code>Deleting an Object</code> inclus.
(Une petite lecture du reste du document ne peut pas faire de mal)</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p><strong>Lister et Supprimer</strong></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Concevoir, dans <code>ProductController</code> une méthode d&#8217;action (un contrôleur), liée à la route <code>product/</code>
qui affiche la liste des produits, avec la possibilité de suprimer, individuellement, chacun des produits de la liste.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Les explications sont dans le tutoriel. Utilisez twig pour la vue.
Exemple de contrôleur <code>public function index(ProductRepository $productRepository</code>)
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Contrairement aux exemples présentés dans le tutoriel, toute action dans un contrôleur
qui entraine un changement d&#8217;état de la base de données doit retourner un ordre de redirection côté client.
C&#8217;est une règle très importante dans le développement web, connue par l&#8217;acronyme <strong>PRG</strong> (<em>Post Redirect Get</em>).
Voir wikipedia à ce sujet.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>&#8658; La règle <strong>PRG</strong> doit être appliquée <strong>dès maintenant</strong> dans vos développement web. Vous vous référerez à la documentation
Mozilla pour en savoir plus sur les ordres de redirection HTTP 30x : <a href="https://developer.mozilla.org/fr/docs/Web/HTTP/Redirections" class="bare">https://developer.mozilla.org/fr/docs/Web/HTTP/Redirections</a>,
et consulterez la documentation symfony pour savoir comment réaliser cela à partir
d&#8217;un contrôleur.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p><strong>Création automatique de produits</strong></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Concevoir, dans <code>ProductController</code> une méthode d&#8217;action (un contrôleur), liée à la route <code>product/install</code> qui,
si la base de données est vide, créera 10 produits, aux caractérisques distincts, dans la base de données.
Dans tous les cas, un <strong>message flash</strong> indiquera l&#8217;action qui aura été réalisée suite au traitement demandé
(technique compatible avec la règle PRG))</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p><strong>Réinitialisation</strong></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ajouter le fait de pouvoir réinitialiser la base de données de produits
(supprimer tous les produits), si et seulement si la base de données respecte les conditions suivantes :</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><strong>Condition 1</strong> : contenir <strong>10 articles ou moins</strong>,</p>
</li>
<li>
<p><strong>Condition 2</strong> : contenir des articles <strong>créés dans un même espace temps (à une minute près)</strong>.
Cette dernière condition entraine une mise à jour de la structure de votre entité, et pourra ne pas être prise en compte si présence, dans l&#8217;URL,
d&#8217;un paramètre nommé <code>force</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le déclenchement de ce traitement se fera dans le cas d&#8217;un <code>reset</code> explicite (une nouvelle route).
Prévoir également un message flash.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cas-du-formulaire"><a class="anchor" href="#cas-du-formulaire"></a>Cas du formulaire</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="introduction"><a class="anchor" href="#introduction"></a>Introduction</h3>
<div class="paragraph">
<p>La gestion de formulaires est un des points sensibles en développement web, comme l&#8217;est toute Entrée/Sortie d&#8217;une application.</p>
</div>
<div class="paragraph">
<p>De plus, l&#8217;utilisateur s&#8217;attend à la fois à une certaine ergonomie
(présentation de valeurs en base de données ou précédemment saisies
 par ce dernier) ainsi qu&#8217;au respect de la cohérence (prise en compte de la validité des données côté client et serveur).</p>
</div>
<div class="paragraph">
<p>Symfony intègre un composant nommé <code>form</code> qui prend en charge la gestion de formulaire.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre> composer require symfony/form</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce composant a sa propre documentation : <a href="https://symfony.com/doc/current/forms.html" class="bare">https://symfony.com/doc/current/forms.html</a></p>
</div>
</div>
<div class="sect2">
<h3 id="logique-de-traitement-du-formulaire"><a class="anchor" href="#logique-de-traitement-du-formulaire"></a>Logique de traitement du formulaire</h3>
<div class="paragraph">
<p>Dans sa version courante, un formulaire est lié à un objet métier (une classe Entity).</p>
</div>
<div class="paragraph">
<p>De plus, il intégère les propriétés importantes suivantes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Gestion des requêtes HTTP : prise en charge du traitement des demandes et des téléchargements de fichiers;</p>
</li>
<li>
<p>Protection CSRF: Prise en charge de la protection contre les attaques CSRF (Cross-Site-Request-Forgery);</p>
</li>
<li>
<p>Templating: Intégration d&#8217;une couche de présentation qui permet de réutiliser des fragments HTML lors du rendu d&#8217;un formulaire;</p>
</li>
<li>
<p>Traduction: Prise en charge de la traduction des messages d&#8217;erreur, des étiquettes de champs et d&#8217;autres chaînes;</p>
</li>
<li>
<p>Validation: Intégration d&#8217;une bibliothèque de validation pour générer des messages d&#8217;erreur pour les données soumises.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="logique-métier-du-formulaire"><a class="anchor" href="#logique-métier-du-formulaire"></a>Logique métier du formulaire</h3>
<div class="paragraph">
<p>Dans cette phase d&#8217;initiation, nous nous concentrerons principalement sur</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la relation Formulaire ↔ Entité</p>
</li>
<li>
<p>les création/suppression/mise à jour via Doctrine (aperçues au chapitre précédent)</p>
</li>
<li>
<p>la mise en forme des champs de formulaire</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>&#8658; Devra être prolongée par l&#8217;étude des systèmes de validation des attributs côté client et serveur.</p>
</div>
<div class="sect3">
<h4 id="méthode-d-action-newxxx"><a class="anchor" href="#méthode-d-action-newxxx"></a>Méthode d&#8217;action newXXX</h4>
<div class="paragraph">
<p>Nous prendrons le cas de la création d&#8217;une instance d&#8217;une entité.</p>
</div>
<div class="paragraph">
<p>Dans ce cas, l&#8217;algorithme retenu par les concepteurs de Symfony et
celui d&#8217;une seule méthode d&#8217;action (une route) pour, à la fois,</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Présenter le formulaire de création et, dans un second temps,</p>
</li>
<li>
<p>Effectuer le traitement de création  (impacter le système d&#8217;information).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le pattern PRG (<a href="https://fr.wikipedia.org/wiki/Post-Redirect-Get" class="bare">https://fr.wikipedia.org/wiki/Post-Redirect-Get</a>) impose au développeur de fournir un ordre de redirection côté client comme réponse à toute action impactant le système (voir le lien si vous ne savez pas pourquoi).
De ce fait, la logique du formulaire sera basée sur l&#8217;algorithme représenté ci-après.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/algo-form.png" alt="algo form" width="323" height="665">
</div>
</div>
<div class="paragraph">
<p>En guise d&#8217;exemple, voici une méthode d&#8217;action typique.</p>
</div>
<div class="paragraph">
<p>Observez la mise en correspondance des étapes numérotées avec des lettres de l&#8217;algorithme (diagramme ci-dessus) avec les lignes du code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td>
  <td class="code"><pre><span class="keyword">use</span> <span class="constant">Symfony</span>\<span class="constant">Component</span>\<span class="constant">HttpFoundation</span>\<span class="constant">Request</span>;

<span class="keyword">public</span> <span class="keyword">function</span> <span class="function">new</span>(<span class="constant">Request</span> <span class="local-variable">$request</span>) <i class="conum" data-value="1"></i><b>(1)</b>
{
    <span class="comment">// création d'une instance d'entité</span>
    <span class="local-variable">$task</span> = <span class="keyword">new</span> <span class="constant">Task</span>();  <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="local-variable">$form</span> = <span class="local-variable">$this</span>-&gt;createFormBuilder(<span class="local-variable">$task</span>) <i class="conum" data-value="3"></i><b>(3)</b>
        -&gt;add(<span class="string"><span class="delimiter">'</span><span class="content">task</span><span class="delimiter">'</span></span>, <span class="constant">TextType</span>::<span class="keyword">class</span>)
        -&gt;add(<span class="string"><span class="delimiter">'</span><span class="content">dueDate</span><span class="delimiter">'</span></span>, <span class="constant">DateType</span>::<span class="keyword">class</span>)
        -&gt;add(<span class="string"><span class="delimiter">'</span><span class="content">save</span><span class="delimiter">'</span></span>, <span class="constant">SubmitType</span>::<span class="keyword">class</span>, <span class="predefined">array</span>(<span class="string"><span class="delimiter">'</span><span class="content">label</span><span class="delimiter">'</span></span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">Create Task</span><span class="delimiter">'</span></span>))
        -&gt;getForm();

    <span class="local-variable">$form</span>-&gt;handleRequest(<span class="local-variable">$request</span>); <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="comment">// l'objet référencé par $task est mis à jour</span>

    <span class="keyword">if</span> (<span class="local-variable">$form</span>-&gt;isSubmitted() &amp;&amp; <span class="local-variable">$form</span>-&gt;isValid()) {  <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="comment">// $form-&gt;getData() holds the submitted values</span>

        <span class="local-variable">$task</span> = <span class="local-variable">$form</span>-&gt;getData();

        <span class="comment">// ... réalise quelques actions,</span>
        <span class="comment">//    comme sauvegarder task dans la base de données</span>
        <span class="comment">// $entityManager = $this-&gt;getDoctrine()-&gt;getManager();</span>
        <span class="comment">// $entityManager-&gt;persist($task); </span><i class="conum" data-value="6"></i><b>(6)</b>
        <span class="comment">// $entityManager-&gt;flush();</span>

        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;redirectToRoute(<span class="string"><span class="delimiter">'</span><span class="content">task_success</span><span class="delimiter">'</span></span>); <i class="conum" data-value="7"></i><b>(7)</b>
    }

    <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;render(<span class="string"><span class="delimiter">'</span><span class="content">default/new.html.twig</span><span class="delimiter">'</span></span>, <span class="predefined">array</span>(  <i class="conum" data-value="8"></i><b>(8)</b> <i class="conum" data-value="9"></i><b>(9)</b>
        <span class="string"><span class="delimiter">'</span><span class="content">form</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$form</span>-&gt;createView(),
    ));
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Les numéros de droite font référence aux étapes de l&#8217;algorithme ci-dessus.</p>
</div>
<div class="paragraph">
<p>Lorsque la page est initialisée dans un navigateur,
le formulaire est simplement créé et présenté (<em>created and rendered</em>).</p>
</div>
<div class="paragraph">
<p>La première fois, la méthode <em>handleRequest()</em> reconnaît  que le formulaire n&#8217;est pas
soumis et ne fait donc rien.</p>
</div>
<div class="paragraph">
<p>La méthode <em>isValid()</em> retourne  false si le formulaire n&#8217;a pas reçu de data.
Une bonne pratique consiste cependant à s&#8217;assurer ques des données sont reçues (<em>isSubmitted()</em>) avant de tester leur validité !</p>
</div>
<div class="paragraph">
<p>Lorsque l&#8217;utilisateur soumet la requête avec des données, la méthode <em>handleRequest()</em>  transmet
ces données à l&#8217;instance de l&#8217;entité détenue par form.
Ensuite, si les données ne sont pas valides, alors elles sont de nouveau représentées
à l&#8217;utilisateur avec les erreurs. Sinon, la méthode isValid rend true, et le
développeur peut affiner un peu plus la situation avant de réaliser l&#8217;action cible
(ligne 20-21).</p>
</div>
<div class="paragraph">
<p>Afin d&#8217;éviter de devoir recoder la logique de createFormBuilder,
vous pouvez définir des Form/Type (une classe par entité - voir doc symfony)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="comment">// src/Form/Type/TaskType.php</span>
<span class="keyword">namespace</span> <span class="constant">App</span>\<span class="constant">Form</span>\<span class="constant">Type</span>;

<span class="keyword">use</span> <span class="constant">Symfony</span>\<span class="constant">Component</span>\<span class="constant">Form</span>\<span class="constant">AbstractType</span>;
<span class="keyword">use</span> <span class="constant">Symfony</span>\<span class="constant">Component</span>\<span class="constant">Form</span>\<span class="constant">Extension</span>\<span class="constant">Core</span>\<span class="constant">Type</span>\<span class="constant">DateType</span>;
<span class="keyword">use</span> <span class="constant">Symfony</span>\<span class="constant">Component</span>\<span class="constant">Form</span>\<span class="constant">Extension</span>\<span class="constant">Core</span>\<span class="constant">Type</span>\<span class="constant">SubmitType</span>;
<span class="keyword">use</span> <span class="constant">Symfony</span>\<span class="constant">Component</span>\<span class="constant">Form</span>\<span class="constant">Extension</span>\<span class="constant">Core</span>\<span class="constant">Type</span>\<span class="constant">TextType</span>;
<span class="keyword">use</span> <span class="constant">Symfony</span>\<span class="constant">Component</span>\<span class="constant">Form</span>\<span class="constant">FormBuilderInterface</span>;

<span class="keyword">class</span> <span class="class">TaskType</span> <span class="keyword">extends</span> <span class="constant">AbstractType</span> {
  <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">buildForm</span>(<span class="constant">FormBuilderInterface</span> <span class="local-variable">$builder</span>, <span class="predefined">array</span> <span class="local-variable">$options</span>)
  {
    <span class="local-variable">$builder</span>
      -&gt;add(<span class="string"><span class="delimiter">'</span><span class="content">task</span><span class="delimiter">'</span></span>, <span class="constant">TextType</span>::<span class="keyword">class</span>)
      -&gt;add(<span class="string"><span class="delimiter">'</span><span class="content">dueDate</span><span class="delimiter">'</span></span>, <span class="constant">DateType</span>::<span class="keyword">class</span>)
      -&gt;add(<span class="string"><span class="delimiter">'</span><span class="content">save</span><span class="delimiter">'</span></span>, <span class="constant">SubmitType</span>::<span class="keyword">class</span>)
    ;
  }
  <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">configureOptions</span>(<span class="constant">OptionsResolver</span> <span class="local-variable">$resolver</span>)
  {
     <span class="local-variable">$resolver</span>-&gt;setDefaults([
         <span class="string"><span class="delimiter">'</span><span class="content">data_class</span><span class="delimiter">'</span></span> =&gt; <span class="constant">Task</span>::<span class="keyword">class</span>,
     ]);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>et son usage dans le contrôleur :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="comment">// src/Controller/TaskController.php</span>
<span class="keyword">namespace</span> <span class="constant">App</span>\<span class="constant">Controller</span>;

<span class="keyword">use</span> <span class="constant">App</span>\<span class="constant">Form</span>\<span class="constant">Type</span>\<span class="constant">TaskType</span>;
<span class="comment">// ...</span>

<span class="keyword">class</span> <span class="class">TaskController</span> <span class="keyword">extends</span> <span class="constant">AbstractController</span>
{
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">new</span>()
    {
        <span class="comment">// creates a task object and initializes some data for this example</span>
        <span class="local-variable">$task</span> = <span class="keyword">new</span> <span class="constant">Task</span>();
        <span class="local-variable">$task</span>-&gt;setTask(<span class="string"><span class="delimiter">'</span><span class="content">Write a blog post</span><span class="delimiter">'</span></span>);
        <span class="local-variable">$task</span>-&gt;setDueDate(<span class="keyword">new</span> \<span class="constant">DateTime</span>(<span class="string"><span class="delimiter">'</span><span class="content">tomorrow</span><span class="delimiter">'</span></span>));

        <span class="local-variable">$form</span> = <span class="local-variable">$this</span>-&gt;createForm(<span class="constant">TaskType</span>::<span class="keyword">class</span>, <span class="local-variable">$task</span>); <i class="conum" data-value="1"></i><b>(1)</b>

        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;render(<span class="string"><span class="delimiter">'</span><span class="content">task/new.html.twig</span><span class="delimiter">'</span></span>, [
            <span class="string"><span class="delimiter">'</span><span class="content">form</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$form</span>-&gt;createView(),
        ]);
        <span class="comment">// ...</span>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>On remarquera l&#8217;usage de la méthode <code>createForm</code> qui prend comme argument une référence à une classe
qui hérite de <code>Symfony\Component\Form\AbstractType</code> (ici <code>TaskType</code>) et une référence à une
instance d&#8217;une entité (ici <code>$task</code>, un objet nouvellement créé pour l&#8217;occasion).</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="rendu-du-formulaire"><a class="anchor" href="#rendu-du-formulaire"></a>Rendu du formulaire</h3>
<div class="paragraph">
<p>Exemple de rendu d&#8217;un formulaire associé à une entité <code>Pays(Nom, AnnéeIndependance)</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">[...]

{% block content %}

{{ form(formulaire) }}  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>

{% endblock %}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>form()</code> est une fonction qui traduit les structures internes php en une représentation HTML</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>formulaire</code> se réfère à la variable passé par le contrôleur.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ce qui donne : <span class="image"><img src="images/form-pays-1.png" alt="form-pays-1"></span></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
La fonction <code>form</code> dans la vue obtient les données d&#8217;attributs de l&#8217;objet (ici une instance de Pays) via
ses méthodes d&#8217;accès (<code>getter/setter</code>) à moins que ces attributs soient public (pas une bonne idée).Concernant les
valeur booléenne, leur accès se fait par <code>isser</code> ou <code>hasser</code> (par exemple : isPublished() or hasReminder()) au lieu de
getPublished() or getReminder()).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Bien entendu, Symfony vous permet de prendre la main finement sur la présentation du formulaire.</p>
</div>
<div class="paragraph">
<p>Par exemple, en suivant les instructions d&#8217;usage de Bootstrap Twitter (<a href="http://getbootstrap.com/css/#forms" class="bare">http://getbootstrap.com/css/#forms</a>), nous appliquons de nouvelles classes CSS à nos éléments de formulaire (label, zone de message d&#8217;erreur, input) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">{% block content %}

{% set form = formulaire %}

{{ form_start(form,
   {'attr': {'role': 'form'}}
   ) }}
  {{ form_errors(form) }}

    <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-group</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        {{ form_label(form.name) }}
        {{ form_errors(form.name) }}
        {{ form_widget(form.name,
           {'attr': {'class': 'form-control'}}
        )}}
    <span class="tag">&lt;/div&gt;</span>

    <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-group</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        {{ form_label(form.indepYear) }}
        {{ form_errors(form.indepYear) }}
        {{ form_widget(form.indepYear,
          {'attr': {'class': 'form-control'}}
        )}}
    <span class="tag">&lt;/div&gt;</span>

    <span class="tag">&lt;button</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">submit</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">btn btn-default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
       Enregistrer
    <span class="tag">&lt;/button&gt;</span>

{{ form_end(form) }}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce qui donne.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/form-pays-2.png" alt="form-pays-2"></span></p>
</div>
<div class="paragraph">
<p>Exemple de code HTML généré par twig :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td>
  <td class="code"><pre>
<span class="tag">&lt;form</span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">post</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">action</span>=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">role</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-group</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;label</span> <span class="attribute-name">for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form_name</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">required</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
          Name
        <span class="tag">&lt;/label&gt;</span>

        <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form_name</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form[name]</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">required</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">required</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-control</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Algeria</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/div&gt;</span>

    <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-group</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;label</span> <span class="attribute-name">for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form_indepYear</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">required</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
          Indep year
        <span class="tag">&lt;/label&gt;</span>

        <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">number</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form_indepYear</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form[indepYear]</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">required</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">required</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-control</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1962</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/div&gt;</span>

    <span class="tag">&lt;button</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">submit</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">btn btn-default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Enregistrer<span class="tag">&lt;/button&gt;</span>

    <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hidden</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form__token</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form[_token]</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4c4d20ce63cb7b54836f6785b6d675b32be1954d</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/form&gt;</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>On remarquera le <code>token</code> de prévention CRSF (<em>Cross site request forgery</em>) en fin
de formulaire dans le but d&#8217;éviter qu&#8217;un site mal intentionné ne vous entraine à déclencher des actions à votre insue.</p>
</div>
</div>
<div class="sect2">
<h3 id="bonnes-pratiques-et-vidéo-exemples"><a class="anchor" href="#bonnes-pratiques-et-vidéo-exemples"></a>Bonnes pratiques et vidéo exemples</h3>
<div class="ulist">
<ul>
<li>
<p>voir : <a href="https://symfony.com/doc/current/best_practices.html#forms" class="bare">https://symfony.com/doc/current/best_practices.html#forms</a></p>
</li>
<li>
<p>Excellentes vidéos  (+ de 4h - les premières sont gratuites !) :</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://symfonycasts.com/screencast/symfony-forms" class="bare">https://symfonycasts.com/screencast/symfony-forms</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Ce type de formation est vendue, en moyenne, autour de 800€ la journée.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="travaux-pratiques-2"><a class="anchor" href="#travaux-pratiques-2"></a>Travaux pratiques</h3>
<div class="paragraph">
<p>Durée moyenne : ~4H à 8H</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic" start="1">
<li>
<p>À partir de l&#8217;exemple étudié dans le tutoriel de Symfony sur la notion de <code>Model</code> (classe <code>Product</code>), réalisez les opérations permettant à un utilisateur lambda de :</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Lister les produits</p>
</li>
<li>
<p>Création d&#8217;un produit</p>
</li>
<li>
<p>Modifier un produit</p>
</li>
<li>
<p>Supprimer un produit</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="securite"><a class="anchor" href="#securite"></a>Securite</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="introduction-2"><a class="anchor" href="#introduction-2"></a>Introduction</h3>
<div class="paragraph">
<p>Par "sécurité" on entend ici le contrôle d&#8217;accès à des ressources web.</p>
</div>
<div class="paragraph">
<p>Le contrôle d&#8217;accès à une ressource protégée est constitué de 3 étapes :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>identification</p>
</li>
<li>
<p>authentification</p>
</li>
<li>
<p>habilitation</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>L&#8217;identification est le plus souvent pris en charge par un formulaire de login (ou gestion d&#8217;un jeton)</p>
</div>
<div class="paragraph">
<p>L&#8217;authentification est une opération qui vérifie que l&#8217;utilisateur est bien celui revendiqué</p>
</div>
<div class="paragraph">
<p>L&#8217;habilitation consiste ensuite à vérifier si l&#8217;utilisateur a les droits d&#8217;accéder à la ressource (ou service) demandée.</p>
</div>
</div>
<div class="sect2">
<h3 id="api-de-sécurité-de-symfony"><a class="anchor" href="#api-de-sécurité-de-symfony"></a>API de sécurité de symfony</h3>
<div class="paragraph">
<p>Symfony intégre, via  le composant <code>symfony/security-bundle</code>, les mécanismes de sécurité propres au web.</p>
</div>
<div class="paragraph">
<p>Vous vous reférerez au tutoriel <a href="https://symfony.com/doc/current/security.html" class="bare">https://symfony.com/doc/current/security.html</a>, en ne traitant que le cas d&#8217;une
authentification d&#8217;utilisateurs en mémoire (ce sera suffisant pour démarrer le projet) :</p>
</div>
</div>
<div class="sect2">
<h3 id="travaux-pratiques-3"><a class="anchor" href="#travaux-pratiques-3"></a>Travaux pratiques</h3>
<div class="paragraph">
<p>Durée moyenne : 4H (tutoriel et manipulation) 2H (TP)</p>
</div>
<div class="paragraph">
<p>Sur la base de la gestion de produits (tutoriels précédents)</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic" start="1">
<li>
<p>Protéger l&#8217;accès à la modification de produits aux utilisateurs ayant comme rôle EDITEUR</p>
</li>
<li>
<p>Seuls les ADMIN peuvent créer, modifier et suprimer des produits</p>
</li>
<li>
<p>Une personne connectée peut à tout moment se déconnecter.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="liaison-entre-entités"><a class="anchor" href="#liaison-entre-entités"></a>Liaison entre Entités</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="produits-et-catégories-liaison-entre-objets-métier"><a class="anchor" href="#produits-et-catégories-liaison-entre-objets-métier"></a>Produits et Catégories (Liaison entre objets métier)</h3>
<div class="paragraph">
<p>Nous venons de voir les concepts d'`Entity` et d'`EntityRepository` associé à <code>Doctrine</code>.</p>
</div>
<div class="paragraph">
<p>L&#8217;étape suivante consiste à étudier les liaisons type entre entités.</p>
</div>
<div class="paragraph">
<p>En effet, tout comme les classes techniques (array, string, &#8230;&#8203;) un classe métier n&#8217;est jamais seule,
mais liée à d&#8217;autres classe métier par des liaisons de type <code>ManyToOne</code>- <code>OneToMany</code>, <code>ManyToMany</code> et OneToOne.</p>
</div>
<div class="paragraph">
<p>Suivre ce tutoriel qui introduit ces concepts et fait suite au précédent : <a href="https://symfony.com/doc/current/doctrine/associations.html" class="bare">https://symfony.com/doc/current/doctrine/associations.html</a> (~2h)</p>
</div>
<div class="sect3">
<h4 id="travaux-pratiques-4"><a class="anchor" href="#travaux-pratiques-4"></a>Travaux pratiques</h4>
<div class="paragraph">
<p>Durée moyenne 4h</p>
</div>
<div class="paragraph">
<p>On considère qu&#8217;un produit (classe <code>Product</code>) appratient forcément
à une catégorie (classe <code>Category</code>).</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic" start="1">
<li>
<p>Pour les besoins de l&#8217;exercice suivant, concevoir un contrôleur (route : <code>/category/populate</code>) qui injecte dans la base de données
une dizaine de catégories (la gestion CRUD des catégories n&#8217;est pas demandée).</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
CONTRAINTE : Le contrôleur n&#8217;appliquera sa fonction qu si le nombre actuel de catégories est inférieur au nombre qu&#8217;il compte injecter !
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Permettre à l&#8217;utilisateur de consulter et gérer les produits d&#8217;une catégorie donnée.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Faire évoluer votre gestion précédente CRUD sur Product
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="liaisons-types-entre-entités-illustrées-avec-uml"><a class="anchor" href="#liaisons-types-entre-entités-illustrées-avec-uml"></a>Liaisons types entre Entités illustrées avec UML</h3>
<div class="paragraph">
<p>Nous nous plaçons dans le cas d&#8217;une application exploitant des données stockées
par un système de gestion de bases de données relationnel (SGBDR).</p>
</div>
<div class="paragraph">
<p>Voici le schéma relationnel de la base de données utilisé.
« world » est une base de données statistiques géo-politiques sur le monde datant de 2006,
d&#8217;après <a href="http://www.stat.fi/tup/maanum/index_en.html">Official Statistics of Finland</a>.</p>
</div>
<div class="paragraph">
<div class="title">Schéma Relationnel de la base de données World</div>
<p><span class="image"><img src="images/SR-World.png" alt="SR-World.png" width="400"></span></p>
</div>
<div class="paragraph">
<p>Les données seront exploitées, par la logique applicative, sous forme de <em>Classe</em>, plus précisément :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Classe &#8592;&#8594; Table</p>
</li>
<li>
<p>Objet &#8592;&#8594; Ligne</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cette façon de faire permet de mettre le <em>domaine métier</em> <strong>au coeur de la logique de l&#8217;application</strong>.
Voici une analyse du modèle : les classes "métier" ("entity")</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diagram-classes.png" alt="Diagramme d&#8217;analyse UML (les entités du domaine)" width="271" height="288">
</div>
<div class="title">Diagramme d&#8217;analyse UML (les entités du domaine)</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Les données de la base seront exploitées par l&#8217;intermédiaire
d&#8217;objets (instances de classes métier)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Pour aider le travail de l&#8217;ORM Doctrine (<em>Object Relational Mapping</em>), la défintion des entités intégre des directives de mapping sous forme d'<strong>annotations</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="classe-métier-et-table"><a class="anchor" href="#classe-métier-et-table"></a>Classe métier et table</h3>
<div class="paragraph">
<p>Dans ce qui suit, afin de bien distinguer ce qui de l&#8217;ordre du
modèle de persistance (tables du schéma relationnel) et
du modèle métier (les classes entité), nous nommerons les éléments
du modèle métier en <strong>langue française</strong>.</p>
</div>
<div class="paragraph">
<p>Ainsi la classe entité qui mappe la table <code>Country</code> s&#8217;appellera <code>Pays</code>, <code>Language</code> → <code>Langue</code>,
 <code>CountryLanguage</code> → <code>PaysLangue</code>, <code>City</code> → <code>Ville</code>.</p>
</div>
<div class="sect3">
<h4 id="manytoone"><a class="anchor" href="#manytoone"></a>ManyToOne</h4>
<div class="paragraph">
<p>Exemple du <strong>point de vue de la table <code>City</code></strong> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Une ville est située dans un et un seul pays (One = 1..1)</p>
</li>
<li>
<p>Plusieurs villes peuvent être reliées au même pays (Many = 0..*)_</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="côté-schéma-relationnel"><a class="anchor" href="#côté-schéma-relationnel"></a>Côté Schéma Relationnel</h5>
<div class="paragraph">
<p>La relation, partant de <code>City</code>, est <strong>ManyToOne</strong> (symbole UML de plusieurs vers un):</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/many-to-one-sr.png" alt="many-to-one-sr"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="côté-classe-métier-classe-entity"><a class="anchor" href="#côté-classe-métier-classe-entity"></a>Côté classe métier (classe Entity)</h5>
<div class="ulist">
<ul>
<li>
<p>Les identifiants ne sont pas montrés</p>
</li>
<li>
<p>Les liaisons sont représentées par des associations (rappel : une association est l&#8217;expression d&#8217;un lien en objets)</p>
</li>
<li>
<p>les rôles sont précisés (optionnel si trivial comme ici)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/many-to-one-metier.png" alt="many-to-one-metier"></span></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
L&#8217;attribut <code>$pays</code> est de type <code>Pays</code> (et non integer !) car il est
une référence potentielle à un objet <code>Pays</code>.
La notion de lien-bidirectionnel est vue dans le paragraphe suivant.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="onetomany"><a class="anchor" href="#onetomany"></a>OneToMany</h4>
<div class="paragraph">
<p>Exemple du <strong>point de vue de la table <code>Country</code></strong>  :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Un <code>Pays</code> est référençable par plusieurs instances de <code>Ville</code>  (Many = 0..*)</p>
</li>
<li>
<p>Un <code>Pays</code> a l&#8217;exclusivité des villes qui le référencent (One = 1..1)</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="côté-schéma-relationnel-2"><a class="anchor" href="#côté-schéma-relationnel-2"></a>Côté Schéma Relationnel</h5>
<div class="paragraph">
<p>La relation, partant de <code>Country</code>, est <strong>OneToMany</strong> (de un vers plusieurs)</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/one-to-many-sr.png" alt="one-to-many-sr"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="côté-modèle-métier"><a class="anchor" href="#côté-modèle-métier"></a>Côté modèle métier</h5>
<div class="paragraph">
<p><span class="image"><img src="images/one-to-many-metier.png" alt="one-to-many-metier" width="550"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>L&#8217;attribut d&#8217;instance <code>$villes</code> est de type <code>collection de Ville</code></p>
</li>
<li>
<p>La valeur de <code>mappedBy</code> est l&#8217;attribut d&#8217;instance responsable de la liaison <code>One</code> du côté opposé (c&#8217;est grâce à lui que l&#8217;ensemble
des villes de l&#8217;instance courante de <code>Pays</code> pourra être constitué)</p>
</li>
<li>
<p>Côté <code>Ville</code>, en renseignant la valeur de <code>inversedBy</code> on précise que c&#8217;est <code>Ville</code>
qui est responsable (owner = lien actif) de la cohérence bidirectionnelle (sur ce sujet, voir  plus bas, chapitre lien-bidirectionnel)</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
L&#8217;usage de <strong>mappedBy</strong> et <strong>inversedBy</strong> signifie qu&#8217;il s&#8217;agit du <strong>même lien</strong> entre objet, donc de la <strong>même</strong> association dans le modèle d&#8217;analyse métier UML.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="onetoone"><a class="anchor" href="#onetoone"></a>OneToOne</h4>
<div class="ulist">
<ul>
<li>
<p>Un pays a au plus une capitale (une Ville)</p>
</li>
<li>
<p>Seules certaines villes sont capitales d&#8217;un pays.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="côté-schéma-relationnel-3"><a class="anchor" href="#côté-schéma-relationnel-3"></a>Côté Schéma Relationnel</h5>
<div class="ulist">
<ul>
<li>
<p>La relation entre <code>Country</code> et <code>City</code>, est <strong>OneToOne</strong>
<span class="image"><img src="images/one-to-one-sr.png" alt="one-to-one-sr"></span></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="côté-modèle-métier-2"><a class="anchor" href="#côté-modèle-métier-2"></a>Côté modèle métier</h5>
<div class="ulist">
<ul>
<li>
<p>C&#8217;est le <code>Pays</code> qui connaît sa <strong>capitale</strong>, le lien inverse serait trop souvent non valorisé, nous appliquons un lien <strong>uni-directionnel</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/one-to-one-metier.png" alt="one-to-one-metier"></span></p>
</div>
<div class="paragraph">
<p>Remarque 1 : le <strong>rôle</strong> d&#8217;une instance de Ville dans cette association est d&#8217;être une <strong>capitale</strong>. Ce rôle n&#8217;étant pas trivial (ne peut être deviné à la lecture du diagramme), nous le précisons. Le nommage de l&#8217;attribut d&#8217;instance de Ville dans pays est alors tout trouvé.</p>
</div>
<div class="paragraph">
<p>Remarque 2: le lien uni-directionnel spécifie le sens de la navigation possible (de <code>Pays</code> vers <code>Ville</code>)</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="manytoone-onetomany-lien-bidirectionnel"><a class="anchor" href="#manytoone-onetomany-lien-bidirectionnel"></a>ManyToOne-OneToMany : Lien bidirectionnel</h4>
<div class="paragraph">
<p>Lorsque l&#8217;on traite une association navigable dans les 2 sens (lien bidirectionnel), il faut assurer sa cohérence après le chargement des objets. Exemple :
Si une ville nouvellement créée se déclare appartenir à un pays,
ce dernier devra alors l&#8217;avoir dans sa liste de ses villes, et inversement !.
Par convention, c&#8217;est l&#8217;objet qui est au plus prêt du lien <strong>One</strong> qui se charge de la cohérence.
Dans notre exemple ce sera <code>Ville</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"> <span class="comment">/**
  * Ville
  *
  * @ORM\Table(name=&quot;City&quot;)
  * @ORM\Entity(repositoryClass=&quot;Acme\DemoBundle\Entity\VilleRepository&quot;)
  */</span>
 <span class="keyword">class</span> <span class="class">Ville</span>
 {

 . . .

     <span class="comment">/**
      * Set pays
      *
      * @param \Acme\DemoBundle\Entity\Pays $pays
      * @return Ville
      */</span>
     <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setPays</span>(\<span class="constant">Acme</span>\<span class="constant">DemoBundle</span>\<span class="constant">Entity</span>\<span class="constant">Pays</span> <span class="local-variable">$pays</span> = <span class="predefined-constant">null</span>)
     {
       <span class="keyword">if</span> (<span class="local-variable">$this</span>-&gt;pays) {
          <span class="local-variable">$this</span>-&gt;<span class="local-variable">$pays</span>-&gt;removeVille(<span class="local-variable">$this</span>);
        }
        <span class="local-variable">$this</span>-&gt;pays = <span class="local-variable">$pays</span>;
        <span class="local-variable">$pays</span>-&gt;addVille(<span class="local-variable">$this</span>);
        <span class="keyword">return</span> <span class="local-variable">$this</span>;
     }</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Attention : Il ne faut pas abuser des liens bidirectionnels ! Car comme vous l&#8217;avez constaté, les objets du domaine sont plus délicats à programmer. Parmi les premiers Best Practices de Doctrine, on peut lire :
     	Il est important de limiter les relations autant que possible. Cela signifie:
     Imposer un sens de parcours (éviter associations bidirectionnelles si possible)
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Cette limitation n&#8217;est pas applicable à tous les ORMs (<em>hibernate</em> par exemple)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Éliminer les associations non essentielles offre plusieurs avantages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Couplage réduit dans votre modèle de domaine</p>
</li>
<li>
<p>Code plus simple dans votre modèle de domaine (pas besoin de maintenir la bi-directionnalité correctement)</p>
</li>
<li>
<p>Moins de travail pour L’ORM (Doctrine)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Voir plus loin : <a href="http://docs.doctrine-project.org/en/latest/reference/best-practices.html" class="bare">http://docs.doctrine-project.org/en/latest/reference/best-practices.html</a></p>
</div>
</div>
<div class="sect3">
<h4 id="association-bidirectionnelle-owner-side-and-inverse-side"><a class="anchor" href="#association-bidirectionnelle-owner-side-and-inverse-side"></a>Association bidirectionnelle : Owner side and Inverse side</h4>
<div class="paragraph">
<p>Libre traduction de : <a href="http://docs.doctrine-project.org/en/2.0.x/reference/association-mapping.html" class="bare">http://docs.doctrine-project.org/en/2.0.x/reference/association-mapping.html</a></p>
</div>
<div class="paragraph">
<p>Lorsque l&#8217;on utilise une relation bidirectionnelle, il est important de bien comprendre le concept de owner (propriétaire) et d&#8217;inverse.</p>
</div>
<div class="paragraph">
<p>Une relation bidirectionnelle dans le modèle objet est implémentée par 2 références, qui représentent la même association, mais peuvent techniquement changer indépendamment l&#8217;une de l&#8217;autre et le développeur doit s&#8217;assurer que la cohérence métier est maintenue lors de manipulation de ces références.</p>
</div>
<div class="paragraph">
<p>Techniquement, Doctrine a besoin de savoir laquelle de ces 2 références mémoire (les instance qu&#8217;elles pointent) doit être persistée et laquelle non. C&#8217;est pourquoi le concept de owning/inverse est principalement utilisé. Tout changement de valeur côté inverse sera ignoré (pas d&#8217;impact dans la base de donnée).</p>
</div>
<div class="paragraph">
<p>Les règles générales suivantes s&#8217;appliquent :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Une relation bidirectionnelle a deux extrémités : le côté propriétaire (owner - partie active de la relation) et le côté inverse (inverse).</p>
</li>
<li>
<p>Le côté <strong>propriétaire</strong> d&#8217;une relation détermine les opérations de mises à jour dans la base de données.</p>
</li>
<li>
<p>Le côté <strong>propriétaire</strong> d&#8217;une relation bidirectionnelle doit référencer le <strong>côté inverse</strong> par l&#8217;usage de l&#8217;attribut <strong>inversedBy</strong> lors de la déclaration du mapping OneToOne, ManyToOne, ou ManyToMany. L&#8217;attribut inversedBy désigne le champ (l&#8217;attribut d&#8217;instance) de l&#8217;entité inverse de la relation.</p>
</li>
<li>
<p>Le côté inverse d&#8217;une relation bidirectionnelle doit référencer son <strong>côté propriétaire</strong> par l&#8217;usage de l&#8217;attribut <strong>mappedBy</strong> lors de la déclaration du mapping OneToOne, OneToMany, ou ManyToMany. L&#8217;attribut mappedBy désigne le champ (l&#8217;attribut d&#8217;instance) de l&#8217;entité propriétaire de la relation.</p>
</li>
<li>
<p>Le côté many de la relation bidirectionnelle OneToMany/ManyToOne doit être le côté propriétaire.</p>
</li>
<li>
<p>Une relation unidirectionnelle a seulement un côté propriétaire.</p>
</li>
<li>
<p>Concernant la relation bidirectionnelle OneToOne, le propriétaire correspond au côté qui mappe la table disposant de la clé étrangère en question (@JoinColumn(s)).</p>
</li>
<li>
<p>Concernant la relation bidirectionnelle ManyToMany chacune des extrémités peut être le propriétaire : Le propriétaire est déterminé
par le fait qu&#8217;il définit la jointure - @JoinTable <strong>ou</strong> s&#8217;il ne fait pas usage de l&#8217;attribut mappedBy.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Les concepts de <em>propriétaire/inverse</em> <strong>ne sont pas</strong> des concepts métier, mais techniques (la relation propriétaire—inverse n&#8217;a pas de sens métier).
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="manytomany-porteuse-de-propriétés"><a class="anchor" href="#manytomany-porteuse-de-propriétés"></a>ManyToMany - porteuse de propriétés</h3>
<div class="ulist">
<ul>
<li>
<p>Pour un pays donné, plusieurs langues sont parlées (dont une est officielle)</p>
</li>
<li>
<p>Une langue est parlée dans plusieurs pays.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="côté-schéma-relationnel-4"><a class="anchor" href="#côté-schéma-relationnel-4"></a>Côté Schéma Relationnel</h4>
<div class="paragraph">
<p><code>CountryLanguage</code> est une <em>table de liaison</em>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/many-to-many-sr-porteuse.png" alt="many-to-many-sr-porteuse"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="côté-modèle-metier"><a class="anchor" href="#côté-modèle-metier"></a>Côté modèle metier</h4>
<div class="paragraph">
<p>Nous avons 3 classes. Deux options s&#8217;offre à nous, qui dépend de l&#8217;approche
Primauté du Schéma Relationnel sur le modèle objet
Primauté de l&#8217;Objet sur le Schéma Relationnel.</p>
</div>
<div class="paragraph">
<p>Dans le premier cas nous avons la solution suivante :</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/many-to-many-metier-porteuse-1.png" alt="many-to-many-metier-porteuse-1"></span></p>
</div>
<div class="paragraph">
<p>En UML, une classe-association peut aussi être représentée comme une
classe ordinaire reliée à une association <strong>ManyToMany</strong> porteuse d&#8217;attributs, comme ici :</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/many-to-many-metier-porteuse-2.png" alt="many-to-many-metier-porteuse-2"></span></p>
</div>
<div class="paragraph">
<p>Exemple d&#8217;opération CREATE (d&#8217;ajout d&#8217;une langue non officielle à un pays) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="comment">// pour initialiser une classe association, on reconstitue les</span>
     <span class="comment">// élements de sa clé : ici un objet Langue et un objet Pays.</span>
     <span class="local-variable">$lePays</span> = <span class="local-variable">$this</span>-&gt;getDoctrine()
            -&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">AcmeDemoBundle:Pays</span><span class="delimiter">'</span></span>)
            -&gt;findOneByName(<span class="string"><span class="delimiter">'</span><span class="content">France</span><span class="delimiter">'</span></span>);

            <span class="local-variable">$laLangue</span> = <span class="local-variable">$this</span>-&gt;getDoctrine()
            -&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">AcmeDemoBundle:Langue</span><span class="delimiter">'</span></span>)
            -&gt;findOneByName(<span class="string"><span class="delimiter">'</span><span class="content">Danish</span><span class="delimiter">'</span></span>);


            <span class="keyword">if</span> (!<span class="local-variable">$lePays</span> || !<span class="local-variable">$laLangue</span>)
                    <span class="keyword">throw</span> <span class="local-variable">$this</span>-&gt;createNotFoundException(
                                    <span class="string"><span class="delimiter">'</span><span class="content">Pb de récupération d</span><span class="char">\'</span><span class="content">instance</span><span class="delimiter">'</span></span>
                    );

     <span class="comment">// création de l'instance de la classe association</span>
            <span class="local-variable">$pl</span> = <span class="keyword">new</span> <span class="constant">PaysLangue</span>();
            <span class="local-variable">$pl</span>-&gt;setLangue(<span class="local-variable">$laLangue</span>);
            <span class="local-variable">$pl</span>-&gt;setPays(<span class="local-variable">$lePays</span>);

     <span class="comment">// puis initialisation de ses attributs portés</span>
            <span class="local-variable">$pl</span>-&gt;setOfficiel(<span class="predefined-constant">false</span>);

     <span class="comment">// et sauvegarder le tout</span>
            <span class="local-variable">$em</span> = <span class="local-variable">$this</span>-&gt;getDoctrine()-&gt;getManager();
            <span class="local-variable">$em</span>-&gt;persist(<span class="local-variable">$pl</span>);
            <span class="local-variable">$em</span>-&gt;<span class="predefined">flush</span>();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Exemple d&#8217;opération RETREIVE (observez la différence d&#8217;expression de la clé) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="local-variable">$pl</span> = <span class="local-variable">$this</span>-&gt;getDoctrine()
      -&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">AcmeDemoBundle:PaysLangue</span><span class="delimiter">'</span></span>)
      -&gt;find(<span class="predefined">array</span>(
          <span class="string"><span class="delimiter">&quot;</span><span class="content">pays</span><span class="delimiter">&quot;</span></span>  =&gt; <span class="local-variable">$lePays</span>-&gt;getId(),
          <span class="string"><span class="delimiter">&quot;</span><span class="content">langue</span><span class="delimiter">&quot;</span></span>=&gt; <span class="local-variable">$laLangue</span>-&gt;getId()));</code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;exploitation en consultation (<code>RETREIVE</code>) de données de type <code>ManyToMany</code> amène naturellement à recueillir une collections d&#8217;objets (un ensemble de lignes d&#8217;un point de vue relationnel).</p>
</div>
<div class="paragraph">
<p>Par exemple, nous souhaitons connaître l&#8217;ensemble des langues parlées (enfin référencées) pour un pays donné.</p>
</div>
<div class="paragraph">
<p>Nous pouvons définir une méthode dans <code>PaysRepository</code>. qui retourne les langues en question (des instances de PaysLangue pour avoir les propriétés portées). Voici un exemple de service attendu :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php">        <span class="local-variable">$lesLangues</span> = <span class="local-variable">$this</span>-&gt;getDoctrine()
            -&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">AcmeDemoBundle:Pays</span><span class="delimiter">'</span></span>)
            -&gt;findAllLangues(<span class="local-variable">$lePays</span>-&gt;getId());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Un exemple d&#8217;implémentation de <code>findAllLangues</code> !</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="comment">// on demande aussi de remonter le pays et la langue</span>
<span class="comment">// (à cause du lazy loading)</span>
<span class="keyword">public</span> <span class="keyword">function</span> <span class="function">findAllLangues</span>(<span class="local-variable">$idPays</span>){
   <span class="local-variable">$em</span> = <span class="local-variable">$this</span>-&gt;getEntityManager();
   <span class="local-variable">$q</span> = <span class="local-variable">$em</span>-&gt;createQuery(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT pl, p, lg FROM AcmeDemoBundle:PaysLangue pl </span><span class="delimiter">&quot;</span></span>
           .  <span class="string"><span class="delimiter">&quot;</span><span class="content"> JOIN pl.pays p</span><span class="delimiter">&quot;</span></span>
           .  <span class="string"><span class="delimiter">&quot;</span><span class="content"> JOIN pl.langue lg</span><span class="delimiter">&quot;</span></span>
           .  <span class="string"><span class="delimiter">&quot;</span><span class="content"> WHERE p.id = :idp</span><span class="delimiter">&quot;</span></span>);
   <span class="local-variable">$q</span>-&gt;setParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">idp</span><span class="delimiter">&quot;</span></span>, <span class="local-variable">$idPays</span>);
   <span class="keyword">return</span> <span class="local-variable">$q</span>-&gt;getResult();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dans un contrôleur :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"> <span class="local-variable">$lesLangues</span> = <span class="local-variable">$this</span>-&gt;getDoctrine()
            -&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">AcmeDemoBundle:Pays</span><span class="delimiter">'</span></span>)
            -&gt;findAllLangues(<span class="local-variable">$lePays</span>-&gt;getId());

 <span class="comment">// puis passage des valeurs à la vue</span>
 <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;render(<span class="string"><span class="delimiter">'</span><span class="content">index/index.html.twig</span><span class="delimiter">'</span></span>, <span class="predefined">array</span>(<span class="string"><span class="delimiter">'</span><span class="content">lePays</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$lePays</span>,
                <span class="string"><span class="delimiter">'</span><span class="content">formulaire</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$form</span>-&gt;createView(),
                        <span class="string"><span class="delimiter">'</span><span class="content">lesLangues</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$lesLangues</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dans la vue</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"> <span class="tag">&lt;hr&gt;</span> <span class="tag">&lt;h4&gt;</span>Les principales langues parlées ici<span class="tag">&lt;/h4&gt;</span>
 <span class="tag">&lt;ul&gt;</span>
   {% for lg in lesLangues %}
     <span class="tag">&lt;li&gt;</span> {{ lg.langue.name }} <span class="tag">&lt;/li&gt;</span>
   {% endfor %}
<span class="tag">&lt;/ul&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="alternative-à-la-classe-association"><a class="anchor" href="#alternative-à-la-classe-association"></a>Alternative à la classe association</h3>
<div class="paragraph">
<p>Une alternative à la classe association est de la considérer comme une classe ordinaire (liée à une table ordinaire), avec un id propre, et relayer la contrainte de clé composite à la couche applicative.</p>
</div>
<div class="paragraph">
<p>On peut cependant demander au système de persistance de prendre en compte la contrainte d&#8217;unicité (rôle d&#8217;une table de liaison) en déclarant cette contrainte sur la clé composite candidate (usage de <code>UniqueConstraint</code> ci dessous):</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/classe-association-no.png" alt="classe-association-no"></span></p>
</div>
<div class="paragraph">
<p>Exemple de génération du schéma physique, cible MySQL :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> <span class="string"><span class="delimiter">`</span><span class="content">CountryLanguage</span><span class="delimiter">`</span></span> (
  <span class="string"><span class="delimiter">`</span><span class="content">id</span><span class="delimiter">`</span></span> <span class="predefined-type">int</span>(<span class="integer">11</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="directive">AUTO_INCREMENT</span>,
  <span class="string"><span class="delimiter">`</span><span class="content">IsOfficial</span><span class="delimiter">`</span></span> <span class="predefined-type">tinyint</span>(<span class="integer">1</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
  <span class="string"><span class="delimiter">`</span><span class="content">idCountry</span><span class="delimiter">`</span></span> <span class="predefined-type">int</span>(<span class="integer">11</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
  <span class="string"><span class="delimiter">`</span><span class="content">idLanguage</span><span class="delimiter">`</span></span> <span class="predefined-type">int</span>(<span class="integer">11</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
  <span class="directive">PRIMARY</span> <span class="type">KEY</span> (<span class="string"><span class="delimiter">`</span><span class="content">id</span><span class="delimiter">`</span></span>),
  <span class="directive">UNIQUE</span> <span class="type">KEY</span> <span class="string"><span class="delimiter">`</span><span class="content">review_unique_by_pays_lang</span><span class="delimiter">`</span></span> (<span class="string"><span class="delimiter">`</span><span class="content">idCountry</span><span class="delimiter">`</span></span>,<span class="string"><span class="delimiter">`</span><span class="content">idLanguage</span><span class="delimiter">`</span></span>),
  <span class="type">KEY</span> <span class="string"><span class="delimiter">`</span><span class="content">IDX_186C946D43CAA294</span><span class="delimiter">`</span></span> (<span class="string"><span class="delimiter">`</span><span class="content">idCountry</span><span class="delimiter">`</span></span>),
  <span class="type">KEY</span> <span class="string"><span class="delimiter">`</span><span class="content">IDX_186C946D87785BEE</span><span class="delimiter">`</span></span> (<span class="string"><span class="delimiter">`</span><span class="content">idLanguage</span><span class="delimiter">`</span></span>),
  <span class="type">CONSTRAINT</span> <span class="string"><span class="delimiter">`</span><span class="content">FK_186C946D43CAA294</span><span class="delimiter">`</span></span>
      <span class="directive">FOREIGN</span> <span class="type">KEY</span> (<span class="string"><span class="delimiter">`</span><span class="content">idCountry</span><span class="delimiter">`</span></span>) <span class="keyword">REFERENCES</span> <span class="string"><span class="delimiter">`</span><span class="content">Country</span><span class="delimiter">`</span></span> (<span class="string"><span class="delimiter">`</span><span class="content">id</span><span class="delimiter">`</span></span>),
  <span class="type">CONSTRAINT</span> <span class="string"><span class="delimiter">`</span><span class="content">FK_186C946D87785BEE</span><span class="delimiter">`</span></span>
      <span class="directive">FOREIGN</span> <span class="type">KEY</span> (<span class="string"><span class="delimiter">`</span><span class="content">idLanguage</span><span class="delimiter">`</span></span>) <span class="keyword">REFERENCES</span> <span class="string"><span class="delimiter">`</span><span class="content">Language</span><span class="delimiter">`</span></span> (<span class="string"><span class="delimiter">`</span><span class="content">id</span><span class="delimiter">`</span></span>)
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Autre exemple (<a href="http://doctrine-orm.readthedocs.org/en/latest/reference/annotations-reference.html" class="bare">http://doctrine-orm.readthedocs.org/en/latest/reference/annotations-reference.html</a>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="comment">/**
 * Vote : when a user vote for a question
 *
 * @ORM\Table(name=&quot;vote&quot;,
  uniqueConstraints={@UniqueConstraint(name=&quot;only_one_vote&quot;,
  columns={&quot;id_user&quot;, &quot;id_question&quot;})}),
   indexes={@Index(name=&quot;question_idx&quot;, columns={&quot;id_question&quot;})})
 * @ORM\Entity(repositoryClass=&quot;AppBundle\Entity\VoteRepository&quot;)
 * @UniqueEntity(fields={&quot;user&quot;, &quot;question&quot;},message=&quot;vote.userquestion&quot;)
 */</span>
<span class="keyword">class</span> <span class="class">Vote</span> {

  <span class="comment">/**
   * @var integer
   *
   * @ORM\Column(name=&quot;id&quot;, type=&quot;integer&quot;)
   * @ORM\Id
   * @ORM\GeneratedValue(strategy=&quot;AUTO&quot;)
   */</span>
  <span class="keyword">private</span> <span class="local-variable">$id</span>;

  <span class="comment">/**
   * question
   * @ORM\ManyToOne(targetEntity=&quot;Question&quot;)
   * @ORM\JoinColumn(name=&quot;id_question&quot;, referencedColumnName=&quot;id&quot;)
   */</span>
  <span class="keyword">private</span> <span class="local-variable">$question</span>;

  <span class="comment">/**
   * user
   * @ORM\ManyToOne(targetEntity=&quot;User&quot;)
   * @ORM\JoinColumn(name=&quot;id_user&quot;, referencedColumnName=&quot;id&quot;)
   */</span>
  <span class="keyword">private</span> <span class="local-variable">$user</span>;

  <span class="comment">/**
   * @var int
   *
   * @ORM\Column(name=&quot;value&quot;, type=&quot;integer&quot;)
   */</span>
  <span class="keyword">private</span> <span class="local-variable">$value</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Voici le schéma créé :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> <span class="string"><span class="delimiter">`</span><span class="content">vote</span><span class="delimiter">`</span></span> (
  <span class="string"><span class="delimiter">`</span><span class="content">id</span><span class="delimiter">`</span></span> <span class="predefined-type">int</span>(<span class="integer">11</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="directive">AUTO_INCREMENT</span>,
  <span class="string"><span class="delimiter">`</span><span class="content">id_question</span><span class="delimiter">`</span></span> <span class="predefined-type">int</span>(<span class="integer">11</span>) <span class="directive">DEFAULT</span> <span class="predefined-constant">NULL</span>,
  <span class="string"><span class="delimiter">`</span><span class="content">id_user</span><span class="delimiter">`</span></span> <span class="predefined-type">int</span>(<span class="integer">11</span>) <span class="directive">DEFAULT</span> <span class="predefined-constant">NULL</span>,
  <span class="string"><span class="delimiter">`</span><span class="content">value</span><span class="delimiter">`</span></span> <span class="predefined-type">int</span>(<span class="integer">11</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
  <span class="directive">PRIMARY</span> <span class="type">KEY</span> (<span class="string"><span class="delimiter">`</span><span class="content">id</span><span class="delimiter">`</span></span>),
  <span class="directive">UNIQUE</span> <span class="type">KEY</span> <span class="string"><span class="delimiter">`</span><span class="content">only_one_vote</span><span class="delimiter">`</span></span> (<span class="string"><span class="delimiter">`</span><span class="content">id_user</span><span class="delimiter">`</span></span>,<span class="string"><span class="delimiter">`</span><span class="content">id_question</span><span class="delimiter">`</span></span>),
  <span class="type">KEY</span> <span class="string"><span class="delimiter">`</span><span class="content">IDX_5A108564E62CA5DB</span><span class="delimiter">`</span></span> (<span class="string"><span class="delimiter">`</span><span class="content">id_question</span><span class="delimiter">`</span></span>),

  <span class="type">KEY</span> <span class="string"><span class="delimiter">`</span><span class="content">IDX_5A1085646B3CA4B</span><span class="delimiter">`</span></span> (<span class="string"><span class="delimiter">`</span><span class="content">id_user</span><span class="delimiter">`</span></span>),
  <span class="type">CONSTRAINT</span> <span class="string"><span class="delimiter">`</span><span class="content">FK_5A1085646B3CA4B</span><span class="delimiter">`</span></span> <span class="directive">FOREIGN</span> <span class="type">KEY</span> (<span class="string"><span class="delimiter">`</span><span class="content">id_user</span><span class="delimiter">`</span></span>) <span class="keyword">REFERENCES</span> <span class="string"><span class="delimiter">`</span><span class="content">fos_user</span><span class="delimiter">`</span></span> (<span class="string"><span class="delimiter">`</span><span class="content">id</span><span class="delimiter">`</span></span>),
  <span class="type">CONSTRAINT</span> <span class="string"><span class="delimiter">`</span><span class="content">FK_5A108564E62CA5DB</span><span class="delimiter">`</span></span> <span class="directive">FOREIGN</span> <span class="type">KEY</span> (<span class="string"><span class="delimiter">`</span><span class="content">id_question</span><span class="delimiter">`</span></span>) <span class="keyword">REFERENCES</span> <span class="string"><span class="delimiter">`</span><span class="content">question</span><span class="delimiter">`</span></span> (<span class="string"><span class="delimiter">`</span><span class="content">id</span><span class="delimiter">`</span></span>)
)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="méthodes-find-requêtes-assistées"><a class="anchor" href="#méthodes-find-requêtes-assistées"></a>Méthodes find* – Requêtes assistées</h3>
<div class="paragraph">
<p>Nous avons utilisé la méthode <strong>find</strong>, et quelques unes de ses variantes.
Cette méthode est définie dans la classe mère des repository : <code>EntityRepository</code>.
En effet, nos classes <code>Repository</code> <strong>héritent</strong> de cette classe technique. Exemple :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="keyword">class</span> <span class="class">PaysRepository</span> <span class="keyword">extends</span> <span class="constant">EntityRepository</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Voici une vue partielle sur l&#8217;API de <code>EntityRepository</code> : <a href="https://github.com/doctrine/doctrine2/blob/master/lib/Doctrine/ORM/EntityRepository.php">extrait API</a>
<span class="image"><img src="images/api-repository.png" alt="api-repository" width="600"></span></p>
</div>
<div class="paragraph">
<p>Voici des exemple de ces méthodes :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="local-variable">$repository</span>=<span class="local-variable">$this</span>-&gt;getDoctrine()-&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">AcmeDemoBundle:Pays</span><span class="delimiter">'</span></span>);

<span class="comment">// récupère tous les pays</span>
<span class="local-variable">$lesPays</span> = <span class="local-variable">$repository</span>-&gt;findAll();

<span class="comment">// récupère tous les pays ayant obtenu l'indépendance en 1960</span>
<span class="local-variable">$lesPays</span> = <span class="local-variable">$repository</span>-&gt;findBy(<span class="predefined">array</span>(<span class="string"><span class="delimiter">'</span><span class="content">indepYear</span><span class="delimiter">'</span></span>=&gt; <span class="integer">1960</span>));

<span class="comment">// récupère tous les pays (premier critère vide = prendre tout)</span>
<span class="comment">// trié sur l'attribut continent (attention, pas la colonne!)</span>
<span class="local-variable">$lesPays</span> = <span class="local-variable">$repository</span>-&gt;findBy(<span class="predefined">array</span>(), <span class="predefined">array</span>(<span class="string"><span class="delimiter">'</span><span class="content">continent</span><span class="delimiter">'</span></span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">ASC</span><span class="delimiter">'</span></span> ));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour des requêtes simples, basées sur des valeurs d&#8217;attributs (point de vue objet) – en référence à des valeurs de colonnes (du point de vue de la table)  –  le développeur a la  possibilité d&#8217;utiliser des méthodes dites <strong>magiques</strong> (<em>magic finders</em>).</p>
</div>
<div class="paragraph">
<p>Ce mécanisme <strong>s&#8217;appuie sur des conventions de nommage</strong> de méthodes
(sous la responsabilité du développeur) et sur la méthode <strong>__call</strong> de la
classe mère <code>Repository</code> qui transforme des appels de « méthodes magiques » en un
appel classique (nommant la bonne colonne). Les méthodes doivent commencer par <strong>findBy</strong> ou <strong>findOneBy</strong>,
on voit ici le traitement de cette convention :</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/method_magic.png" alt="method_magic mecanisme"></span></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<strong>findBy</strong>  retourne un tableau (éventuellement vide)
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<strong>findOneBy</strong>  retourne une référence à un objet (éventuellement null)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ainsi, pour retrouver tous les pays ayant obtenu l&#8217;indépendance en 1960,
nous pouvons simplifier l&#8217;appel comme ceci :</p>
</div>
<div class="paragraph">
<p>Exemple d&#8217;une méthode magique :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="comment">// récupère tous les pays ayant obtenu l'indépendance en 1960</span>
<span class="local-variable">$lesPays</span> = <span class="local-variable">$paysRepository</span>-&gt;findByIndepYear(<span class="integer">1960</span>);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>par du principe que la classe <code>Pays</code> a un attribut privé nommé <code>indepYear</code>, ou plus exactement une méthode nommée <code>getIndepYear</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Exemple d&#8217;une erreur de nommage :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="comment">// récupère tous les pays ayant obtenu l'indépendance en 1960</span>
<span class="local-variable">$lesPays</span> = <span class="local-variable">$paysRepository</span>-&gt;findByAnneeIndep(<span class="integer">1960</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>qui déclenche une erreur !</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/method_magic-error.png" alt="method_magic-error" width="600"></span></p>
</div>
<div class="paragraph">
<p>Ce qui est parfaitement normal, si l&#8217;attribut <code>anneeIndep</code> n&#8217;est pas un attribut de l&#8217;entité <code>Pays</code>.</p>
</div>
<div class="paragraph">
<p>Exemple d&#8217;utilisation de <em>findOneBy</em> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="comment">// récupère un pays par son nom</span>
 <span class="local-variable">$pays</span> = <span class="local-variable">$paysRepository</span>-&gt;findOneByName(<span class="string"><span class="delimiter">'</span><span class="content">Utopie</span><span class="delimiter">'</span></span>);
 <span class="keyword">if</span> (<span class="local-variable">$pays</span>)
  <span class="comment">// on peut toujours rêver...</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="requête-sql-pdo"><a class="anchor" href="#requête-sql-pdo"></a>Requête SQL PDO</h3>
<div class="paragraph">
<p>Exemple :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="comment">// src/Repository/ProductRepository.php</span>
<span class="comment">// ...</span>
<span class="keyword">public</span> <span class="keyword">function</span> <span class="function">findAllGreaterThanPrice</span>(<span class="local-variable">$price</span>): <span class="predefined">array</span>
{
  <span class="local-variable">$conn</span> = <span class="local-variable">$this</span>-&gt;getEntityManager()-&gt;getConnection();

  <span class="local-variable">$sql</span> = <span class="string"><span class="delimiter">'</span><span class="content">
        SELECT * FROM product p
        WHERE p.price &gt; :price
        ORDER BY p.price ASC
        </span><span class="delimiter">'</span></span>;
  <span class="local-variable">$stmt</span> = <span class="local-variable">$conn</span>-&gt;prepare(<span class="local-variable">$sql</span>);
  <span class="local-variable">$stmt</span>-&gt;execute([<span class="string"><span class="delimiter">'</span><span class="content">price</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$price</span>]);

  <span class="comment">// returns an array of arrays (i.e. a raw data set)</span>
  <span class="keyword">return</span> <span class="local-variable">$stmt</span>-&gt;fetchAll();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Avec ce type de requête SQL, nous obtenons en retour des lignes de données (<em>raw data</em>),
et non des objets (à moins d&#8217;utiliser la fonctionnilité <code>NativeQuery</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="méthodes-createnativequery-requêtes-natives"><a class="anchor" href="#méthodes-createnativequery-requêtes-natives"></a>Méthodes createNativeQuery – Requêtes natives</h3>
<div class="paragraph">
<p>Nous somme dans le cas où l&#8217;on souhaiterait appliquer directement des requêtes SQL.</p>
</div>
<div class="paragraph">
<p>Il peut arriver, et c&#8217;est souvent le cas lorsque l&#8217;on reprend un existant, de vouloir réutiliser des requêtes SQL présentes dans l&#8217;existant (cas de requêtes optimisées,  de requêtes complexes).</p>
</div>
<div class="paragraph">
<p>Pour cela nous utilisons la méthode <em>createNativeQuery</em> qui prend en argument la requête SQL classique et une référence à un objet de type <code>ResultSetMapping</code>. Cette dernière classe aide Doctrine à mapper les colonnes sur les bons attributs d&#8217;une classe result.</p>
</div>
<div class="paragraph">
<p>Exemple : Nous disposons d&#8217;une requête SQL qui nous retourne l&#8217;id et le nom de la langue officiel du pays d&#8217;id=73 :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">mysql&gt; <span class="class">SELECT</span> Language.id, Language.name <span class="keyword">FROM</span> Language,CountryLanguage,Country <span class="keyword">WHERE</span> Country.id = CountryLanguage.idCountry <span class="keyword">AND</span> Language.id = CountryLanguage.idLanguage <span class="keyword">AND</span> idCountry =<span class="integer">73</span> <span class="keyword">AND</span> CountryLanguage.Isofficial =<span class="string"><span class="delimiter">'</span><span class="content">T</span><span class="delimiter">'</span></span>;
+<span class="comment">----+--------+</span>
| id | name   |
+<span class="comment">----+--------+</span>
| <span class="integer">23</span> | French |
+<span class="comment">----+--------+</span>
<span class="integer">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="class">set</span> (<span class="float">0.00</span> sec)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous souhaitons réutiliser telle quelle cette requête
(celle que nous présentons pourrait être réalisée simplement en DQL – TODO à prouver !)</p>
</div>
<div class="paragraph">
<p>Voici une version possible (paramétrée sur l&#8217;id du pays) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="keyword">class</span> <span class="class">PaysLangueRepository</span> <span class="keyword">extends</span> <span class="constant">EntityRepository</span>{

  <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">findLangueOfficielle</span>(<span class="local-variable">$idPays</span>) {
        <span class="local-variable">$rsm</span> = <span class="keyword">new</span> <span class="constant">ResultSetMapping</span>;
        <span class="local-variable">$rsm</span>-&gt;addScalarResult(<span class="string"><span class="delimiter">'</span><span class="content">id</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">id</span><span class="delimiter">'</span></span>);
        <span class="local-variable">$rsm</span>-&gt;addScalarResult(<span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>);
        <span class="local-variable">$query</span> = <span class="local-variable">$this</span>-&gt;getEntityManager()-&gt;createNativeQuery(
              <span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT Language.id,Language.name
          FROM Language,CountryLanguage,Country
          WHERE Country.id = CountryLanguage.idCountry
          AND Language.id = CountryLanguage.idLanguage
          AND idCountry = ?
          AND CountryLanguage.Isofficial ='T'
            ORDER BY CountryLanguage.Percentage DESC</span><span class="delimiter">&quot;</span></span>
            ,<span class="local-variable">$rsm</span>);
        <span class="local-variable">$query</span>-&gt;setParameter(<span class="integer">1</span>, <span class="local-variable">$idPays</span>);
        <span class="local-variable">$langues</span> = <span class="local-variable">$query</span>-&gt;getResult();
        <span class="keyword">return</span> <span class="local-variable">$langues</span>[<span class="integer">0</span>]; <span class="comment">// prend la première langue...</span>
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette façon de faire s&#8217;appuie sur la méthode <em>addScalarResult</em> de l&#8217;objet <code>ResultSetMapping</code>.
La classe instanciée sera de type php objet : <code>stdclass</code></p>
</div>
<div class="paragraph">
<p>API :  addScalarResult</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="constant">Doctrine</span>\<span class="constant">ORM</span>\<span class="constant">Query</span>\<span class="constant">ResultSetMapping</span>::addScalarResult(<span class="predefined-type">string</span> <span class="local-variable">$columnName</span>, <span class="predefined-type">string</span> <span class="local-variable">$alias</span>, <span class="predefined-type">string</span> <span class="local-variable">$type</span>)
        <span class="constant">Adds</span> a scalar result mapping.
<span class="constant">Parameters</span>:
 * <span class="predefined-type">string</span> <span class="local-variable">$columnName</span> <span class="constant">The</span> name of the column in the <span class="constant">SQL</span> result set.
 * <span class="predefined-type">string</span> <span class="local-variable">$alias</span> <span class="constant">The</span> result alias with which the scalar result should
        be placed in the result structure.
 * <span class="predefined-type">string</span> <span class="local-variable">$type</span> <span class="constant">The</span> column type</code></pre>
</div>
</div>
<div class="paragraph">
<p>Une autre façon de faire est de mapper directement sur une entité métier de l&#8217;application :
Voici une version possible qui retournera une instance de <code>Langue</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="keyword">class</span> <span class="class">PaysLangueRepository</span> <span class="keyword">extends</span> <span class="constant">EntityRepository</span>{

  <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">findLangueOfficielle</span>(<span class="local-variable">$idPays</span>) {
        <span class="local-variable">$rsm</span> = <span class="keyword">new</span> <span class="constant">ResultSetMapping</span>;
        <span class="local-variable">$rsm</span>-&gt;addEntityResult(<span class="string"><span class="delimiter">'</span><span class="content">AcmeDemoBundle:Langue</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">lg</span><span class="delimiter">'</span></span>);
        <span class="local-variable">$rsm</span>-&gt;addFieldResult(<span class="string"><span class="delimiter">'</span><span class="content">lg</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">id</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">id</span><span class="delimiter">'</span></span>);
         <span class="local-variable">$rsm</span>-&gt;addFieldResult(<span class="string"><span class="delimiter">'</span><span class="content">lg</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>);
        <span class="local-variable">$query</span> = <span class="local-variable">$this</span>-&gt;getEntityManager()-&gt;createNativeQuery(
              <span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT Language.id,Language.name
          FROM Language,CountryLanguage,Country
          WHERE Country.id = CountryLanguage.idCountry
          AND Language.id = CountryLanguage.idLanguage
          AND idCountry = ?
          AND CountryLanguage.Isofficial ='T'
            ORDER BY CountryLanguage.Percentage DESC</span><span class="delimiter">&quot;</span></span>
            ,<span class="local-variable">$rsm</span>);
        <span class="local-variable">$query</span>-&gt;setParameter(<span class="integer">1</span>, <span class="local-variable">$idPays</span>);
        <span class="local-variable">$langues</span> = <span class="local-variable">$query</span>-&gt;getResult();
        <span class="keyword">return</span> <span class="local-variable">$langues</span>[<span class="integer">0</span>]; <span class="comment">// prend la première langue...</span>
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>API :  addFieldResult</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="constant">Doctrine</span>\<span class="constant">ORM</span>\<span class="constant">Query</span>\<span class="constant">ResultSetMapping</span>::addFieldResult(<span class="predefined-type">string</span> <span class="local-variable">$alias</span>, <span class="predefined-type">string</span> <span class="local-variable">$columnName</span>, <span class="predefined-type">string</span> <span class="local-variable">$fieldName</span>, <span class="predefined-type">string</span> <span class="local-variable">$declaringClass</span>)
<span class="constant">Adds</span> a field to the result that belongs to an entity <span class="keyword">or</span> joined entity.
<span class="constant">Parameters</span>:
* <span class="predefined-type">string</span> <span class="local-variable">$alias</span> <span class="constant">The</span> alias of the root entity <span class="keyword">or</span> joined entity to which the field belongs.
* <span class="predefined-type">string</span> <span class="local-variable">$columnName</span> <span class="constant">The</span> name of the column in the <span class="constant">SQL</span> result set.
* <span class="predefined-type">string</span> <span class="local-variable">$fieldName</span> <span class="constant">The</span> name of the field on the declaring <span class="keyword">class</span>.</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.1<br>
Last updated 2020-09-28 08:14:14 CEST
</div>
</div>
</body>
</html>