<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<meta name="description" content="Presentation de Symfony">
<meta name="author" content="Olivier Capuozzo">
<title>Symfony Introduction</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Symfony Introduction</h1>
<div class="details">
<span id="author" class="author">Olivier Capuozzo</span><br>
<span id="revnumber">version 1.0,</span>
<span id="revdate">2018-01-06</span>
<br><span id="revremark">Version asciidoc</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table des matieres</div>
<ul class="sectlevel1">
<li><a href="#présentation">Présentation</a></li>
<li><a href="#modèle-d-architecture-applicative">Modèle d&#8217;architecture applicative</a>
<ul class="sectlevel2">
<li><a href="#prérequis">Prérequis</a></li>
<li><a href="#création-d-une-application-symfony-et-vérification-des-pré-requis">Création d&#8217;une application symfony et vérification des pré-requis</a></li>
<li><a href="#démarrage-du-serveur-et-de-l-application">Démarrage du serveur et de l&#8217;application</a></li>
</ul>
</li>
<li><a href="#première-page-notion-de-vue-contrôleur">Première page : notion de Vue/Contrôleur</a>
<ul class="sectlevel2">
<li><a href="#rendu-par-une-logique-de-vue-archtecture-mvc">Rendu par une logique de vue (archtecture MVC)</a></li>
<li><a href="#template-de-base-de-l-application">Template de base de l&#8217;application</a></li>
</ul>
</li>
<li><a href="#gestion-des-données-d-entrée">Gestion des données d&#8217;entrée</a>
<ul class="sectlevel2">
<li><a href="#auto-injection-de-l-objet-request">Auto-injection de l&#8217;objet Request</a></li>
<li><a href="#données-implicites">Données implicites</a></li>
<li><a href="#données-explicites">Données explicites</a></li>
</ul>
</li>
<li><a href="#travaux-pratiques-1">Travaux Pratiques - 1 -</a>
<ul class="sectlevel2">
<li><a href="#premier-travail">Premier travail</a></li>
<li><a href="#migration-application-php-classique-vers-symfony">Migration application PHP classique vers Symfony</a></li>
<li><a href="#ressources-à-prendre-en-compte">Ressources à prendre en compte</a></li>
<li><a href="#annexe-tp-1-code-legacy-prototype">Annexe TP-1 - code legacy (prototype)</a></li>
</ul>
</li>
<li><a href="#introduction-au-model">Introduction au Model</a>
<ul class="sectlevel2">
<li><a href="#Éléments-d-architecture">Éléments d&#8217;architecture</a></li>
<li><a href="#premiers-pas-avec-le-model">Premiers pas avec le model</a></li>
<li><a href="#liaison-entre-entités-contexte-support">Liaison entre Entités - Contexte support</a></li>
<li><a href="#mappings-et-annotations">Mappings et annotations</a></li>
<li><a href="#exploitation-du-modèle-métier">Exploitation du modèle métier</a></li>
</ul>
</li>
<li><a href="#cas-du-formulaire">Cas du formulaire</a>
<ul class="sectlevel2">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#logique-de-traitement-du-formulaire">Logique de traitement du formulaire</a></li>
<li><a href="#logique-métier-du-formulaire">Logique métier du formulaire</a></li>
<li><a href="#rendu-du-formulaire">Rendu du formulaire</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="présentation"><a class="anchor" href="#présentation"></a>Présentation</h2>
<div class="sectionbody">
<div class="paragraph">
<p><span class="image"><img src="images/logo-symfony.svg" alt="logo symfony" title="Symfony"></span></p>
</div>
<div class="paragraph">
<p>Symfony est une solution créée par la société <a href="https://sensiolabs.com">Sensiolabs</a> qui en assure l&#8217;évolution,
assitée par de  <a href="https://symfony.com/contributors">nombreux contributeurs</a>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Symfony est un ensemble de Composants PHP, un framework pour les Applications Web, une Philosophie, et une Communauté — tous travaillant ensemble, en harmonie.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Symfony<br>
<cite>Qu'est-ce que Symfony ? par Sensiolabs - a french company</cite>
</div>
</div>
<div class="paragraph">
<p>Cette introduction se base sur les ressources documentaires de Symfony (version 4), afin d&#8217;en faciliter le premier accès à des étudiants
développeurs ayant eu un premier contact avec le développement web.</p>
</div>
<div class="paragraph">
<p>Pour réaliser les travaux pratiques, vous aurez besoin d&#8217;aller plus en profondeur sur la connaissance des composants.
La documentation Symfony est accessible ici : <a href="https://symfony.com/doc/current/index.html" class="bare">https://symfony.com/doc/current/index.html</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="modèle-d-architecture-applicative"><a class="anchor" href="#modèle-d-architecture-applicative"></a>Modèle d&#8217;architecture applicative</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Le modèle d&#8217;architecture des applications web est de type 3 tiers (clients, serveur, SBBD)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-d74203d94f4e533980e902e2ca12dd73.png" alt="Interaction type entre tiers d'une application web" width="393" height="283">
</div>
<div class="title">Figure 1. Interaction type entre tiers d&#8217;une application web</div>
</div>
<div class="paragraph">
<p>Les applications symfony se situent sur le tiers "server et applications" (derrière un serveur HTTP).</p>
</div>
<div class="paragraph">
<p>En environnement de développement, les développeurs PHP disposent du <code>PHP&#8217;s internal web server</code>, un serveur http intégré au langage lui-même,
ce qui assure un certain contrôle quant à la version de PHP utilisée lors de la phase de développement.</p>
</div>
<div class="paragraph">
<p>En environnement de production, l&#8217;application sera placée derrière un server Web de production, disposant d&#8217;une version de PHP conforme aux exigences du framework.
Les serveurs HTTP de production les plus courants sont <code>Apache</code> et <code>Nginx</code>.
Dans ce cas, reférez-vous aux consignes de configurations disponibles sur le site de symfony : <a href="https://symfony.com/doc/current/setup/web_server_configuration.html">web server configurations</a>.</p>
</div>
<div class="sect2">
<h3 id="prérequis"><a class="anchor" href="#prérequis"></a>Prérequis</h3>
<div class="sect3">
<h4 id="concernant-le-développeur"><a class="anchor" href="#concernant-le-développeur"></a>Concernant le développeur</h4>
<div class="ulist">
<ul>
<li>
<p>Avoir une première expérience avec la programmation orientée objet (POO)</p>
</li>
<li>
<p>Comprendre les principes de fonctionnement d&#8217;une interaction HTTP (protocole sans état, passage de valeurs)
et les problématiques et solutions autour de la gestion du suivi de sessions HTTP</p>
</li>
<li>
<p>Une certaine connaissance en interaction applicative avec un SGBD( R ) - (SQL)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="concernant-le-système"><a class="anchor" href="#concernant-le-système"></a>Concernant le système</h4>
<div class="paragraph">
<p>Les prérequis système dépendent de la version de symfony que vous comptez utliser.
On se réfèrera à <a href="https://symfony.com/doc/current/reference/requirements.html">Symfony Requirements</a>, en particulier :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La version minimale attendue de PHP (dépend de la version de Symfony)</p>
</li>
<li>
<p><a href="https://getcomposer.org/"><code>Composer</code></a> (outils de gestion des dépendances pour des projets PHP, vérifier sa présence sur votre système)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="création-d-une-application-symfony-et-vérification-des-pré-requis"><a class="anchor" href="#création-d-une-application-symfony-et-vérification-des-pré-requis"></a>Création d&#8217;une application symfony et vérification des pré-requis</h3>
<div class="paragraph">
<p>Ce sont des opérations qui s&#8217;effectuent en ligne de commande :</p>
</div>
<div class="literalblock">
<div class="title">Création d&#8217;un squelette d&#8217;application</div>
<div class="content">
<pre>composer create-project symfony/website-skeleton my-project</pre>
</div>
</div>
<div class="paragraph">
<p>Explications :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>composer <i class="conum" data-value="1"></i><b>(1)</b>
    create-project symfony/website-skeleton <i class="conum" data-value="2"></i><b>(2)</b>
         my-project <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>appel de la commande <code>composer</code> ou <code>composer.phar</code> selon le cas</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>premier et deuxième arguments pour créer un projet selon un modèle</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>le troisième est le nom du projet, et donc du <strong>sous-dossier</strong> qui sera <strong>créé</strong>
à partir de la racine courante (il est donc important de se placer dans un dossier de travail avant de lancer une telle commande)</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="démarrage-du-serveur-et-de-l-application"><a class="anchor" href="#démarrage-du-serveur-et-de-l-application"></a>Démarrage du serveur et de l&#8217;application</h3>
<div class="literalblock">
<div class="title">Activation du mode dev</div>
<div class="content">
<pre> $ cd your-project
 $ composer require server --dev</pre>
</div>
</div>
<div class="paragraph">
<p>Symfony fonctionne par composants, et il y en a un qui vérifie les prérequis, <code>Symfony Requirements Checker tool</code></p>
</div>
<div class="literalblock">
<div class="title">Installation du composant de vérification de la configuration système</div>
<div class="content">
<pre>$ cd your-project/
$ composer require requirements-checker</pre>
</div>
</div>
<div class="literalblock">
<div class="title">Demarrage du serveur</div>
<div class="content">
<pre>$ cd your-project
$ php bin/console server:run</pre>
</div>
</div>
<div class="paragraph">
<p>Une fois ce composant installé, votre application pourra être sollicitée
par la route <a href="http://localhost:8000/check.php" class="bare">http://localhost:8000/check.php</a>, dont voici le résultat attendu :</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/symfony-check.png" alt="check-configuration"></span></p>
</div>
<div class="paragraph">
<p>Après avoir réglé la situation, pour des questions de sécurité, ne pas oublier de supprimer cette fonctionnalité :</p>
</div>
<div class="literalblock">
<div class="title">Désinstallation du composant de vérification de la configuration système</div>
<div class="content">
<pre> cd your-project/
 composer remove requirements-checker</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Vérifier les prerequis système est une des premières actions à réaliser lors de la phase de déploiement sur un serveur de production !
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="première-page-notion-de-vue-contrôleur"><a class="anchor" href="#première-page-notion-de-vue-contrôleur"></a>Première page : notion de Vue/Contrôleur</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(d&#8217;après : <a href="https://symfony.com/doc/current/page_creation.html" class="bare">https://symfony.com/doc/current/page_creation.html</a>)</p>
</div>
<div class="paragraph">
<p>Pour une application web, créer une page c&#8217;est permettre à un certain public
d&#8217;accéder à une <strong>ressource</strong> (ou service) <strong>web</strong>. Pour cela, plusieurs activités sont concernées:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>permettre à l&#8217;application web de répondre à une requête HTTP en définissant  une route (portion terminale d&#8217;un URL) pour la ressource en question</p>
</li>
<li>
<p>définir via quelle méthode d&#8217;accès HTTP cette ressource sera accessible (GET, POST, PUT, HEAD, &#8230;&#8203;)</p>
</li>
<li>
<p>concevoir le <strong>contrô
leur</strong> associé à la ressource : une méthode d&#8217;une classe <code>Controller</code></p>
</li>
<li>
<p>définir la structure de la resource dynamique soit dans le contrôleur, soit via un template de vue (<strong>twig</strong> par exemple)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Si cette requête est de type <code>GET</code>, elle correspond à une demande de <em>resssource distante</em>.
Cela peut correspondre à une donnée statique (un fichier placé sur le serveur) ou dynamique (construite pour l&#8217;occasion).</p>
</div>
<div class="paragraph">
<p>Nous nous plaçons dans le cas où l&#8217;application répondra par du contenu dynamique <code>HTML</code>.</p>
</div>
<div class="paragraph">
<p>Une application web n&#8217;expose jamais directement ses templates de vue de ses ressources dynamiques (pas de lien direct vers un script de vue)</p>
</div>
<div class="paragraph">
<p>Dans le cadre de symfony, un contôleur central (<em>front controller</em>) réceptionne les requêtes HTTP
et les traduit en appel de <strong>méthodes</strong> d&#8217;instance d&#8217;une classe <strong>contrôleur</strong> (<em>controller</em>)</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/request-flow.png" alt="symfony-flow-schema"></span></p>
</div>
<div class="paragraph">
<p>Comme le montre ce schéma, le développeur doit mettre à disposition du framework des méthodes.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Attention, le schéma ne montre que les méthodes (<code>blogAction</code>, <code>contactAction</code> et <code>homepageAction</code>),
         mais ne donne pas le nom de la (ou des) classes où elles sont définies (source symfony.com).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La liaison méthode &#8592;&#8594; URL peut se réaliser soit par un <em>fichier de configuration</em>, soit via des <strong><em>annotations</em></strong> dans le code.
Nous choisirons cette dernière option, bien pratique, mais avant de concevoir une telle classe, vous devrez ajouter des composants à votre
application. Le plus souple pour cela est de demander à <code>composer</code> de le faire pour vous :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cd your-project/
$ composer require annotations</pre>
</div>
</div>
<div class="paragraph">
<p>Il serait également préférable d&#8217;installer des plugins à votre IDE : avec PhpStorm,
aller <code>File&#8594;Settings</code> puis chercher <code>plugin symfony</code> et les installer.</p>
</div>
<div class="paragraph">
<p>Voici un exemple de classe contrôleur, extrait de la documentation : <a href="https://symfony.com/doc/current/page_creation.html">Symfony - page_creation.html</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="inline-delimiter">&lt;?php</span>

<span class="comment">// src/Controller/LuckyController.php  </span><i class="conum" data-value="1"></i><b>(1)</b>

<span class="keyword">namespace</span> <span class="constant">App</span>\<span class="constant">Controller</span>;  <i class="conum" data-value="2"></i><b>(2)</b>

<span class="keyword">use</span> <span class="constant">Symfony</span>\<span class="constant">Component</span>\<span class="constant">HttpFoundation</span>\<span class="constant">Response</span>;  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="keyword">use</span> <span class="constant">Symfony</span>\<span class="constant">Component</span>\<span class="constant">Routing</span>\<span class="constant">Annotation</span>\<span class="constant">Route</span>;

<span class="keyword">class</span> <span class="class">LuckyController</span> <i class="conum" data-value="3"></i><b>(3)</b>
{
  <span class="comment">/**
  * @Route(&quot;/lucky/number&quot;) <i class="conum" data-value="4"></i><b>(4)</b>
  */</span>
  <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">number</span>() <i class="conum" data-value="5"></i><b>(5)</b>
  {
    <span class="local-variable">$number</span> = mt_rand(<span class="integer">0</span>, <span class="integer">100</span>);

    <span class="keyword">return</span> <span class="keyword">new</span> <span class="constant">Response</span>( <i class="conum" data-value="6"></i><b>(6)</b>
      <span class="string"><span class="delimiter">'</span><span class="content">&lt;html&gt;&lt;body&gt;Lucky number: </span><span class="delimiter">'</span></span>.<span class="local-variable">$number</span>.<span class="string"><span class="delimiter">'</span><span class="content">&lt;/body&gt;&lt;/html&gt;</span><span class="delimiter">'</span></span>
    );
  }
} <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>un comment à destination du lecteur, afin d&#8217;identifier le chemin de sauvegarde</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>les librairies dont dépend le code ci-dessous (Classe et annotation)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>une classe normale PHP Objet</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>définition de la logique d&#8217;appel (extrait terminal URL de l&#8217;application)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>une méthode public; Elle sera automatiquement appelée via le <em>front controller</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>retourne un instance de <code>Response</code> (avec du contenu <em>HTML</em>)</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>le marqueur de fin de traitement PHP (<code>?&gt;</code>) est volontairement absent afin de conserver le sens <em>librairie</em> d&#8217;une classe Controller.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Voici un extrait des spécifications de la fonction <a href="http://php.net/manual/fr/function.mt-rand.php" class="bare">http://php.net/manual/fr/function.mt-rand.php</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="predefined-type">int</span> mt_rand ( <span class="predefined-type">int</span> <span class="local-variable">$min</span> , <span class="predefined-type">int</span> <span class="local-variable">$max</span> )

<span class="constant">Valeurs</span> de retour

<span class="constant">Un</span> entier aléatoire compris entre <span class="predefined">min</span> (ou <span class="integer">0</span>) et <span class="predefined">max</span> inclusif, ou <span class="predefined-constant">FALSE</span> si le paramètre <span class="predefined">max</span> est inférieur à <span class="predefined">min</span>.</code></pre>
</div>
</div>
<div class="literalblock">
<div class="title">Activation de la page (demande de la ressource "number")</div>
<div class="content">
<pre>http://localhost:8000/lucky/number</pre>
</div>
</div>
<div class="sect2">
<h3 id="rendu-par-une-logique-de-vue-archtecture-mvc"><a class="anchor" href="#rendu-par-une-logique-de-vue-archtecture-mvc"></a>Rendu par une logique de vue (archtecture MVC)</h3>
<div class="paragraph">
<p>Concevoir la logique de présentation (HTML and Co) dans un contrôleur n&#8217;est pas une bonne pratique.</p>
</div>
<div class="paragraph">
<p>Fort heureusement Symfony vient avec <a href="https://twig.symfony.com/"><strong>Twig</strong></a> : un langage
de vue puissant et plaisant à utiliser.</p>
</div>
<div class="paragraph">
<p>Twig est proposé en tant que composant, qu&#8217;il faut installer :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cd your-project/
$ composer require twig</pre>
</div>
</div>
<div class="paragraph">
<p>Il faut ensuite s&#8217;assurer <code>LuckyController</code> hérite de la classe de base des contrôleurs <code>Controller</code>:</p>
</div>
<div class="listingblock">
<div class="title">Listing 1. MVC : Les classes contrôleur héritent de Controller</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="comment">// src/Controller/LuckyController.php</span>

<span class="comment">// ...</span>
+ <span class="keyword">use</span> <span class="constant">Symfony</span>\<span class="constant">Bundle</span>\<span class="constant">FrameworkBundle</span>\<span class="constant">Controller</span>\<span class="constant">Controller</span>; <i class="conum" data-value="1"></i><b>(1)</b>

- <span class="keyword">class</span> <span class="class">LuckyController</span>
+ <span class="keyword">class</span> <span class="class">LuckyController</span> <span class="keyword">extends</span> <span class="constant">Controller</span> <i class="conum" data-value="2"></i><b>(2)</b>
{
    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>déclaration de la dépendance (un import)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>la classe LuckyController hérite de Controller</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Et faire en sorte que la méthode contrôleur <strong>délègue</strong> la vue à une page twig :</p>
</div>
<div class="listingblock">
<div class="title">Listing 2. MVC : Une classe contrôleur hérite de Controller</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="comment">// src/Controller/LuckyController.php</span>

<span class="comment">// ...</span>
<span class="keyword">class</span> <span class="class">LuckyController</span> <span class="keyword">extends</span> <span class="constant">Controller</span>
{
    <span class="comment">/**
     * @Route(&quot;/lucky/number&quot;)
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">numberAction</span>()
    {
        <span class="local-variable">$number</span> = mt_rand(<span class="integer">0</span>, <span class="integer">100</span>);

        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;render(<span class="string"><span class="delimiter">'</span><span class="content">lucky/number.html.twig</span><span class="delimiter">'</span></span>, <span class="predefined">array</span>( <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="string"><span class="delimiter">'</span><span class="content">number</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$number</span>,
        ));
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>appel à la méthode héritée (<em>render</em>) en lui passant le nom d&#8217;une vue, suivi d&#8217;un <strong>tableau associatif</strong>, appelé aussi <strong>dictionnaire</strong>, composé de <strong>couples (nom_variable&#8658;valeur)</strong>.
Dans notre cas, le tableau n&#8217;a qu&#8217;un seul élément ('number'&#8658; $number),
qui sera passé à la vue.
La vue aura accès à ces valeurs <strong>directement</strong> par le nom des clés définis dans ce dictionnaire.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Les fichiers de vue seront cherchés par symfony, par défaut, dans le dossier <strong><em>templates</em></strong> à partir de la racine du projet (ce dossier est automatiquement crée lors de l&#8217;installation de twig).</p>
</div>
</div>
<div class="sect2">
<h3 id="template-de-base-de-l-application"><a class="anchor" href="#template-de-base-de-l-application"></a>Template de base de l&#8217;application</h3>
<div class="paragraph">
<p>C&#8217;est un fichier qui détermnine la structure HTML/CSS générale de votre application.
La plupart du temps un tel template se base sur un modèle proposé par des frameworks CSS (<em>bootstrap</em>, <em>semantic-ui</em>, &#8230;&#8203;). Il est parfois acheté auprès de sociétés spécialisées.</p>
</div>
<div class="paragraph">
<p>Exemple de template simple, <em>from scratch</em>, créé par le composant <em>twig</em> lors de son intégration dans ce projet (symfony &gt;= 4)</p>
</div>
<div class="listingblock">
<div class="title">Listing 3. localisation : projet/templates/base.html.twig</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="doctype">&lt;!DOCTYPE html&gt;</span>
<span class="tag">&lt;html&gt;</span>
    <span class="tag">&lt;head&gt;</span>
        <span class="tag">&lt;meta</span> <span class="attribute-name">charset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;title&gt;</span>{% block title %}Welcome!{% endblock %}<span class="tag">&lt;/title&gt;</span>
        {% block stylesheets %}{% endblock %}
    <span class="tag">&lt;/head&gt;</span>
    <span class="tag">&lt;body&gt;</span>
        {% block body %}{% endblock %} <i class="conum" data-value="1"></i><b>(1)</b>
        {% block javascripts %}{% endblock %}
    <span class="tag">&lt;/body&gt;</span>
<span class="tag">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Définition d&#8217;un block nommé <code>body</code> (ne pas confondre avec <code>&lt;body&gt;</code>).
Les vues héritant pouvent alors redéfinir ces blocks.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ce template de base définit 4 blocks : <code>title</code>, <code>stylesheets</code>, <code>body</code> et <code>javascripts</code>.</p>
</div>
<div class="paragraph">
<p>Pour répondre au besoin de notre méthode <em>numberAction</em> de <em>LuckyController</em>, nous
devons créer une nouvelle vue dans le dossier <em>templates/lucky</em>, nommée <code>number.html.twig</code> (<code>lucky</code> est un dossier qu&#8217;il faut créer) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php">{<span class="comment"># templates/lucky/number.html.twig #} </span><i class="conum" data-value="1"></i><b>(1)</b>
{% <span class="keyword">extends</span> <span class="string"><span class="delimiter">'</span><span class="content">base.html.twig</span><span class="delimiter">'</span></span> %} <i class="conum" data-value="2"></i><b>(2)</b>

{% block title %}<span class="constant">Devine</span>{% endblock %} <i class="conum" data-value="3"></i><b>(3)</b>

{% block body %} <i class="conum" data-value="4"></i><b>(4)</b>
&lt;h1&gt;<span class="constant">Your</span> lucky number is {{ number }}&lt;/h1&gt;
{% endblock %}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>un commentaire twig qui vous informe, vous lecteur, de la localisation de ce fichier</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>cette vue hérite d&#8217;un template qui définit les blocs <code>title</code> et <code>body</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>redéfinition du bloc <code>title</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>redéfinition du bloc <code>body</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vous trouverez la syntaxe twig ici : <a href="https://twig.symfony.com/" class="bare">https://twig.symfony.com/</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="gestion-des-données-d-entrée"><a class="anchor" href="#gestion-des-données-d-entrée"></a>Gestion des données d&#8217;entrée</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Conformément à l&#8217;architecture applicative, c&#8217;est une méthode dite <em>contrôleur</em> qui prend en charge l&#8217;exploitation des données transmises par le client (celui qui est à l&#8217;origine de la requête HTTP)</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Teminologie : les méthodes associées à des <em>Routes</em> dans une classe <em>Controller</em> sont appelées <strong><em>méthodes d&#8217;action</em></strong>. Par extension, on nomme parfois de telles méthodes des <strong><em>contrôleurs</em></strong>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="auto-injection-de-l-objet-request"><a class="anchor" href="#auto-injection-de-l-objet-request"></a>Auto-injection de l&#8217;objet Request</h3>
<div class="paragraph">
<p>Pour accéder aux données transmises avec la requête HTTP,
le contrôleur passera par un objet de type <em>Request</em> (de <em>HttpFoundation</em>).</p>
</div>
<div class="paragraph">
<p>C&#8217;est par l&#8217;intermédiaire de cet objet, que nous pourrons accéder aux données
de la session utilisateur.</p>
</div>
<div class="paragraph">
<p>Utilisation d&#8217;un objet de la classe <code>Symfony\Component\HttpFoundation\Request</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="keyword">use</span> <span class="constant">Symfony</span>\<span class="constant">Component</span>\<span class="constant">HttpFoundation</span>\<span class="constant">Request</span>; <i class="conum" data-value="1"></i><b>(1)</b>

[...]

<span class="keyword">public</span> <span class="keyword">function</span> <span class="function">index</span>(<span class="constant">Request</span> <span class="local-variable">$request</span>) <i class="conum" data-value="2"></i><b>(2)</b>
{
  <span class="comment">// exploiter $request</span>
}

[...]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>un composant du micro-framework</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>en déclarant un paramètre de type Request, on demande à symfony de nous <strong>auto-injecter</strong> un argument de ce type, parfaitement bien initialisé.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Attention, ne pas faire usage de variables super-globales comme GET[], SESSION[], &#8230;&#8203;
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="données-implicites"><a class="anchor" href="#données-implicites"></a>Données implicites</h3>
<div class="paragraph">
<p>Ce sont les données transmises par le client, et le serveur,
 dans la partie entête HTTP. Ces données sont accessibles <strong>via</strong> l&#8217;objet <code>Request</code>
 qui dispose de méthodes bient pratiques pour interroger ces données.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>getLanguages()
Returns the list of accepted languages ordered by descending quality.</p>
</li>
<li>
<p>getCharsets()
Returns the list of accepted charsets ordered by descending quality.</p>
</li>
<li>
<p>bool isXmlHttpRequest()
Returns true if the request is a XMLHttpRequest.</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>voir <a href="http://api.symfony.com/4.0/Symfony/Component/HttpFoundation/Request.html">API Request</a></p>
</div>
</div>
<div class="sect2">
<h3 id="données-explicites"><a class="anchor" href="#données-explicites"></a>Données explicites</h3>
<div class="paragraph">
<p>ce sont celles en provenance soit d&#8217;un <strong>formulaire (HTML)</strong> soit comme composantes <a href="https://en.wikipedia.org/wiki/Query_string">QueryString</a> de l'<strong>URL</strong>.</p>
</div>
<div class="sect3">
<h4 id="via-un-formulaire"><a class="anchor" href="#via-un-formulaire"></a>via un formulaire</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php">    <span class="comment">// retrieves POST variables respectively</span>
    <span class="local-variable">$request</span>-&gt;request-&gt;get(<span class="string"><span class="delimiter">'</span><span class="content">idProuit</span><span class="delimiter">'</span></span>); <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="comment">// retrieves an instance of UploadedFile identified by foo</span>
    <span class="local-variable">$request</span>-&gt;files-&gt;get(<span class="string"><span class="delimiter">'</span><span class="content">foo</span><span class="delimiter">'</span></span>);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>C&#8217;est via l&#8217;attribut <code>request</code>, de l&#8217;objet référencé par <code>$request</code> (à ne pas confondre) que le contrôleur aura accès aux données passées par <code>POST</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="cas-des-arguments-passés-dans-l-url"><a class="anchor" href="#cas-des-arguments-passés-dans-l-url"></a>Cas des arguments passés dans l&#8217;url</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"> <span class="comment">// retrieves GET variables respectively</span>
    <span class="local-variable">$request</span>-&gt;query-&gt;get(<span class="string"><span class="delimiter">'</span><span class="content">x</span><span class="delimiter">'</span></span>, <span class="integer">66</span>);  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>C&#8217;est via l&#8217;attribut <code>query</code>, de l&#8217;objet référencé par <code>$request</code>, que le contrôleur aura accès aux données passées par <code>GET</code>.
Par exemple, les données transmises en arguments de l&#8217;url (<code>?a=b&amp;x=42</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>La méthode <code>get</code> prend en premier argument la <strong>clé</strong> (ici <code>a</code> ou <code>x</code>), le deuxième étant une <strong>valeur par défaut</strong>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="cas-de-valeurs-incluses-dans-l-url-même"><a class="anchor" href="#cas-de-valeurs-incluses-dans-l-url-même"></a>Cas de valeurs incluses dans l&#8217;url même</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"> <span class="comment">/**
     * Matches /blog/*
     *
     * @Route(&quot;/blog/{slug}&quot;, name=&quot;blog_show&quot;)  <i class="conum" data-value="1"></i><b>(1)</b>
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">show</span>(<span class="local-variable">$slug</span>) { ... } <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>La route contient une partie variable, représentée par un paramètre placé en <code>{  }</code> (ici <em>slug</em>). Exemples d&#8217;arguments : <code>/blog/usecase1</code> ou <code>/blog/usecase2</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Reprise de la partie variable de l&#8217;url comme <strong>paramètre</strong> de la méthode (attention, même nom que le paramètre de route)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il est dans ce cas très facile de récupérer la valeur en question, car elle est passée automatiquement à la méthode !</p>
</div>
<div class="paragraph">
<p>Plus d&#8217;infos sur l&#8217;exploitation des valeurs d&#8217;entrée :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://symfony.com/doc/current/routing.html" class="bare">https://symfony.com/doc/current/routing.html</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>avec des exemples de redirection :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://symfony.com/doc/current/controller.html" class="bare">https://symfony.com/doc/current/controller.html</a></p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="travaux-pratiques-1"><a class="anchor" href="#travaux-pratiques-1"></a>Travaux Pratiques - 1 -</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="premier-travail"><a class="anchor" href="#premier-travail"></a>Premier travail</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Après avoir installé et configuré votre IDE, atteindre la dernière étape de ce premier tutoriel (avec twig) à savoir :</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/lucky-number-42.png" alt="lucky number in action" width="500"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="migration-application-php-classique-vers-symfony"><a class="anchor" href="#migration-application-php-classique-vers-symfony"></a>Migration application PHP classique vers Symfony</h3>
<div class="ulist">
<ul>
<li>
<p>Traduction d&#8217;un code PHP mélangant logique de traitement et logique de vue en une structure séparant Vues (Twig) et Contrôleurs (objets)</p>
</li>
<li>
<p>Poursuite du développement de la solution en mode interatif et incrémental avec Symfony, à savoir une  application web répondant aux spécifications suivantes :</p>
</li>
</ul>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<strong>SPECIFICATIONS</strong> :   L&#8217;utilisateur cherche à trouver un nombre retenu par l&#8217;application de façon « aléatoire », sur une plage d&#8217;amplitude allant de zéro à, disons, 50.
 Chaque nombre sera représenté par une cellule <code>td</code> d&#8217;un tableau <code>html</code>. Lorsque l&#8217;utilisateur soumet une proposition (clique sur une cellule/nombre), l&#8217;application répond « valeur trop petite », « valeur trop grande » ou « Trouvé ! ». Durant les tentatives, l&#8217;application montre les cellules déjà sélectionnées par l&#8217;utilisateur (prévoir une classe CSS dédiée). La partie s&#8217;arrête lorsque l&#8217;utilisateur a trouvé le bon nombre.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
L&#8217;application ne sauvegardera aucune donnée du jeu (historique utilisateur) sur le serveur (les « données de sessions » seront transmises au client – et donc portées par celui-ci – un exemple de code est donné en annexe).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Étapes à suivre :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Traduire le code PHP de l&#8217;annexe en un projet symfony (avec contrôleur index et vue twig)</p>
</li>
<li>
<p>Faire évoluer l&#8217;application afin qu&#8217;elle réponde aux attentes (exprimées ci-dessus).</p>
</li>
<li>
<p>Présentation des nombres dans une matrice 10 x 10</p>
</li>
<li>
<p>L&#8217;utilisateur pourra relancer autant de parties qu&#8217;il le souhaite. Comme il se doit, l&#8217;application sera capable de gérer plusieurs utilisateurs en même temps.</p>
</li>
<li>
<p>Lorsque que le nombre est trouvé, l&#8217;application affiche un des messages suivants :</p>
<div class="ulist">
<ul>
<li>
<p><strong>« Vous avez de la chance !»</strong> si le nombre d’essai du joueur est inférieur au nombre optimal (à déterminer après avoir étudié le principe de la recherche dichotomique - lien wikipédia ci-dessous).</p>
</li>
<li>
<p><strong>« Votre stratégie a été la bonne »</strong> si le nombre d’essai du joueur est égale au nombre optimal.</p>
</li>
<li>
<p><strong>« Vous avez débordé de n tentatives »</strong> où <em>n</em> est le nombre de tentatives au-delà du nombre optimal.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Pour déterminer le message à présenter, référez-vous aux caractéristiques d&#8217;efficacité de la <strong>recherche dichotomique</strong> : <a href="https://fr.wikipedia.org/wiki/Dichotomie" class="bare">https://fr.wikipedia.org/wiki/Dichotomie</a></p>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>Optionnel, pour les plus avancés :</p>
<div class="ulist">
<ul>
<li>
<p>L&#8217;utilisateur peut étendre l&#8217;amplitude de la matrice.</p>
</li>
<li>
<p>Proposer une version qui n’expose pas la valeur à trouver au client (prévoir un  cryptage symétrique du nombre – l’expéditeur est le destinataire).</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="ressources-à-prendre-en-compte"><a class="anchor" href="#ressources-à-prendre-en-compte"></a>Ressources à prendre en compte</h3>
<div class="ulist">
<ul>
<li>
<p>Génération pseudo-aléatoire d&#8217;un nombre : <a href="http://php.net/manual/fr/function.mt-rand.php" class="bare">http://php.net/manual/fr/function.mt-rand.php</a></p>
</li>
<li>
<p>Legacy code en annexe pour commencer.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="annexe-tp-1-code-legacy-prototype"><a class="anchor" href="#annexe-tp-1-code-legacy-prototype"></a>Annexe TP-1 - code legacy (prototype)</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="inline-delimiter">&lt;?php</span>
<span class="comment">// exploitation des données reçues (ou attendues) – on attend un couple i=n</span>
<span class="keyword">if</span> (<span class="predefined">isset</span>(<span class="predefined">$_GET</span>[<span class="string"><span class="delimiter">'</span><span class="content">i</span><span class="delimiter">'</span></span>])) :
  <span class="local-variable">$iChoixJoueur</span> = (<span class="predefined-type">int</span>) <span class="predefined">$_GET</span>[<span class="string"><span class="delimiter">'</span><span class="content">i</span><span class="delimiter">'</span></span>];
  <span class="comment">// force l'interprétation de la valeur en un entier</span>
  <span class="keyword">else</span> :
    <span class="local-variable">$iChoixJoueur</span> = -<span class="integer">1</span>;
  <span class="keyword">endif</span>;
  <span class="comment">// ou (même traitement que ci-dessus)</span>
  <span class="comment">// $iChoixJoueur = isset($_GET['i']) ? (int) $_GET['i'] : -1; //opérateur ternaire</span>
  <span class="comment">// on récupère l'historique des tentatives (une chaîne de caractères en fait)</span>
  <span class="keyword">if</span> (<span class="predefined">empty</span>(<span class="predefined">$_GET</span>[<span class="string"><span class="delimiter">'</span><span class="content">histo</span><span class="delimiter">'</span></span>])) :
    <span class="local-variable">$histo</span> = <span class="string"><span class="delimiter">'</span><span class="content">----------w--------------</span><span class="delimiter">'</span></span>;
    <span class="comment">// TODO : placer le numéro gagnant (w)iner de façon aléatoire</span>
  <span class="keyword">else</span>:
    <span class="local-variable">$histo</span> = <span class="predefined">$_GET</span>[<span class="string"><span class="delimiter">'</span><span class="content">histo</span><span class="delimiter">'</span></span>];
  <span class="keyword">endif</span>;
  <span class="comment">// mise à jour de l'historique : prise en compte du choix utilisateur</span>
  <span class="keyword">if</span> (<span class="local-variable">$iChoixJoueur</span> &gt;= <span class="integer">0</span> &amp;&amp; <span class="local-variable">$iChoixJoueur</span> &lt; <span class="predefined">strlen</span>(<span class="local-variable">$histo</span>)) :
    <span class="local-variable">$histo</span>[<span class="local-variable">$iChoixJoueur</span>] = <span class="string"><span class="delimiter">'</span><span class="content">j</span><span class="delimiter">'</span></span>;
  <span class="keyword">endif</span>;
 <span class="inline-delimiter">?&gt;</span>
<span class="doctype">&lt;!DOCTYPE html&gt;</span>
<span class="tag">&lt;html</span> <span class="attribute-name">lang</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fr</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;head&gt;</span>
  <span class="tag">&lt;meta</span> <span class="attribute-name">charset</span>=<span class="string"><span class="delimiter">'</span><span class="content">utf-8</span><span class="delimiter">'</span></span> <span class="tag">/&gt;</span>
  <span class="tag">&lt;title&gt;</span>À la recherche du nombre<span class="tag">&lt;/title&gt;</span>
  <span class="tag">&lt;style</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/css</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="inline">  <span class="class">.normal</span> {
    <span class="key">border</span>: <span class="float">1px</span> <span class="value">solid</span> <span class="value">black</span>;
  }
  <span class="class">.dejajoue</span> {
    <span class="key">border</span>: <span class="float">1px</span> <span class="value">solid</span> <span class="value">black</span>;
    <span class="key">background-color</span>: <span class="value">lightgreen</span>;
  }</span>
  <span class="tag">&lt;/style&gt;</span>
<span class="tag">&lt;/head&gt;</span>
<span class="tag">&lt;body&gt;</span>
  <span class="tag">&lt;h2&gt;</span>à la recherche du nombre<span class="tag">&lt;/h2&gt;</span>
  <span class="tag">&lt;table&gt;</span>
    <span class="tag">&lt;tbody&gt;</span>
      <span class="tag">&lt;tr&gt;</span>
        <span class="inline-delimiter">&lt;?php</span>
          <span class="comment">// mode debug : var_dump($histo);</span>
          <span class="comment">// TODO : il faudrait mieux appliquer la classe &quot;dejajoue&quot;</span>
          <span class="comment">//        a toutes les cellules deja jouees</span>
          <span class="keyword">for</span> (<span class="local-variable">$i</span>=<span class="integer">0</span>; <span class="local-variable">$i</span> &lt; <span class="predefined">strlen</span>(<span class="local-variable">$histo</span>); <span class="local-variable">$i</span>++) :
            <span class="keyword">if</span> (<span class="local-variable">$i</span> == <span class="local-variable">$iChoixJoueur</span>) : <span class="inline-delimiter">?&gt;</span>
              <span class="tag">&lt;td</span> <span class="attribute-name">class</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">dejajoue</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="inline-delimiter">&lt;?php</span> <span class="keyword">else</span> : <span class="inline-delimiter">?&gt;</span>
              <span class="tag">&lt;td</span> <span class="attribute-name">class</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">normal</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="inline-delimiter">&lt;?php</span> <span class="keyword">endif</span>; <span class="inline-delimiter">?&gt;</span>
              <span class="tag">&lt;a</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">?i=</span></span><span class="inline-delimiter">&lt;?php</span> <span class="predefined">echo</span> <span class="local-variable">$i</span> <span class="inline-delimiter">?&gt;</span><span class="string"><span class="content">&amp;</span><span class="content">histo=</span></span><span class="inline-delimiter">&lt;?php</span> <span class="predefined">echo</span> <span class="local-variable">$histo</span> <span class="inline-delimiter">?&gt;</span><span class="string"><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="inline-delimiter">&lt;?php</span> <span class="predefined">echo</span> <span class="local-variable">$i</span>; <span class="inline-delimiter">?&gt;</span>
              <span class="tag">&lt;/a&gt;</span>
            <span class="tag">&lt;/td&gt;</span>
          <span class="inline-delimiter">&lt;?php</span> <span class="keyword">endfor</span>; <span class="inline-delimiter">?&gt;</span>
        <span class="tag">&lt;/tr&gt;</span>
      <span class="tag">&lt;/tbody&gt;</span>
    <span class="tag">&lt;/table&gt;</span>
  <span class="tag">&lt;/body&gt;</span>
  <span class="tag">&lt;/html&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction-au-model"><a class="anchor" href="#introduction-au-model"></a>Introduction au Model</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Éléments-d-architecture"><a class="anchor" href="#Éléments-d-architecture"></a>Éléments d&#8217;architecture</h3>
<div class="paragraph">
<p>Nous avons vu comment associer des <em>routes</em> à des <em>contrôleurs</em> (méthodes d&#8217;action d&#8217;une classe Controller).</p>
</div>
<div class="paragraph">
<p>Nous allons voir comment le contrôleur peut s&#8217;appuyer sur des <strong>objets métier</strong> pour <strong>implémenter une logique de cas d&#8217;utilisation</strong>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Il est courant de faire porter la responsabilité d&#8217;un cas d&#8217;utilisation à une classe contrôleur.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il existe 2 sortes d&#8217;objets métier : <code>Entity</code> et <code>EntityRepository</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Entity</code> : Représente une classe métier pour le domaine étudié (<code>Client</code>, <code>Contrat</code>, &#8230;&#8203;).</p>
</li>
<li>
<p><code>EntityRepository</code> : Responsable de la communication avec les système de persistance, notamment en lien avec l' <code>ORM</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le contrôleur dépend de <code>Entity</code> et <code>EntityRepository</code>, <code>Entity</code> ne dépend pas d&#8217;un ORM, <code>EntityRepository</code> si.</p>
</div>
<div class="paragraph">
<div class="title">Architecture en couches</div>
<p><span class="image"><img src="images/schema-interactions-couches.png" alt="Interactions vue en couches" width="600"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="premiers-pas-avec-le-model"><a class="anchor" href="#premiers-pas-avec-le-model"></a>Premiers pas avec le model</h3>
<div class="sect3">
<h4 id="guide"><a class="anchor" href="#guide"></a>Guide</h4>
<div class="paragraph">
<p>Faire le lien entre un objet (instance d&#8217;une classe Entity) et une ligne d&#8217;une table d&#8217;une base de données
est une opération complexe (synchronisation, mise en cache, cohérence de type, &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>Les <strong>ORM</strong> (<em>object-relational mapping</em>) sont des logiciels qui effectuent le lien entre objet métier et ligne
de table d&#8217;une base de données. Par défaut, symfony utilise la solution <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/">doctrine</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="tutoriel-doctrine-de-symfony"><a class="anchor" href="#tutoriel-doctrine-de-symfony"></a>Tutoriel doctrine de symfony</h4>
<div class="paragraph">
<p>Doctrine peut être mise en oeuvre sans Symfony, mais nous vous invitons néanmoins à
étudier ce tutoriel d&#8217;introduction avec Symfony, car ce dernier en simplifie l&#8217;accès.</p>
</div>
<div class="paragraph">
<p>Ce tutoriel vous montre comment lier une classe métier à un table d&#8217;une base de données, et donc une instance (un objet) à une ligne,
et les opérations CRUD associées.</p>
</div>
<div class="paragraph">
<p>Tutoriel à suivre : <a href="https://symfony.com/doc/current/doctrine.html">Introduction à Doctrine avec Symfony</a>.</p>
</div>
<div class="paragraph">
<p>Au menu :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Entity et Table liée</p>
</li>
<li>
<p>Liaison Attribut - Colonne (<em>field</em> - <em>column</em>)</p>
</li>
<li>
<p>Migration modèle objet &#8592;&#8594; schéma de la base de données</p>
</li>
<li>
<p>Opérations CRUD</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>&#8658; temps moyen 2h, avec configuration et code.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="liaison-entre-entités-contexte-support"><a class="anchor" href="#liaison-entre-entités-contexte-support"></a>Liaison entre Entités - Contexte support</h3>
<div class="paragraph">
<p>Nous nous plaçons dans le cas d&#8217;une application exploitant des données stockées
par un système de gestion de bases de données relationnel (SGBDR).</p>
</div>
<div class="paragraph">
<p>Voici le schéma relationnel de la base de données utilisé.
« world » est une base de données statistiques géo-politiques sur le monde datant de 2006,
d&#8217;après <a href="http://www.stat.fi/tup/maanum/index_en.html">Official Statistics of Finland</a>.</p>
</div>
<div class="paragraph">
<div class="title">Schéma Relationnel de la base de données World</div>
<p><span class="image"><img src="images/SR-World.png" alt="SR-World.png" width="400"></span></p>
</div>
<div class="paragraph">
<p>Les données seront exploitées, par la logique applicative, sous forme de <em>Classe</em>, plus précisément :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Classe &#8592;&#8594; Table</p>
</li>
<li>
<p>Objet &#8592;&#8594; Ligne</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cette façon de faire permet de mettre le <em>domaine métier</em> <strong>au coeur de la logique de l&#8217;application</strong>.
Voici une analyse du modèle : les classes "métier" ("entity")</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diagram-classes.png" alt="Diagramme d'analyse UML (les entités du domaine)" width="271" height="288">
</div>
<div class="title">Figure 2. Diagramme d&#8217;analyse UML (les entités du domaine)</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Les données de la base seront exploitées par l&#8217;intermédiaire
d&#8217;objets (instances de classes métier)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Pour aider le travail de l&#8217;ORM Doctrine (<em>Object Relational Mapping</em>), la défintion des entités intégre des directives de mapping sous forme d'<strong>annotations</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="mappings-et-annotations"><a class="anchor" href="#mappings-et-annotations"></a>Mappings et annotations</h3>
<div class="paragraph">
<p>Dans ce qui suit, afin de bien distinguer ce qui de l&#8217;ordre du
modèle de persistance (tables du schéma relationnel) et
du modèle métier (les classes entité), nous nommerons les éléments
du modèle métier en <strong>langue française</strong>.</p>
</div>
<div class="paragraph">
<p>Ainsi la classe entité qui mappe la table <code>Country</code> s&#8217;appellera <code>Pays</code>, <code>Language</code> → <code>Langue</code>,
 <code>CountryLanguage</code> → <code>PaysLangue</code>, <code>City</code> → <code>Ville</code>.</p>
</div>
<div class="sect3">
<h4 id="manytoone"><a class="anchor" href="#manytoone"></a>ManyToOne</h4>
<div class="paragraph">
<p>Exemple du <strong>point de vue de la table <code>City</code></strong> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Une ville est située dans un et un seul pays (One = 1..1)</p>
</li>
<li>
<p>Plusieurs villes peuvent être reliées au même pays (Many = 0..*)_</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="côté-schéma-relationnel"><a class="anchor" href="#côté-schéma-relationnel"></a>Côté Schéma Relationnel</h5>
<div class="paragraph">
<p>La relation, partant de <code>City</code>, est <strong>ManyToOne</strong> (symbole UML de plusieurs vers un):</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/many-to-one-sr.png" alt="many-to-one-sr"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="côté-classe-métier-classe-entity"><a class="anchor" href="#côté-classe-métier-classe-entity"></a>Côté classe métier (classe Entity)</h5>
<div class="ulist">
<ul>
<li>
<p>Les identifiants ne sont pas montrés</p>
</li>
<li>
<p>Les liaisons sont représentées par des associations (rappel : une association est l&#8217;expression d&#8217;un lien en objets)</p>
</li>
<li>
<p>les rôles sont précisés (optionnel si trivial comme ici)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/many-to-one-metier.png" alt="many-to-one-metier"></span></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
L&#8217;attribut <code>$pays</code> est de type <code>Pays</code> (et non integer !) car il est
une référence potentielle à un objet <code>Pays</code>.
La notion de lien-bidirectionnel est vue dans le paragraphe suivant.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="onetomany"><a class="anchor" href="#onetomany"></a>OneToMany</h4>
<div class="paragraph">
<p>Exemple du <strong>point de vue de la table <code>Country</code></strong>  :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Un <code>Pays</code> est référençable par plusieurs instances de <code>Ville</code>  (Many = 0..*)</p>
</li>
<li>
<p>Un <code>Pays</code> a l&#8217;exclusivité des villes qui le référencent (One = 1..1)</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="côté-schéma-relationnel-2"><a class="anchor" href="#côté-schéma-relationnel-2"></a>Côté Schéma Relationnel</h5>
<div class="paragraph">
<p>La relation, partant de <code>Country</code>, est <strong>OneToMany</strong> (de un vers plusieurs)</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/one-to-many-sr.png" alt="one-to-many-sr"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="côté-modèle-métier"><a class="anchor" href="#côté-modèle-métier"></a>Côté modèle métier</h5>
<div class="paragraph">
<p><span class="image"><img src="images/one-to-many-metier.png" alt="one-to-many-metier" width="550"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>L&#8217;attribut d&#8217;instance <code>$villes</code> est de type <code>collection de Ville</code></p>
</li>
<li>
<p>La valeur de <code>mappedBy</code> est l&#8217;attribut d&#8217;instance responsable de la liaison <code>One</code> du côté opposé (c&#8217;est grâce à lui que l&#8217;ensemble
des villes de l&#8217;instance courante de <code>Pays</code> pourra être constitué)</p>
</li>
<li>
<p>Côté <code>Ville</code>, en renseignant la valeur de <code>inversedBy</code> on précise que c&#8217;est <code>Ville</code>
qui est responsable (owner = lien actif) de la cohérence bidirectionnelle (sur ce sujet, voir  plus bas, chapitre lien-bidirectionnel)</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
L&#8217;usage de <strong>mappedBy</strong> et <strong>inversedBy</strong> signifie qu&#8217;il s&#8217;agit du <strong>même lien</strong> entre objet, donc de la <strong>même</strong> association dans le modèle d&#8217;analyse métier UML.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="onetoone"><a class="anchor" href="#onetoone"></a>OneToOne</h4>
<div class="ulist">
<ul>
<li>
<p>Un pays a au plus une capitale (une Ville)</p>
</li>
<li>
<p>Seules certaines villes sont capitales d&#8217;un pays.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="côté-schéma-relationnel-3"><a class="anchor" href="#côté-schéma-relationnel-3"></a>Côté Schéma Relationnel</h5>
<div class="ulist">
<ul>
<li>
<p>La relation entre <code>Country</code> et <code>City</code>, est <strong>OneToOne</strong>
<span class="image"><img src="images/one-to-one-sr.png" alt="one-to-one-sr"></span></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="côté-modèle-métier-2"><a class="anchor" href="#côté-modèle-métier-2"></a>Côté modèle métier</h5>
<div class="ulist">
<ul>
<li>
<p>C&#8217;est le <code>Pays</code> qui connaît sa <strong>capitale</strong>, le lien inverse serait trop souvent non valorisé, nous appliquons un lien <strong>uni-directionnel</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/one-to-one-metier.png" alt="one-to-one-metier"></span></p>
</div>
<div class="paragraph">
<p>Remarque 1 : le <strong>rôle</strong> d&#8217;une instance de Ville dans cette association est d&#8217;être une <strong>capitale</strong>. Ce rôle n&#8217;étant pas trivial (ne peut être deviné à la lecture du diagramme), nous le précisons. Le nommage de l&#8217;attribut d&#8217;instance de Ville dans pays est alors tout trouvé.</p>
</div>
<div class="paragraph">
<p>Remarque 2: le lien uni-directionnel spécifie le sens de la navigation possible (de <code>Pays</code> vers <code>Ville</code>)</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="manytoone-onetomany-lien-bidirectionnel"><a class="anchor" href="#manytoone-onetomany-lien-bidirectionnel"></a>ManyToOne-OneToMany : Lien bidirectionnel</h4>
<div class="paragraph">
<p>Lorsque l&#8217;on traite une association navigable dans les 2 sens (lien bidirectionnel), il faut assurer sa cohérence après le chargement des objets. Exemple :
Si une ville nouvellement créée se déclare appartenir à un pays,
ce dernier devra alors l&#8217;avoir dans sa liste de ses villes, et inversement !.
Par convention, c&#8217;est l&#8217;objet qui est au plus prêt du lien <strong>One</strong> qui se charge de la cohérence.
Dans notre exemple ce sera <code>Ville</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"> <span class="comment">/**
  * Ville
  *
  * @ORM\Table(name=&quot;City&quot;)
  * @ORM\Entity(repositoryClass=&quot;Acme\DemoBundle\Entity\VilleRepository&quot;)
  */</span>
 <span class="keyword">class</span> <span class="class">Ville</span>
 {

 . . .

     <span class="comment">/**
      * Set pays
      *
      * @param \Acme\DemoBundle\Entity\Pays $pays
      * @return Ville
      */</span>
     <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setPays</span>(\<span class="constant">Acme</span>\<span class="constant">DemoBundle</span>\<span class="constant">Entity</span>\<span class="constant">Pays</span> <span class="local-variable">$pays</span> = <span class="predefined-constant">null</span>)
     {
       <span class="keyword">if</span> (<span class="local-variable">$this</span>-&gt;pays) {
          <span class="local-variable">$this</span>-&gt;<span class="local-variable">$pays</span>-&gt;removeVille(<span class="local-variable">$this</span>);
        }
        <span class="local-variable">$this</span>-&gt;pays = <span class="local-variable">$pays</span>;
        <span class="local-variable">$pays</span>-&gt;addVille(<span class="local-variable">$this</span>);
        <span class="keyword">return</span> <span class="local-variable">$this</span>;
     }</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Attention : Il ne faut pas abuser des liens bidirectionnels ! Car comme vous l&#8217;avez constaté, les objets du domaine sont plus délicats à programmer. Parmi les premiers Best Practices de Doctrine, on peut lire :
     	Il est important de limiter les relations autant que possible. Cela signifie:
     Imposer un sens de parcours (éviter associations bidirectionnelles si possible)
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Cette limitation n&#8217;est vraie pour tout les ORMs (<em>hibernate</em> par exemple)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Éliminer les associations non essentielles offre plusieurs avantages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Couplage réduit dans votre modèle de domaine</p>
</li>
<li>
<p>Code plus simple dans votre modèle de domaine (pas besoin de maintenir la bi-directionnalité correctement)</p>
</li>
<li>
<p>Moins de travail pour L’ORM (Doctrine)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Voir plus loin : <a href="http://docs.doctrine-project.org/en/latest/reference/best-practices.html" class="bare">http://docs.doctrine-project.org/en/latest/reference/best-practices.html</a></p>
</div>
</div>
<div class="sect3">
<h4 id="association-bidirectionnelle-owner-side-and-inverse-side"><a class="anchor" href="#association-bidirectionnelle-owner-side-and-inverse-side"></a>Association bidirectionnelle : Owner side and Inverse side</h4>
<div class="paragraph">
<p>Libre traduction de : <a href="http://docs.doctrine-project.org/en/2.0.x/reference/association-mapping.html" class="bare">http://docs.doctrine-project.org/en/2.0.x/reference/association-mapping.html</a></p>
</div>
<div class="paragraph">
<p>Lorsque l&#8217;on utilise une relation bidirectionnelle, il est important de bien comprendre le concept de owner (propriétaire) et d&#8217;inverse.</p>
</div>
<div class="paragraph">
<p>Une relation bidirectionnelle dans le modèle objet est implémentée par 2 références, qui représentent la même association, mais peuvent techniquement changer indépendamment l&#8217;une de l&#8217;autre et le développeur doit s&#8217;assurer que la cohérence métier est maintenue lors de manipulation de ces références.</p>
</div>
<div class="paragraph">
<p>Techniquement, Doctrine a besoin de savoir laquelle de ces 2 références mémoire (les instance qu&#8217;elles pointent) doit être persistée et laquelle non. C&#8217;est pourquoi le concept de owning/inverse est principalement utilisé. Tout changement de valeur côté inverse sera ignoré (pas d&#8217;impact dans la base de donnée).</p>
</div>
<div class="paragraph">
<p>Les règles générales suivantes s&#8217;appliquent :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Une relation bidirectionnelle a deux extrémités : le côté propriétaire (owner - partie active de la relation) et le côté inverse (inverse).</p>
</li>
<li>
<p>Le côté <strong>propriétaire</strong> d&#8217;une relation détermine les opérations de mises à jour dans la base de données.</p>
</li>
<li>
<p>Le côté <strong>propriétaire</strong> d&#8217;une relation bidirectionnelle doit référencer le <strong>côté inverse</strong> par l&#8217;usage de l&#8217;attribut <strong>inversedBy</strong> lors de la déclaration du mapping OneToOne, ManyToOne, ou ManyToMany. L&#8217;attribut inversedBy désigne le champ (l&#8217;attribut d&#8217;instance) de l&#8217;entité inverse de la relation.</p>
</li>
<li>
<p>Le côté inverse d&#8217;une relation bidirectionnelle doit référencer son <strong>côté propriétaire</strong> par l&#8217;usage de l&#8217;attribut <strong>mappedBy</strong> lors de la déclaration du mapping OneToOne, OneToMany, ou ManyToMany. L&#8217;attribut mappedBy désigne le champ (l&#8217;attribut d&#8217;instance) de l&#8217;entité propriétaire de la relation.</p>
</li>
<li>
<p>Le côté many de la relation bidirectionnelle OneToMany/ManyToOne doit être le côté propriétaire.</p>
</li>
<li>
<p>Une relation unidirectionnelle a seulement un côté propriétaire.</p>
</li>
<li>
<p>Concernant la relation bidirectionnelle OneToOne, le propriétaire correspond au côté qui mappe la table disposant de la clé étrangère en question (@JoinColumn(s)).</p>
</li>
<li>
<p>Concernant la relation bidirectionnelle ManyToMany chacune des extrémités peut être le propriétaire : Le propriétaire est déterminé
par le fait qu&#8217;il définit la jointure - @JoinTable <strong>ou</strong> s&#8217;il ne fait pas usage de l&#8217;attribut mappedBy.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Les concepts de <em>propriétaire/inverse</em> <strong>ne sont pas</strong> des concepts métier, mais techniques (la relation propriétaire—inverse n&#8217;a pas de sens métier).
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="manytomany-porteuse-de-propriétés"><a class="anchor" href="#manytomany-porteuse-de-propriétés"></a>ManyToMany - porteuse de propriétés</h4>
<div class="ulist">
<ul>
<li>
<p>Pour un pays donné, plusieurs langues sont parlées (dont une est officielle)</p>
</li>
<li>
<p>Une langue est parlée dans plusieurs pays.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="côté-schéma-relationnel-4"><a class="anchor" href="#côté-schéma-relationnel-4"></a>Côté Schéma Relationnel</h5>
<div class="paragraph">
<p><code>CountryLanguage</code> est une <em>table de liaison</em>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/many-to-many-sr-porteuse.png" alt="many-to-many-sr-porteuse"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="côté-modèle-metier"><a class="anchor" href="#côté-modèle-metier"></a>Côté modèle metier</h5>
<div class="paragraph">
<p>Nous avons 3 classes. Deux options s&#8217;offre à nous, qui dépend de l&#8217;approche
Primauté du Schéma Relationnel sur le modèle objet
Primauté de l&#8217;Objet sur le Schéma Relationnel.</p>
</div>
<div class="paragraph">
<p>Dans le premier cas nous avons la solution suivante :</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/many-to-many-metier-porteuse-1.png" alt="many-to-many-metier-porteuse-1"></span></p>
</div>
<div class="paragraph">
<p>En UML, une classe-association peut aussi être représentée comme une
classe ordinaire reliée à une association <strong>ManyToMany</strong> porteuse d&#8217;attributs, comme ici :</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/many-to-many-metier-porteuse-2.png" alt="many-to-many-metier-porteuse-2"></span></p>
</div>
<div class="paragraph">
<p>Exemple d&#8217;opération CREATE (d&#8217;ajout d&#8217;une langue non officielle à un pays) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="comment">// pour initialiser une classe association, on reconstitue les</span>
     <span class="comment">// élements de sa clé : ici un objet Langue et un objet Pays.</span>
     <span class="local-variable">$lePays</span> = <span class="local-variable">$this</span>-&gt;getDoctrine()
            -&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">AcmeDemoBundle:Pays</span><span class="delimiter">'</span></span>)
            -&gt;findOneByName(<span class="string"><span class="delimiter">'</span><span class="content">France</span><span class="delimiter">'</span></span>);

            <span class="local-variable">$laLangue</span> = <span class="local-variable">$this</span>-&gt;getDoctrine()
            -&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">AcmeDemoBundle:Langue</span><span class="delimiter">'</span></span>)
            -&gt;findOneByName(<span class="string"><span class="delimiter">'</span><span class="content">Danish</span><span class="delimiter">'</span></span>);


            <span class="keyword">if</span> (!<span class="local-variable">$lePays</span> || !<span class="local-variable">$laLangue</span>)
                    <span class="keyword">throw</span> <span class="local-variable">$this</span>-&gt;createNotFoundException(
                                    <span class="string"><span class="delimiter">'</span><span class="content">Pb de récupération d</span><span class="char">\'</span><span class="content">instance</span><span class="delimiter">'</span></span>
                    );

     <span class="comment">// création de l'instance de la classe association</span>
            <span class="local-variable">$pl</span> = <span class="keyword">new</span> <span class="constant">PaysLangue</span>();
            <span class="local-variable">$pl</span>-&gt;setLangue(<span class="local-variable">$laLangue</span>);
            <span class="local-variable">$pl</span>-&gt;setPays(<span class="local-variable">$lePays</span>);

     <span class="comment">// puis initialisation de ses attributs portés</span>
            <span class="local-variable">$pl</span>-&gt;setOfficiel(<span class="predefined-constant">false</span>);

     <span class="comment">// et sauvegarder le tout</span>
            <span class="local-variable">$em</span> = <span class="local-variable">$this</span>-&gt;getDoctrine()-&gt;getManager();
            <span class="local-variable">$em</span>-&gt;persist(<span class="local-variable">$pl</span>);
            <span class="local-variable">$em</span>-&gt;<span class="predefined">flush</span>();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Exemple d&#8217;opération RETREIVE (observez la différence d&#8217;expression de la clé) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="local-variable">$pl</span> = <span class="local-variable">$this</span>-&gt;getDoctrine()
      -&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">AcmeDemoBundle:PaysLangue</span><span class="delimiter">'</span></span>)
      -&gt;find(<span class="predefined">array</span>(
          <span class="string"><span class="delimiter">&quot;</span><span class="content">pays</span><span class="delimiter">&quot;</span></span>  =&gt; <span class="local-variable">$lePays</span>-&gt;getId(),
          <span class="string"><span class="delimiter">&quot;</span><span class="content">langue</span><span class="delimiter">&quot;</span></span>=&gt; <span class="local-variable">$laLangue</span>-&gt;getId()));</code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;exploitation en consultation (<code>RETREIVE</code>) de données de type <code>ManyToMany</code> amène naturellement à recueillir une collections d&#8217;objets (un ensemble de lignes d&#8217;un point de vue relationnel).</p>
</div>
<div class="paragraph">
<p>Par exemple, nous souhaitons connaître l&#8217;ensemble des langues parlées (enfin référencées) pour un pays donné.</p>
</div>
<div class="paragraph">
<p>Nous pouvons définir une méthode dans <code>PaysRepository</code>. qui retourne les langues en question (des instances de PaysLangue pour avoir les propriétés portées). Voici un exemple de service attendu :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php">        <span class="local-variable">$lesLangues</span> = <span class="local-variable">$this</span>-&gt;getDoctrine()
            -&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">AcmeDemoBundle:Pays</span><span class="delimiter">'</span></span>)
            -&gt;findAllLangues(<span class="local-variable">$lePays</span>-&gt;getId());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Un exemple d&#8217;implémentation de <code>findAllLangues</code> !</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="comment">// on demande aussi de remonter le pays et la langue</span>
<span class="comment">// (à cause du lazy loading)</span>
<span class="keyword">public</span> <span class="keyword">function</span> <span class="function">findAllLangues</span>(<span class="local-variable">$idPays</span>){
   <span class="local-variable">$em</span> = <span class="local-variable">$this</span>-&gt;getEntityManager();
   <span class="local-variable">$q</span> = <span class="local-variable">$em</span>-&gt;createQuery(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT pl, p, lg FROM AcmeDemoBundle:PaysLangue pl </span><span class="delimiter">&quot;</span></span>
           .  <span class="string"><span class="delimiter">&quot;</span><span class="content"> JOIN pl.pays p</span><span class="delimiter">&quot;</span></span>
           .  <span class="string"><span class="delimiter">&quot;</span><span class="content"> JOIN pl.langue lg</span><span class="delimiter">&quot;</span></span>
           .  <span class="string"><span class="delimiter">&quot;</span><span class="content"> WHERE p.id = :idp</span><span class="delimiter">&quot;</span></span>);
   <span class="local-variable">$q</span>-&gt;setParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">idp</span><span class="delimiter">&quot;</span></span>, <span class="local-variable">$idPays</span>);
   <span class="keyword">return</span> <span class="local-variable">$q</span>-&gt;getResult();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dans un contrôleur :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"> <span class="local-variable">$lesLangues</span> = <span class="local-variable">$this</span>-&gt;getDoctrine()
            -&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">AcmeDemoBundle:Pays</span><span class="delimiter">'</span></span>)
            -&gt;findAllLangues(<span class="local-variable">$lePays</span>-&gt;getId());

 <span class="comment">// puis passage des valeurs à la vue</span>
 <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;render(<span class="string"><span class="delimiter">'</span><span class="content">index/index.html.twig</span><span class="delimiter">'</span></span>, <span class="predefined">array</span>(<span class="string"><span class="delimiter">'</span><span class="content">lePays</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$lePays</span>,
                <span class="string"><span class="delimiter">'</span><span class="content">formulaire</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$form</span>-&gt;createView(),
                        <span class="string"><span class="delimiter">'</span><span class="content">lesLangues</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$lesLangues</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dans la vue</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"> <span class="tag">&lt;hr&gt;</span> <span class="tag">&lt;h4&gt;</span>Les principales langues parlées ici<span class="tag">&lt;/h4&gt;</span>
 <span class="tag">&lt;ul&gt;</span>
   {% for lg in lesLangues %}
     <span class="tag">&lt;li&gt;</span> {{ lg.langue.name }} <span class="tag">&lt;/li&gt;</span>
   {% endfor %}
<span class="tag">&lt;/ul&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="alternative-à-la-classe-association"><a class="anchor" href="#alternative-à-la-classe-association"></a>Alternative à la classe association</h4>
<div class="paragraph">
<p>Une alternative à la classe association est de la considérer comme une classe ordinaire (liée à une table ordinaire), avec un id propre, et relayer la contrainte de clé composite à la couche applicative.</p>
</div>
<div class="paragraph">
<p>On peut cependant demander au système de persistance de prendre en compte la contrainte d&#8217;unicité (rôle d&#8217;une table de liaison) en déclarant cette contrainte sur la clé composite candidate (usage de <code>UniqueConstraint</code> ci dessous):</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/classe-association-no.png" alt="classe-association-no"></span></p>
</div>
<div class="paragraph">
<p>Exemple de génération du schéma physique, cible MySQL :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> <span class="string"><span class="delimiter">`</span><span class="content">CountryLanguage</span><span class="delimiter">`</span></span> (
  <span class="string"><span class="delimiter">`</span><span class="content">id</span><span class="delimiter">`</span></span> <span class="predefined-type">int</span>(<span class="integer">11</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="directive">AUTO_INCREMENT</span>,
  <span class="string"><span class="delimiter">`</span><span class="content">IsOfficial</span><span class="delimiter">`</span></span> <span class="predefined-type">tinyint</span>(<span class="integer">1</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
  <span class="string"><span class="delimiter">`</span><span class="content">idCountry</span><span class="delimiter">`</span></span> <span class="predefined-type">int</span>(<span class="integer">11</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
  <span class="string"><span class="delimiter">`</span><span class="content">idLanguage</span><span class="delimiter">`</span></span> <span class="predefined-type">int</span>(<span class="integer">11</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
  <span class="directive">PRIMARY</span> <span class="type">KEY</span> (<span class="string"><span class="delimiter">`</span><span class="content">id</span><span class="delimiter">`</span></span>),
  <span class="directive">UNIQUE</span> <span class="type">KEY</span> <span class="string"><span class="delimiter">`</span><span class="content">review_unique_by_pays_lang</span><span class="delimiter">`</span></span> (<span class="string"><span class="delimiter">`</span><span class="content">idCountry</span><span class="delimiter">`</span></span>,<span class="string"><span class="delimiter">`</span><span class="content">idLanguage</span><span class="delimiter">`</span></span>),
  <span class="type">KEY</span> <span class="string"><span class="delimiter">`</span><span class="content">IDX_186C946D43CAA294</span><span class="delimiter">`</span></span> (<span class="string"><span class="delimiter">`</span><span class="content">idCountry</span><span class="delimiter">`</span></span>),
  <span class="type">KEY</span> <span class="string"><span class="delimiter">`</span><span class="content">IDX_186C946D87785BEE</span><span class="delimiter">`</span></span> (<span class="string"><span class="delimiter">`</span><span class="content">idLanguage</span><span class="delimiter">`</span></span>),
  <span class="type">CONSTRAINT</span> <span class="string"><span class="delimiter">`</span><span class="content">FK_186C946D43CAA294</span><span class="delimiter">`</span></span>
      <span class="directive">FOREIGN</span> <span class="type">KEY</span> (<span class="string"><span class="delimiter">`</span><span class="content">idCountry</span><span class="delimiter">`</span></span>) <span class="keyword">REFERENCES</span> <span class="string"><span class="delimiter">`</span><span class="content">Country</span><span class="delimiter">`</span></span> (<span class="string"><span class="delimiter">`</span><span class="content">id</span><span class="delimiter">`</span></span>),
  <span class="type">CONSTRAINT</span> <span class="string"><span class="delimiter">`</span><span class="content">FK_186C946D87785BEE</span><span class="delimiter">`</span></span>
      <span class="directive">FOREIGN</span> <span class="type">KEY</span> (<span class="string"><span class="delimiter">`</span><span class="content">idLanguage</span><span class="delimiter">`</span></span>) <span class="keyword">REFERENCES</span> <span class="string"><span class="delimiter">`</span><span class="content">Language</span><span class="delimiter">`</span></span> (<span class="string"><span class="delimiter">`</span><span class="content">id</span><span class="delimiter">`</span></span>)
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Autre exemple (<a href="http://doctrine-orm.readthedocs.org/en/latest/reference/annotations-reference.html" class="bare">http://doctrine-orm.readthedocs.org/en/latest/reference/annotations-reference.html</a>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="comment">/**
 * Vote : when a user vote for a question
 *
 * @ORM\Table(name=&quot;vote&quot;,
  uniqueConstraints={@UniqueConstraint(name=&quot;only_one_vote&quot;,
  columns={&quot;id_user&quot;, &quot;id_question&quot;})}),
   indexes={@Index(name=&quot;question_idx&quot;, columns={&quot;id_question&quot;})})
 * @ORM\Entity(repositoryClass=&quot;AppBundle\Entity\VoteRepository&quot;)
 * @UniqueEntity(fields={&quot;user&quot;, &quot;question&quot;},message=&quot;vote.userquestion&quot;)
 */</span>
<span class="keyword">class</span> <span class="class">Vote</span> {

  <span class="comment">/**
   * @var integer
   *
   * @ORM\Column(name=&quot;id&quot;, type=&quot;integer&quot;)
   * @ORM\Id
   * @ORM\GeneratedValue(strategy=&quot;AUTO&quot;)
   */</span>
  <span class="keyword">private</span> <span class="local-variable">$id</span>;

  <span class="comment">/**
   * question
   * @ORM\ManyToOne(targetEntity=&quot;Question&quot;)
   * @ORM\JoinColumn(name=&quot;id_question&quot;, referencedColumnName=&quot;id&quot;)
   */</span>
  <span class="keyword">private</span> <span class="local-variable">$question</span>;

  <span class="comment">/**
   * user
   * @ORM\ManyToOne(targetEntity=&quot;User&quot;)
   * @ORM\JoinColumn(name=&quot;id_user&quot;, referencedColumnName=&quot;id&quot;)
   */</span>
  <span class="keyword">private</span> <span class="local-variable">$user</span>;

  <span class="comment">/**
   * @var int
   *
   * @ORM\Column(name=&quot;value&quot;, type=&quot;integer&quot;)
   */</span>
  <span class="keyword">private</span> <span class="local-variable">$value</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Voici le schéma créé :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> <span class="string"><span class="delimiter">`</span><span class="content">vote</span><span class="delimiter">`</span></span> (
  <span class="string"><span class="delimiter">`</span><span class="content">id</span><span class="delimiter">`</span></span> <span class="predefined-type">int</span>(<span class="integer">11</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="directive">AUTO_INCREMENT</span>,
  <span class="string"><span class="delimiter">`</span><span class="content">id_question</span><span class="delimiter">`</span></span> <span class="predefined-type">int</span>(<span class="integer">11</span>) <span class="directive">DEFAULT</span> <span class="predefined-constant">NULL</span>,
  <span class="string"><span class="delimiter">`</span><span class="content">id_user</span><span class="delimiter">`</span></span> <span class="predefined-type">int</span>(<span class="integer">11</span>) <span class="directive">DEFAULT</span> <span class="predefined-constant">NULL</span>,
  <span class="string"><span class="delimiter">`</span><span class="content">value</span><span class="delimiter">`</span></span> <span class="predefined-type">int</span>(<span class="integer">11</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
  <span class="directive">PRIMARY</span> <span class="type">KEY</span> (<span class="string"><span class="delimiter">`</span><span class="content">id</span><span class="delimiter">`</span></span>),
  <span class="directive">UNIQUE</span> <span class="type">KEY</span> <span class="string"><span class="delimiter">`</span><span class="content">only_one_vote</span><span class="delimiter">`</span></span> (<span class="string"><span class="delimiter">`</span><span class="content">id_user</span><span class="delimiter">`</span></span>,<span class="string"><span class="delimiter">`</span><span class="content">id_question</span><span class="delimiter">`</span></span>),
  <span class="type">KEY</span> <span class="string"><span class="delimiter">`</span><span class="content">IDX_5A108564E62CA5DB</span><span class="delimiter">`</span></span> (<span class="string"><span class="delimiter">`</span><span class="content">id_question</span><span class="delimiter">`</span></span>),

  <span class="type">KEY</span> <span class="string"><span class="delimiter">`</span><span class="content">IDX_5A1085646B3CA4B</span><span class="delimiter">`</span></span> (<span class="string"><span class="delimiter">`</span><span class="content">id_user</span><span class="delimiter">`</span></span>),
  <span class="type">CONSTRAINT</span> <span class="string"><span class="delimiter">`</span><span class="content">FK_5A1085646B3CA4B</span><span class="delimiter">`</span></span> <span class="directive">FOREIGN</span> <span class="type">KEY</span> (<span class="string"><span class="delimiter">`</span><span class="content">id_user</span><span class="delimiter">`</span></span>) <span class="keyword">REFERENCES</span> <span class="string"><span class="delimiter">`</span><span class="content">fos_user</span><span class="delimiter">`</span></span> (<span class="string"><span class="delimiter">`</span><span class="content">id</span><span class="delimiter">`</span></span>),
  <span class="type">CONSTRAINT</span> <span class="string"><span class="delimiter">`</span><span class="content">FK_5A108564E62CA5DB</span><span class="delimiter">`</span></span> <span class="directive">FOREIGN</span> <span class="type">KEY</span> (<span class="string"><span class="delimiter">`</span><span class="content">id_question</span><span class="delimiter">`</span></span>) <span class="keyword">REFERENCES</span> <span class="string"><span class="delimiter">`</span><span class="content">question</span><span class="delimiter">`</span></span> (<span class="string"><span class="delimiter">`</span><span class="content">id</span><span class="delimiter">`</span></span>)
)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="exploitation-du-modèle-métier"><a class="anchor" href="#exploitation-du-modèle-métier"></a>Exploitation du modèle métier</h3>
<div class="sect3">
<h4 id="méthodes-find-requêtes-assistées"><a class="anchor" href="#méthodes-find-requêtes-assistées"></a>Méthodes find* – Requêtes assistées</h4>
<div class="paragraph">
<p>Nous avons utilisé la méthode <strong>find</strong>, et quelques unes de ses variantes.
Cette méthode est définie dans la classe mère des repository : <code>EntityRepository</code>.
En effet, nos classes <code>Repository</code> <strong>héritent</strong> de cette classe technique. Exemple :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="keyword">class</span> <span class="class">PaysRepository</span> <span class="keyword">extends</span> <span class="constant">EntityRepository</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Voici une vue partielle sur l&#8217;API de <code>EntityRepository</code> : <a href="https://github.com/doctrine/doctrine2/blob/master/lib/Doctrine/ORM/EntityRepository.php">extrait API</a>
<span class="image"><img src="images/api-repository.png" alt="api-repository" width="600"></span></p>
</div>
<div class="paragraph">
<p>Voici des exemple de ces méthodes :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="local-variable">$repository</span>=<span class="local-variable">$this</span>-&gt;getDoctrine()-&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">AcmeDemoBundle:Pays</span><span class="delimiter">'</span></span>);

<span class="comment">// récupère tous les pays</span>
<span class="local-variable">$lesPays</span> = <span class="local-variable">$repository</span>-&gt;findAll();

<span class="comment">// récupère tous les pays ayant obtenu l'indépendance en 1960</span>
<span class="local-variable">$lesPays</span> = <span class="local-variable">$repository</span>-&gt;findBy(<span class="predefined">array</span>(<span class="string"><span class="delimiter">'</span><span class="content">indepYear</span><span class="delimiter">'</span></span>=&gt; <span class="integer">1960</span>));

<span class="comment">// récupère tous les pays (premier critère vide = prendre tout)</span>
<span class="comment">// trié sur l'attribut continent (attention, pas la colonne!)</span>
<span class="local-variable">$lesPays</span> = <span class="local-variable">$repository</span>-&gt;findBy(<span class="predefined">array</span>(), <span class="predefined">array</span>(<span class="string"><span class="delimiter">'</span><span class="content">continent</span><span class="delimiter">'</span></span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">ASC</span><span class="delimiter">'</span></span> ));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour des requêtes simples, basées sur des valeurs d&#8217;attributs (point de vue objet) – en référence à des valeurs de colonnes (du point de vue de la table)  –  le développeur a la  possibilité d&#8217;utiliser des méthodes dites <strong>magiques</strong> (<em>magic finders</em>).</p>
</div>
<div class="paragraph">
<p>Ce mécanisme <strong>s&#8217;appuie sur des conventions de nommage</strong> de méthodes
(sous la responsabilité du développeur) et sur la méthode <strong>__call</strong> de la
classe mère <code>Repository</code> qui transforme des appels de « méthodes magiques » en un
appel classique (nommant la bonne colonne). Les méthodes doivent commencer par <strong>findBy</strong> ou <strong>findOneBy</strong>,
on voit ici le traitement de cette convention :</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/method_magic.png" alt="method_magic mecanisme"></span></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<strong>findBy</strong>  retourne un tableau (éventuellement vide)
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<strong>findOneBy</strong>  retourne une référence à un objet (éventuellement null)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ainsi, pour retrouver tous les pays ayant obtenu l&#8217;indépendance en 1960,
nous pouvons simplifier l&#8217;appel comme ceci :</p>
</div>
<div class="paragraph">
<p>Exemple d&#8217;une méthode magique :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="comment">// récupère tous les pays ayant obtenu l'indépendance en 1960</span>
<span class="local-variable">$lesPays</span> = <span class="local-variable">$paysRepository</span>-&gt;findByIndepYear(<span class="integer">1960</span>);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>par du principe que la classe <code>Pays</code> a un attribut privé nommé <code>indepYear</code>, ou plus exactement une méthode nommée <code>getIndepYear</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Exemple d&#8217;une erreur de nommage :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="comment">// récupère tous les pays ayant obtenu l'indépendance en 1960</span>
<span class="local-variable">$lesPays</span> = <span class="local-variable">$paysRepository</span>-&gt;findByAnneeIndep(<span class="integer">1960</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>qui déclenche une erreur !</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/method_magic-error.png" alt="method_magic-error" width="600"></span></p>
</div>
<div class="paragraph">
<p>Ce qui est parfaitement normal, si l&#8217;attribut <code>anneeIndep</code> n&#8217;est pas un attribut de l&#8217;entité <code>Pays</code>.</p>
</div>
<div class="paragraph">
<p>Exemple d&#8217;utilisation de <em>findOneBy</em> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="comment">// récupère un pays par son nom</span>
 <span class="local-variable">$pays</span> = <span class="local-variable">$paysRepository</span>-&gt;findOneByName(<span class="string"><span class="delimiter">'</span><span class="content">Utopie</span><span class="delimiter">'</span></span>);
 <span class="keyword">if</span> (<span class="local-variable">$pays</span>)
  <span class="comment">// on peut toujours rêver...</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="méthodes-createnativequery-requêtes-natives"><a class="anchor" href="#méthodes-createnativequery-requêtes-natives"></a>Méthodes createNativeQuery – Requêtes natives</h4>
<div class="paragraph">
<p>Il peut arriver, et c&#8217;est souvent le cas lorsque l&#8217;on reprend un existant, de vouloir réutiliser des requêtes SQL présentes dans l&#8217;existant (cas de requêtes optimisées,  de requêtes complexes).</p>
</div>
<div class="paragraph">
<p>Pour cela nous utilisons la méthode <em>createNativeQuery</em> qui prend en argument la requête SQL classique et une référence à un objet de type <code>ResultSetMapping</code>. Cette dernière classe aide Doctrine à mapper les colonnes sur les bons attributs d&#8217;une classe result.</p>
</div>
<div class="paragraph">
<p>Exemple : Nous disposons d&#8217;une requête SQL qui nous retourne l&#8217;id et le nom de la langue officiel du pays d&#8217;id=73 :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">mysql&gt; <span class="class">SELECT</span> Language.id, Language.name <span class="keyword">FROM</span> Language,CountryLanguage,Country <span class="keyword">WHERE</span> Country.id = CountryLanguage.idCountry <span class="keyword">AND</span> Language.id = CountryLanguage.idLanguage <span class="keyword">AND</span> idCountry =<span class="integer">73</span> <span class="keyword">AND</span> CountryLanguage.Isofficial =<span class="string"><span class="delimiter">'</span><span class="content">T</span><span class="delimiter">'</span></span>;
+<span class="comment">----+--------+</span>
| id | name   |
+<span class="comment">----+--------+</span>
| <span class="integer">23</span> | French |
+<span class="comment">----+--------+</span>
<span class="integer">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="class">set</span> (<span class="float">0.00</span> sec)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous souhaitons réutiliser telle quelle cette requête
(celle que nous présentons pourrait être réalisée simplement en DQL – TODO à prouver !)</p>
</div>
<div class="paragraph">
<p>Voici une version possible (paramétrée sur l&#8217;id du pays) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="keyword">class</span> <span class="class">PaysLangueRepository</span> <span class="keyword">extends</span> <span class="constant">EntityRepository</span>{

  <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">findLangueOfficielle</span>(<span class="local-variable">$idPays</span>) {
        <span class="local-variable">$rsm</span> = <span class="keyword">new</span> <span class="constant">ResultSetMapping</span>;
        <span class="local-variable">$rsm</span>-&gt;addScalarResult(<span class="string"><span class="delimiter">'</span><span class="content">id</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">id</span><span class="delimiter">'</span></span>);
        <span class="local-variable">$rsm</span>-&gt;addScalarResult(<span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>);
        <span class="local-variable">$query</span> = <span class="local-variable">$this</span>-&gt;getEntityManager()-&gt;createNativeQuery(
              <span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT Language.id,Language.name
          FROM Language,CountryLanguage,Country
          WHERE Country.id = CountryLanguage.idCountry
          AND Language.id = CountryLanguage.idLanguage
          AND idCountry = ?
          AND CountryLanguage.Isofficial ='T'
            ORDER BY CountryLanguage.Percentage DESC</span><span class="delimiter">&quot;</span></span>
            ,<span class="local-variable">$rsm</span>);
        <span class="local-variable">$query</span>-&gt;setParameter(<span class="integer">1</span>, <span class="local-variable">$idPays</span>);
        <span class="local-variable">$langues</span> = <span class="local-variable">$query</span>-&gt;getResult();
        <span class="keyword">return</span> <span class="local-variable">$langues</span>[<span class="integer">0</span>]; <span class="comment">// prend la première langue...</span>
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette façon de faire s&#8217;appuie sur la méthode <em>addScalarResult</em> de l&#8217;objet <code>ResultSetMapping</code>.
La classe instanciée sera de type php objet : <code>stdclass</code></p>
</div>
<div class="paragraph">
<p>API :  addScalarResult</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="constant">Doctrine</span>\<span class="constant">ORM</span>\<span class="constant">Query</span>\<span class="constant">ResultSetMapping</span>::addScalarResult(<span class="predefined-type">string</span> <span class="local-variable">$columnName</span>, <span class="predefined-type">string</span> <span class="local-variable">$alias</span>, <span class="predefined-type">string</span> <span class="local-variable">$type</span>)
        <span class="constant">Adds</span> a scalar result mapping.
<span class="constant">Parameters</span>:
 * <span class="predefined-type">string</span> <span class="local-variable">$columnName</span> <span class="constant">The</span> name of the column in the <span class="constant">SQL</span> result set.
 * <span class="predefined-type">string</span> <span class="local-variable">$alias</span> <span class="constant">The</span> result alias with which the scalar result should
        be placed in the result structure.
 * <span class="predefined-type">string</span> <span class="local-variable">$type</span> <span class="constant">The</span> column type</code></pre>
</div>
</div>
<div class="paragraph">
<p>Une autre façon de faire est de mapper directement sur une entité métier de l&#8217;application :
Voici une version possible qui retournera une instance de <code>Langue</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="keyword">class</span> <span class="class">PaysLangueRepository</span> <span class="keyword">extends</span> <span class="constant">EntityRepository</span>{

  <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">findLangueOfficielle</span>(<span class="local-variable">$idPays</span>) {
        <span class="local-variable">$rsm</span> = <span class="keyword">new</span> <span class="constant">ResultSetMapping</span>;
        <span class="local-variable">$rsm</span>-&gt;addEntityResult(<span class="string"><span class="delimiter">'</span><span class="content">AcmeDemoBundle:Langue</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">lg</span><span class="delimiter">'</span></span>);
        <span class="local-variable">$rsm</span>-&gt;addFieldResult(<span class="string"><span class="delimiter">'</span><span class="content">lg</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">id</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">id</span><span class="delimiter">'</span></span>);
         <span class="local-variable">$rsm</span>-&gt;addFieldResult(<span class="string"><span class="delimiter">'</span><span class="content">lg</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>);
        <span class="local-variable">$query</span> = <span class="local-variable">$this</span>-&gt;getEntityManager()-&gt;createNativeQuery(
              <span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT Language.id,Language.name
          FROM Language,CountryLanguage,Country
          WHERE Country.id = CountryLanguage.idCountry
          AND Language.id = CountryLanguage.idLanguage
          AND idCountry = ?
          AND CountryLanguage.Isofficial ='T'
            ORDER BY CountryLanguage.Percentage DESC</span><span class="delimiter">&quot;</span></span>
            ,<span class="local-variable">$rsm</span>);
        <span class="local-variable">$query</span>-&gt;setParameter(<span class="integer">1</span>, <span class="local-variable">$idPays</span>);
        <span class="local-variable">$langues</span> = <span class="local-variable">$query</span>-&gt;getResult();
        <span class="keyword">return</span> <span class="local-variable">$langues</span>[<span class="integer">0</span>]; <span class="comment">// prend la première langue...</span>
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>API :  addFieldResult</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="constant">Doctrine</span>\<span class="constant">ORM</span>\<span class="constant">Query</span>\<span class="constant">ResultSetMapping</span>::addFieldResult(<span class="predefined-type">string</span> <span class="local-variable">$alias</span>, <span class="predefined-type">string</span> <span class="local-variable">$columnName</span>, <span class="predefined-type">string</span> <span class="local-variable">$fieldName</span>, <span class="predefined-type">string</span> <span class="local-variable">$declaringClass</span>)
<span class="constant">Adds</span> a field to the result that belongs to an entity <span class="keyword">or</span> joined entity.
<span class="constant">Parameters</span>:
* <span class="predefined-type">string</span> <span class="local-variable">$alias</span> <span class="constant">The</span> alias of the root entity <span class="keyword">or</span> joined entity to which the field belongs.
* <span class="predefined-type">string</span> <span class="local-variable">$columnName</span> <span class="constant">The</span> name of the column in the <span class="constant">SQL</span> result set.
* <span class="predefined-type">string</span> <span class="local-variable">$fieldName</span> <span class="constant">The</span> name of the field on the declaring <span class="keyword">class</span>.</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cas-du-formulaire"><a class="anchor" href="#cas-du-formulaire"></a>Cas du formulaire</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="introduction"><a class="anchor" href="#introduction"></a>Introduction</h3>
<div class="paragraph">
<p>La gestion de formulaires est un des points sensibles en développement web, comme l&#8217;est tout Entrée/Sortie d&#8217;une application.</p>
</div>
<div class="paragraph">
<p>De plus, l&#8217;utilisateur s&#8217;attend à la fois à une certaine ergonomie
(présentation de valeurs en base de données ou précédemment saisies
 par ce dernier) ainsi qu&#8217;au respect de la cohérence (prise en compte de la validité des données côté client et serveur).</p>
</div>
<div class="paragraph">
<p>Symfony intègre un composant nommé <code>form</code> qui prend en charge la gestion de formulaire.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre> composer require form</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce composant a sa propre documentation : <a href="https://symfony.com/doc/current/components/form.html" class="bare">https://symfony.com/doc/current/components/form.html</a></p>
</div>
</div>
<div class="sect2">
<h3 id="logique-de-traitement-du-formulaire"><a class="anchor" href="#logique-de-traitement-du-formulaire"></a>Logique de traitement du formulaire</h3>
<div class="paragraph">
<p>Dans sa version courante, un formulaire est lié à un objet métier (une classe Entity).</p>
</div>
<div class="paragraph">
<p>De plus, il intégère les propriétés importantes suivantes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Gestion des requêtes HTTP : prise en charge du traitement des demandes et des téléchargements de fichiers;</p>
</li>
<li>
<p>Protection CSRF: Prise en charge de la protection contre les attaques CSRF (Cross-Site-Request-Forgery);</p>
</li>
<li>
<p>Templating: Intégration d&#8217;une couche de présentation qui permet de réutiliser des fragments HTML lors du rendu d&#8217;un formulaire;</p>
</li>
<li>
<p>Traduction: Prise en charge de la traduction des messages d&#8217;erreur, des étiquettes de champs et d&#8217;autres chaînes;</p>
</li>
<li>
<p>Validation: Intégration d&#8217;une bibliothèque de validation pour générer des messages d&#8217;erreur pour les données soumises.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="logique-métier-du-formulaire"><a class="anchor" href="#logique-métier-du-formulaire"></a>Logique métier du formulaire</h3>
<div class="paragraph">
<p>Dans cette phase d&#8217;initiation, nous nous concentrerons principalement sur</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la relation Formulaire ↔ Entité</p>
</li>
<li>
<p>les systèmes de validation des attributs côté serveur</p>
</li>
<li>
<p>la création/suppression/mis à jour via Doctrine (aperçus au chapitre précédent)</p>
</li>
<li>
<p>la mise en forme des champs de formulaire</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="méthode-d-action-newxxx"><a class="anchor" href="#méthode-d-action-newxxx"></a>Méthode d&#8217;action newXXX</h4>
<div class="paragraph">
<p>Nous prendrons le cas de la création d&#8217;une instance d&#8217;une entité.</p>
</div>
<div class="paragraph">
<p>Dans ce cas, l&#8217;algorithme retenu par les concepteurs de Symfony et
celui d&#8217;une seule méthode d&#8217;action (une route) pour, à la fois,</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Présenter le formulaire de création et, dans un second temps,</p>
</li>
<li>
<p>Effectuer le traitement de création  (impacter le système d&#8217;information).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le pattern PRG (<a href="https://fr.wikipedia.org/wiki/Post-Redirect-Get" class="bare">https://fr.wikipedia.org/wiki/Post-Redirect-Get</a>) impose au développeur de fournir un ordre de redirection côté client comme réponse à toute action impactant le système (voir le lien si vous ne savez pas pourquoi).
De ce fait, la logique du formulaire sera basée sur l&#8217;algorithme représenté ci-après.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/algo-form.png" alt="algo form" width="323" height="664">
</div>
</div>
<div class="paragraph">
<p>En guise d&#8217;exemple, voici une méthode d&#8217;action typique.</p>
</div>
<div class="paragraph">
<p>Observez la mise en correspondance des étapes numérotées avec des lettres de l&#8217;algorithme (diagramme ci-dessus) avec les lignes du code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td>
  <td class="code"><pre><span class="keyword">use</span> <span class="constant">Symfony</span>\<span class="constant">Component</span>\<span class="constant">HttpFoundation</span>\<span class="constant">Request</span>;

<span class="keyword">public</span> <span class="keyword">function</span> <span class="function">new</span>(<span class="constant">Request</span> <span class="local-variable">$request</span>)
{
    <span class="comment">// création d'une instance d'entité</span>
    <span class="local-variable">$task</span> = <span class="keyword">new</span> <span class="constant">Task</span>();

    <span class="local-variable">$form</span> = <span class="local-variable">$this</span>-&gt;createFormBuilder(<span class="local-variable">$task</span>)
        -&gt;add(<span class="string"><span class="delimiter">'</span><span class="content">task</span><span class="delimiter">'</span></span>, <span class="constant">TextType</span>::<span class="keyword">class</span>)
        -&gt;add(<span class="string"><span class="delimiter">'</span><span class="content">dueDate</span><span class="delimiter">'</span></span>, <span class="constant">DateType</span>::<span class="keyword">class</span>)
        -&gt;add(<span class="string"><span class="delimiter">'</span><span class="content">save</span><span class="delimiter">'</span></span>, <span class="constant">SubmitType</span>::<span class="keyword">class</span>, <span class="predefined">array</span>(<span class="string"><span class="delimiter">'</span><span class="content">label</span><span class="delimiter">'</span></span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">Create Task</span><span class="delimiter">'</span></span>))
        -&gt;getForm();

    <span class="local-variable">$form</span>-&gt;handleRequest(<span class="local-variable">$request</span>);
    <span class="comment">// l'objet référencé par $task est mis à jour</span>

    <span class="keyword">if</span> (<span class="local-variable">$form</span>-&gt;isSubmitted() &amp;&amp; <span class="local-variable">$form</span>-&gt;isValid()) {
        <span class="comment">// $form-&gt;getData() holds the submitted values</span>

        <span class="local-variable">$task</span> = <span class="local-variable">$form</span>-&gt;getData();

        <span class="comment">// ... réalise quelques actions,</span>
        <span class="comment">//    comme sauvegarder task dans la base de données</span>
        <span class="comment">// $entityManager = $this-&gt;getDoctrine()-&gt;getManager();</span>
        <span class="comment">// $entityManager-&gt;persist($task);</span>
        <span class="comment">// $entityManager-&gt;flush();</span>

        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;redirectToRoute(<span class="string"><span class="delimiter">'</span><span class="content">task_success</span><span class="delimiter">'</span></span>);
    }

    <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;render(<span class="string"><span class="delimiter">'</span><span class="content">default/new.html.twig</span><span class="delimiter">'</span></span>, <span class="predefined">array</span>(
        <span class="string"><span class="delimiter">'</span><span class="content">form</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$form</span>-&gt;createView(),
    ));
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lorsque la page est initialisée dans un navigateur,
le formulaire est simplement créé et présenté (<em>created and rendered</em>).</p>
</div>
<div class="paragraph">
<p>La première fois, la méthode <em>handleRequest()</em> reconnaît  que le formulaire n&#8217;est pas
soumis et ne fait donc rien.</p>
</div>
<div class="paragraph">
<p>La méthode <em>isValid()</em> retourne  false si le formulaire n&#8217;a pas reçu de data.
Une bonne pratique consiste cependant à s&#8217;assurer ques des données sont reçues (<em>isSubmitted()</em>) avant de tester leur validité !</p>
</div>
<div class="paragraph">
<p>Lorsque l&#8217;utilisateur soumet la requête avec des données, la méthode <em>handleRequest()</em>  transmet
ces données à l&#8217;instance de l&#8217;entité détenue par form.
Ensuite, si les données ne sont pas valides, alors elles sont de nouveau représentées
à l&#8217;utilisateur avec les erreurs. Sinon, la méthode isValid rend true, et le
développeur peut affiner un peu plus la situation avant de réaliser l&#8217;action cible
(ligne 20-21).</p>
</div>
<div class="paragraph">
<p>Afin d&#8217;éviter de devoir recoder la logique de createFormBuilder,
vous pouvez définir des Form/Type (une classe par entité -voir doc symfony)</p>
</div>
<div class="paragraph">
<p>Voici un autre exemple :</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/form-quizbe.png" alt="form-quizbe"></span></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
La création du l&#8217;objet Form (via createFormBuilder) est sous-traitée à une méthode privée de la classe (createCreateForm).
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="rendu-du-formulaire"><a class="anchor" href="#rendu-du-formulaire"></a>Rendu du formulaire</h3>
<div class="paragraph">
<p>Exemple de rendu d&#8217;un formulaire associé à une entité Pays(Nom, AnnéeIndépendance)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">[...]

{% block content %}

{{ form(formulaire) }}  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>

{% endblock %}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>form() est une fonction qui traduit les structures internes php en une représentation HTML</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>'formulaire' dénote la variable passé par le controleur.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ce qui donne : <span class="image"><img src="images/form-pays-1.png" alt="form-pays-1"></span></p>
</div>
<div class="paragraph">
<p>Bien entendu, Symfony vous permet de prendre la main finement sur la présentation du formulaire.</p>
</div>
<div class="paragraph">
<p>Par exemple, en suivant les instructions d&#8217;usage de Bootstrap Twitter (<a href="http://getbootstrap.com/css/#forms" class="bare">http://getbootstrap.com/css/#forms</a>), nous appliquons de nouvelles classes CSS à nos éléments de formulaire (label, zone de message d&#8217;erreur, input) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">{% block content %}

{% set form = formulaire %}

{{ form_start(form,
   {'attr': {'role': 'form'}}
   ) }}
  {{ form_errors(form) }}

    <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-group</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        {{ form_label(form.name) }}
        {{ form_errors(form.name) }}
        {{ form_widget(form.name,
           {'attr': {'class': 'form-control'}}
        )}}
    <span class="tag">&lt;/div&gt;</span>

    <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-group</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        {{ form_label(form.indepYear) }}
        {{ form_errors(form.indepYear) }}
        {{ form_widget(form.indepYear,
          {'attr': {'class': 'form-control'}}
        )}}
    <span class="tag">&lt;/div&gt;</span>

    <span class="tag">&lt;button</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">submit</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">btn btn-default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
       Enregistrer
    <span class="tag">&lt;/button&gt;</span>

{{ form_end(form) }}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce qui donne.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/form-pays-2.png" alt="form-pays-2"></span></p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0<br>
Last updated 2018-03-18 22:53:13 CET
</div>
</div>
</body>
</html>